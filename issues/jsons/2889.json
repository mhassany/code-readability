{
    "url": "https://api.github.com/repos/pallets/flask/issues/2889",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/2889/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/2889/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/2889/events",
    "html_url": "https://github.com/pallets/flask/pull/2889",
    "id": 352172803,
    "node_id": "MDExOlB1bGxSZXF1ZXN0MjA5NTQ4Nzcw",
    "number": 2889,
    "title": "Improve the recommended way to use Celery",
    "user": {
        "login": "ArtemGordinsky",
        "id": 1506254,
        "node_id": "MDQ6VXNlcjE1MDYyNTQ=",
        "avatar_url": "https://avatars2.githubusercontent.com/u/1506254?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ArtemGordinsky",
        "html_url": "https://github.com/ArtemGordinsky",
        "followers_url": "https://api.github.com/users/ArtemGordinsky/followers",
        "following_url": "https://api.github.com/users/ArtemGordinsky/following{/other_user}",
        "gists_url": "https://api.github.com/users/ArtemGordinsky/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/ArtemGordinsky/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ArtemGordinsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ArtemGordinsky/orgs",
        "repos_url": "https://api.github.com/users/ArtemGordinsky/repos",
        "events_url": "https://api.github.com/users/ArtemGordinsky/events{/privacy}",
        "received_events_url": "https://api.github.com/users/ArtemGordinsky/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2018-08-20T14:56:21Z",
    "updated_at": "2018-08-25T04:42:22Z",
    "closed_at": "2018-08-25T04:42:22Z",
    "author_association": "NONE",
    "pull_request": {
        "url": "https://api.github.com/repos/pallets/flask/pulls/2889",
        "html_url": "https://github.com/pallets/flask/pull/2889",
        "diff_url": "https://github.com/pallets/flask/pull/2889.diff",
        "patch_url": "https://github.com/pallets/flask/pull/2889.patch"
    },
    "body": "Currently [docs](http://flask.pocoo.org/docs/1.0/patterns/celery/) are recommending to call `run()` method after creating a Flask context. It seems that calling `super().__call__()` instead would be a better approach, because calling run() directly skips Celery's internal threading stack management:\r\n\r\nhttps://github.com/celery/celery/blob/master/celery/app/task.py#L382\r\n```python\r\n    def __call__(self, *args, **kwargs):\r\n        _task_stack.push(self)\r\n        self.push_request(args=args, kwargs=kwargs)\r\n        try:\r\n            return self.run(*args, **kwargs)\r\n        finally:\r\n            self.pop_request()\r\n            _task_stack.pop()\r\n```\r\n\r\nI've applied this change in our project and can confirm that it still works without any issues.",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/414350336",
            "html_url": "https://github.com/pallets/flask/pull/2889#issuecomment-414350336",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2889",
            "id": 414350336,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQxNDM1MDMzNg==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-08-20T15:07:13Z",
            "updated_at": "2018-08-20T15:07:13Z",
            "author_association": "MEMBER",
            "body": "We already went through this in reverse in #2055. After extensive testing and digging through the code, I came to the conclusion that what is currently shown is correct. You'll need an authoritative reason that using `__call__` instead of `run` is actually correct in order for me to change this again. I'm not willing to investigate this myself again."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/414351061",
            "html_url": "https://github.com/pallets/flask/pull/2889#issuecomment-414351061",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2889",
            "id": 414351061,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQxNDM1MTA2MQ==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-08-20T15:08:59Z",
            "updated_at": "2018-08-20T15:08:59Z",
            "author_association": "MEMBER",
            "body": "While the Celery code you've linked *appears* to indicate that your change is correct, from what I remember there's actually code in a seemingly unrelated area that monkeypatches it in other situations, and that messes up things with your change."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/415935825",
            "html_url": "https://github.com/pallets/flask/pull/2889#issuecomment-415935825",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2889",
            "id": 415935825,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQxNTkzNTgyNQ==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-08-25T04:42:22Z",
            "updated_at": "2018-08-25T04:42:22Z",
            "author_association": "MEMBER",
            "body": "Closing this for now. I think my previous conclusion is still valid. If you get a definitive answer, comment here and we can revisit it."
        }
    ]
}
{
    "url": "https://api.github.com/repos/pallets/flask/issues/3396",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/3396/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/3396/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/3396/events",
    "html_url": "https://github.com/pallets/flask/issues/3396",
    "id": 506904569,
    "node_id": "MDU6SXNzdWU1MDY5MDQ1Njk=",
    "number": 3396,
    "title": "Unable to extend FlaskClient with follow_redirects",
    "user": {
        "login": "MaicoTimmerman",
        "id": 904824,
        "node_id": "MDQ6VXNlcjkwNDgyNA==",
        "avatar_url": "https://avatars3.githubusercontent.com/u/904824?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MaicoTimmerman",
        "html_url": "https://github.com/MaicoTimmerman",
        "followers_url": "https://api.github.com/users/MaicoTimmerman/followers",
        "following_url": "https://api.github.com/users/MaicoTimmerman/following{/other_user}",
        "gists_url": "https://api.github.com/users/MaicoTimmerman/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/MaicoTimmerman/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/MaicoTimmerman/subscriptions",
        "organizations_url": "https://api.github.com/users/MaicoTimmerman/orgs",
        "repos_url": "https://api.github.com/users/MaicoTimmerman/repos",
        "events_url": "https://api.github.com/users/MaicoTimmerman/events{/privacy}",
        "received_events_url": "https://api.github.com/users/MaicoTimmerman/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "open",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2019-10-14T22:27:40Z",
    "updated_at": "2019-10-17T03:06:26Z",
    "closed_at": null,
    "author_association": "NONE",
    "body": "I'm trying to add default headers to the Flask testing client, however when the response contains redirects, the second request seems to have issues due the FlaskClient inconsistent method signatures of flask.testing.FlaskClient.open() and werkzeug.Client.open().\r\nIs there a workaround to this problem?\r\n### Expected Behavior\r\nThe requests both have a header attached.\r\n\r\n```python\r\nfrom flask import Flask, redirect, url_for\r\nfrom flask.testing import FlaskClient\r\n\r\napp = Flask(__name__)\r\n\r\nclass CustomClient(FlaskClient):\r\n    def __init__(self, *args, headers=None, **kwargs):\r\n        if headers is None:\r\n            headers = dict()\r\n        super(CustomClient, self).__init__(*args, **kwargs)\r\n        self.headers = headers\r\n    def open(self, *args, **kwargs):\r\n        kwargs['headers'] = self.headers.copy()\r\n        return super().open(*args, **kwargs)\r\n\r\n@app.route(\"/\", methods=[\"GET\", \"POST\"])\r\ndef home():\r\n    return redirect(url_for(\"test\"))\r\n\r\n@app.route(\"/foo/\")\r\ndef test():\r\n    return \"Hello, World!\"\r\nif __name__ == \"__main__\":\r\n    app.test_client_class = CustomClient\r\n    with app.test_client(headers={\r\n            \"SomeHeader\": \"SomeValue\"\r\n    }) as c:\r\n        rv = c.post(\"/\", follow_redirects=True)\r\n        print(rv.data)\r\n```\r\n\r\n### Actual Behavior\r\n```pytb\r\nTraceback (most recent call last):\r\n  File \"/opt/pycharm-professional/helpers/pydev/pydevd.py\", line 2066, in <module>\r\n    main()\r\n  File \"/opt/pycharm-professional/helpers/pydev/pydevd.py\", line 2060, in main\r\n    globals = debugger.run(setup['file'], None, None, is_module)\r\n  File \"/opt/pycharm-professional/helpers/pydev/pydevd.py\", line 1411, in run\r\n    return self._exec(is_module, entry_point_fn, module_name, file, globals, locals)\r\n  File \"/opt/pycharm-professional/helpers/pydev/pydevd.py\", line 1418, in _exec\r\n    pydev_imports.execfile(file, globals, locals)  # execute the script\r\n  File \"/opt/pycharm-professional/helpers/pydev/_pydev_imps/_pydev_execfile.py\", line 18, in execfile\r\n    exec(compile(contents+\"\\n\", file, 'exec'), glob, loc)\r\n  File \"app.py\", line 35, in <module>\r\n    rv = c.post(\"/\", follow_redirects=True)\r\n  File \"/home/maico/dev/venv/lib/python3.6/site-packages/werkzeug/test.py\", line 1039, in post\r\n    return self.open(*args, **kw)\r\n  File \"app.py\", line 17, in open\r\n    return super().open(*args, **kwargs)\r\n  File \"/home/maico/dev/venv/lib/python3.6/site-packages/flask/testing.py\", line 227, in open\r\n    follow_redirects=follow_redirects,\r\n  File \"/home/maico/dev/venv/lib/python3.6/site-packages/werkzeug/test.py\", line 1017, in open\r\n    response, new_location, environ, buffered=buffered\r\n  File \"/home/maico/dev/venv/lib/python3.6/site-packages/werkzeug/test.py\", line 948, in resolve_redirect\r\n    return self.open(builder, as_tuple=True, buffered=buffered)\r\n  File \"app.py\", line 17, in open\r\n    return super().open(*args, **kwargs)\r\n  File \"/home/maico/dev/venv/lib/python3.6/site-packages/flask/testing.py\", line 215, in open\r\n    builder = EnvironBuilder(self.application, *args, **kwargs)\r\n  File \"/home/maico/dev/venv/lib/python3.6/site-packages/flask/testing.py\", line 73, in __init__\r\n    url = url_parse(path)\r\n  File \"/home/maico/dev/venv/lib/python3.6/site-packages/werkzeug/urls.py\", line 457, in url_parse\r\n    i = url.find(s(\":\"))\r\nAttributeError: 'EnvironBuilder' object has no attribute 'find'```\r\n```\r\n### Environment\r\n\r\n* Python version: 3.6.9\r\n* Flask version: 1.1.1\r\n* Werkzeug version: 0.16.0\r\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/542610108",
            "html_url": "https://github.com/pallets/flask/issues/3396#issuecomment-542610108",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3396",
            "id": 542610108,
            "node_id": "MDEyOklzc3VlQ29tbWVudDU0MjYxMDEwOA==",
            "user": {
                "login": "liujunwe",
                "id": 26828784,
                "node_id": "MDQ6VXNlcjI2ODI4Nzg0",
                "avatar_url": "https://avatars0.githubusercontent.com/u/26828784?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/liujunwe",
                "html_url": "https://github.com/liujunwe",
                "followers_url": "https://api.github.com/users/liujunwe/followers",
                "following_url": "https://api.github.com/users/liujunwe/following{/other_user}",
                "gists_url": "https://api.github.com/users/liujunwe/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/liujunwe/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/liujunwe/subscriptions",
                "organizations_url": "https://api.github.com/users/liujunwe/orgs",
                "repos_url": "https://api.github.com/users/liujunwe/repos",
                "events_url": "https://api.github.com/users/liujunwe/events{/privacy}",
                "received_events_url": "https://api.github.com/users/liujunwe/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-10-16T09:19:45Z",
            "updated_at": "2019-10-16T09:20:03Z",
            "author_association": "NONE",
            "body": "### I repeated your code and didn't find your problem, but the test_client incoming header didn't show up in the Request Headrs after accessing the URL via the browser.\r\n===========\r\n**Environment** \r\n\r\nPython version: 3.7.3\r\nFlask version: 1.1.1\r\nWerkzeug version: 0.16.0"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/542904587",
            "html_url": "https://github.com/pallets/flask/issues/3396#issuecomment-542904587",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3396",
            "id": 542904587,
            "node_id": "MDEyOklzc3VlQ29tbWVudDU0MjkwNDU4Nw==",
            "user": {
                "login": "MaicoTimmerman",
                "id": 904824,
                "node_id": "MDQ6VXNlcjkwNDgyNA==",
                "avatar_url": "https://avatars3.githubusercontent.com/u/904824?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/MaicoTimmerman",
                "html_url": "https://github.com/MaicoTimmerman",
                "followers_url": "https://api.github.com/users/MaicoTimmerman/followers",
                "following_url": "https://api.github.com/users/MaicoTimmerman/following{/other_user}",
                "gists_url": "https://api.github.com/users/MaicoTimmerman/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/MaicoTimmerman/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/MaicoTimmerman/subscriptions",
                "organizations_url": "https://api.github.com/users/MaicoTimmerman/orgs",
                "repos_url": "https://api.github.com/users/MaicoTimmerman/repos",
                "events_url": "https://api.github.com/users/MaicoTimmerman/events{/privacy}",
                "received_events_url": "https://api.github.com/users/MaicoTimmerman/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-10-16T21:44:43Z",
            "updated_at": "2019-10-16T21:44:43Z",
            "author_association": "NONE",
            "body": "I'm not sure what you mean with accessing the URL via the browser. The script never serves the app, it directly calls the view functions. For completeness I've also ran the set-up in python 3.7.4, which resulted in exactly the same traceback (this trace is outside pycharm):\r\n\r\n```pytb\r\nTraceback (most recent call last):\r\n  File \"test.py\", line 28, in <module>\r\n    rv = c.post(\"/\", follow_redirects=True)\r\n  File \"/home/maico/dev/venv/lib/python3.7/site-packages/werkzeug/test.py\", line 1039, in post\r\n    return self.open(*args, **kw)\r\n  File \"test.py\", line 14, in open\r\n    return super().open(*args, **kwargs)\r\n  File \"/home/maico/dev/venv/lib/python3.7/site-packages/flask/testing.py\", line 227, in open\r\n    follow_redirects=follow_redirects,\r\n  File \"/home/maico/dev/venv/lib/python3.7/site-packages/werkzeug/test.py\", line 1017, in open\r\n    response, new_location, environ, buffered=buffered\r\n  File \"/home/maico/dev/venv/lib/python3.7/site-packages/werkzeug/test.py\", line 948, in resolve_redirect\r\n    return self.open(builder, as_tuple=True, buffered=buffered)\r\n  File \"test.py\", line 14, in open\r\n    return super().open(*args, **kwargs)\r\n  File \"/home/maico/dev/venv/lib/python3.7/site-packages/flask/testing.py\", line 215, in open\r\n    builder = EnvironBuilder(self.application, *args, **kwargs)\r\n  File \"/home/maico/dev/venv/lib/python3.7/site-packages/flask/testing.py\", line 73, in __init__\r\n    url = url_parse(path)\r\n  File \"/home/maico/dev/venv/lib/python3.7/site-packages/werkzeug/urls.py\", line 457, in url_parse\r\n    i = url.find(s(\":\"))\r\nAttributeError: 'EnvironBuilder' object has no attribute 'find'\r\n```"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/542977475",
            "html_url": "https://github.com/pallets/flask/issues/3396#issuecomment-542977475",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3396",
            "id": 542977475,
            "node_id": "MDEyOklzc3VlQ29tbWVudDU0Mjk3NzQ3NQ==",
            "user": {
                "login": "liujunwe",
                "id": 26828784,
                "node_id": "MDQ6VXNlcjI2ODI4Nzg0",
                "avatar_url": "https://avatars0.githubusercontent.com/u/26828784?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/liujunwe",
                "html_url": "https://github.com/liujunwe",
                "followers_url": "https://api.github.com/users/liujunwe/followers",
                "following_url": "https://api.github.com/users/liujunwe/following{/other_user}",
                "gists_url": "https://api.github.com/users/liujunwe/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/liujunwe/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/liujunwe/subscriptions",
                "organizations_url": "https://api.github.com/users/liujunwe/orgs",
                "repos_url": "https://api.github.com/users/liujunwe/repos",
                "events_url": "https://api.github.com/users/liujunwe/events{/privacy}",
                "received_events_url": "https://api.github.com/users/liujunwe/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-10-17T03:06:26Z",
            "updated_at": "2019-10-17T03:06:26Z",
            "author_association": "NONE",
            "body": "` from your trace, the type of the url is wrong. The url should not be the EnvironBuilder object. it should be str object , I'm not understand you project very well , may you need to debug the url type question`"
        }
    ]
}
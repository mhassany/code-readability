{
    "url": "https://api.github.com/repos/pallets/flask/issues/2460",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/2460/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/2460/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/2460/events",
    "html_url": "https://github.com/pallets/flask/issues/2460",
    "id": 254822736,
    "node_id": "MDU6SXNzdWUyNTQ4MjI3MzY=",
    "number": 2460,
    "title": "Apps importing grequests crash when a restart/reload is attempted",
    "user": {
        "login": "bpaterni",
        "id": 9027071,
        "node_id": "MDQ6VXNlcjkwMjcwNzE=",
        "avatar_url": "https://avatars1.githubusercontent.com/u/9027071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bpaterni",
        "html_url": "https://github.com/bpaterni",
        "followers_url": "https://api.github.com/users/bpaterni/followers",
        "following_url": "https://api.github.com/users/bpaterni/following{/other_user}",
        "gists_url": "https://api.github.com/users/bpaterni/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/bpaterni/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/bpaterni/subscriptions",
        "organizations_url": "https://api.github.com/users/bpaterni/orgs",
        "repos_url": "https://api.github.com/users/bpaterni/repos",
        "events_url": "https://api.github.com/users/bpaterni/events{/privacy}",
        "received_events_url": "https://api.github.com/users/bpaterni/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 5,
    "created_at": "2017-09-02T16:48:32Z",
    "updated_at": "2018-01-29T15:36:35Z",
    "closed_at": "2018-01-29T15:36:35Z",
    "author_association": "NONE",
    "body": "### Expected Behavior\r\n\r\nFlask apps run in debug mode (importing grequests) should reload when filesystem changes are detected.\r\n\r\n### Actual Behavior\r\n\r\nInstead, the following app crashes as changes are introduced and an app reload is attempted. Oddly enough, if the app is started with grequests commented out, and then uncommented, reloads process successfully.\r\n\r\n```python\r\nimport flask              \r\n\r\nimport grequests          \r\nimport sys                \r\n\r\napp = flask.Flask(__name__)                          \r\napp.debug = True          \r\n\r\n@app.route('/syspath')    \r\ndef syspath():            \r\n    return '\\n'.join(sys.path) + '\\n'       \r\n```\r\n\r\n```\r\n$ FLASK_APP=demo.py FLASK_DEBUG=1 flask run --host=0.0.0.0\r\n * Serving Flask app \"demo\"                          \r\n * Forcing debug mode on                             \r\n * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)                                                 \r\n * Restarting with stat                              \r\n * Debugger is active!                               \r\n * Debugger PIN: 313-109-065                         \r\n * Detected change in '/home/bpaterni/usr/local/src/python/flask-app-restart-demo/demo.py', reloading     \r\n * Restarting with stat                              \r\nTraceback (most recent call last):                   \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/bin/flask\", line 11, in <module>                \r\n    sys.exit(main())                                 \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/flask/cli.py\", line 513, in main                                                                                              \r\n    cli.main(args=args, prog_name=name)              \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/flask/cli.py\", line 380, in main                                                                                              \r\n    return AppGroup.main(self, *args, **kwargs)      \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/click/core.py\", line 697, in main                                                                                             \r\n    rv = self.invoke(ctx)                            \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/click/core.py\", line 1066, in invoke                                                                                          \r\n    return _process_result(sub_ctx.command.invoke(sub_ctx))                                               \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/click/core.py\", line 895, in invoke                                                                                           \r\n    return ctx.invoke(self.callback, **ctx.params)   \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/click/core.py\", line 535, in invoke                                                                                           \r\n    return callback(*args, **kwargs)                 \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/click/decorators.py\", line 64, in new_func                                                                                    \r\n    return ctx.invoke(f, obj, *args[1:], **kwargs)   \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/click/core.py\", line 535, in invoke                                                                                           \r\n    return callback(*args, **kwargs)                 \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/flask/cli.py\", line 438, in run_command                                                                                       \r\n    use_debugger=debugger, threaded=with_threads)    \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/werkzeug/serving.py\", line 737, in run_simple                                                                                 \r\n    reloader_type)                                   \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/werkzeug/_reloader.py\", line 265, in run_with_reloader                                                                        \r\n    sys.exit(reloader.restart_with_reloader())       \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/werkzeug/_reloader.py\", line 124, in restart_with_reloader                                                                    \r\n    close_fds=False)                                 \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/gevent/subprocess.py\", line 234, in call                                                                                      \r\n    with Popen(*popenargs, **kwargs) as p:           \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/gevent/subprocess.py\", line 554, in __init__                                                                                  \r\n    restore_signals, start_new_session)              \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/gevent/subprocess.py\", line 1160, in _execute_child                                                                           \r\n    self.pid = fork_and_watch(self._on_child, self._loop, True, fork)                                     \r\n  File \"/home/bpaterni/usr/local/src/python/venvs/venv-01/lib/python3.5/site-packages/gevent/os.py\", line 375, in fork_and_watch                                                                                    \r\n    watcher = loop.child(pid, ref=ref)               \r\n  File \"gevent.libev.corecext.pyx\", line 518, in gevent.libev.corecext.loop.child (src/gevent/libev/gevent.corecext.c:7601)                                                                                         \r\n  File \"gevent.libev.corecext.pyx\", line 1886, in gevent.libev.corecext.child.__init__ (src/gevent/libev/gevent.corecext.c:21676)                                                                                   \r\nTypeError: child watchers are only available on the default loop\r\n```\r\n\r\n### Environment\r\n\r\n* Python version: 3.5.4\r\n* Flask version: 0.12.2\r\n* Werkzeug version: 0.12.2\r\n* grequests: 0.3.0\r\n* gevent version: 1.2.2\r\n* Click version: 6.7",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/326764328",
            "html_url": "https://github.com/pallets/flask/issues/2460#issuecomment-326764328",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2460",
            "id": 326764328,
            "node_id": "MDEyOklzc3VlQ29tbWVudDMyNjc2NDMyOA==",
            "user": {
                "login": "RonnyPfannschmidt",
                "id": 156838,
                "node_id": "MDQ6VXNlcjE1NjgzOA==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/156838?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/RonnyPfannschmidt",
                "html_url": "https://github.com/RonnyPfannschmidt",
                "followers_url": "https://api.github.com/users/RonnyPfannschmidt/followers",
                "following_url": "https://api.github.com/users/RonnyPfannschmidt/following{/other_user}",
                "gists_url": "https://api.github.com/users/RonnyPfannschmidt/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/RonnyPfannschmidt/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/RonnyPfannschmidt/subscriptions",
                "organizations_url": "https://api.github.com/users/RonnyPfannschmidt/orgs",
                "repos_url": "https://api.github.com/users/RonnyPfannschmidt/repos",
                "events_url": "https://api.github.com/users/RonnyPfannschmidt/events{/privacy}",
                "received_events_url": "https://api.github.com/users/RonnyPfannschmidt/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2017-09-02T19:19:01Z",
            "updated_at": "2017-09-02T19:19:01Z",
            "author_association": "CONTRIBUTOR",
            "body": "grequests monkeypatches around all kinds of system modules in python,\r\n\r\nas you can see the exception happens because werkzeug uses the working os module of python itself and in the traceback there is the \"broken\" one from gevent\r\n\r\nim wondering if importing grequests before flask and werkzeug can elevate the issue (as then the monkeypatches would happen before werkzeug imports the modules\r\n\r\nplease try and report back"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/326765352",
            "html_url": "https://github.com/pallets/flask/issues/2460#issuecomment-326765352",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2460",
            "id": 326765352,
            "node_id": "MDEyOklzc3VlQ29tbWVudDMyNjc2NTM1Mg==",
            "user": {
                "login": "bpaterni",
                "id": 9027071,
                "node_id": "MDQ6VXNlcjkwMjcwNzE=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/9027071?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/bpaterni",
                "html_url": "https://github.com/bpaterni",
                "followers_url": "https://api.github.com/users/bpaterni/followers",
                "following_url": "https://api.github.com/users/bpaterni/following{/other_user}",
                "gists_url": "https://api.github.com/users/bpaterni/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/bpaterni/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bpaterni/subscriptions",
                "organizations_url": "https://api.github.com/users/bpaterni/orgs",
                "repos_url": "https://api.github.com/users/bpaterni/repos",
                "events_url": "https://api.github.com/users/bpaterni/events{/privacy}",
                "received_events_url": "https://api.github.com/users/bpaterni/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2017-09-02T19:40:04Z",
            "updated_at": "2017-09-02T19:40:04Z",
            "author_association": "NONE",
            "body": "Rats! Unfortunately, importing grequests before flask did nothing as the same traceback is given on reload.\r\n\r\n```\r\nimport grequests\r\nimport sys\r\n\r\nimport flask\r\n...\r\n```"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/331322916",
            "html_url": "https://github.com/pallets/flask/issues/2460#issuecomment-331322916",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2460",
            "id": 331322916,
            "node_id": "MDEyOklzc3VlQ29tbWVudDMzMTMyMjkxNg==",
            "user": {
                "login": "adamrt",
                "id": 58468,
                "node_id": "MDQ6VXNlcjU4NDY4",
                "avatar_url": "https://avatars3.githubusercontent.com/u/58468?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/adamrt",
                "html_url": "https://github.com/adamrt",
                "followers_url": "https://api.github.com/users/adamrt/followers",
                "following_url": "https://api.github.com/users/adamrt/following{/other_user}",
                "gists_url": "https://api.github.com/users/adamrt/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/adamrt/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/adamrt/subscriptions",
                "organizations_url": "https://api.github.com/users/adamrt/orgs",
                "repos_url": "https://api.github.com/users/adamrt/repos",
                "events_url": "https://api.github.com/users/adamrt/events{/privacy}",
                "received_events_url": "https://api.github.com/users/adamrt/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2017-09-22T01:10:10Z",
            "updated_at": "2017-09-22T01:10:10Z",
            "author_association": "NONE",
            "body": "Downgrade to gevent 1.0.2. Ran across the advice here and it worked. https://medium.com/@kelsey88/typeerror-child-watchers-are-only-available-on-the-default-loop-36775fcbcba6"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/334862549",
            "html_url": "https://github.com/pallets/flask/issues/2460#issuecomment-334862549",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2460",
            "id": 334862549,
            "node_id": "MDEyOklzc3VlQ29tbWVudDMzNDg2MjU0OQ==",
            "user": {
                "login": "bpaterni",
                "id": 9027071,
                "node_id": "MDQ6VXNlcjkwMjcwNzE=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/9027071?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/bpaterni",
                "html_url": "https://github.com/bpaterni",
                "followers_url": "https://api.github.com/users/bpaterni/followers",
                "following_url": "https://api.github.com/users/bpaterni/following{/other_user}",
                "gists_url": "https://api.github.com/users/bpaterni/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/bpaterni/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bpaterni/subscriptions",
                "organizations_url": "https://api.github.com/users/bpaterni/orgs",
                "repos_url": "https://api.github.com/users/bpaterni/repos",
                "events_url": "https://api.github.com/users/bpaterni/events{/privacy}",
                "received_events_url": "https://api.github.com/users/bpaterni/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2017-10-06T20:31:45Z",
            "updated_at": "2017-10-06T20:31:45Z",
            "author_association": "NONE",
            "body": "I'm assuming you're using python2, as gevent 1.0.2 does not seem compatible with my python 3 app? Installing via pip results in SyntaxErrors thrown on gevent's python2-based exception handling. I also tried downloading the gevent souce, but the build step fails due to a file not found error in compilation of `gevent/gevent.core.c`"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/361283824",
            "html_url": "https://github.com/pallets/flask/issues/2460#issuecomment-361283824",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2460",
            "id": 361283824,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM2MTI4MzgyNA==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-01-29T15:36:35Z",
            "updated_at": "2018-01-29T15:36:35Z",
            "author_association": "MEMBER",
            "body": "I can't reproduce this with the example given. Using the latest releases of Flask, Werkzeug, and grequests."
        }
    ]
}
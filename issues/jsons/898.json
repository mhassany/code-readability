{
    "url": "https://api.github.com/repos/pallets/flask/issues/898",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/898/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/898/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/898/events",
    "html_url": "https://github.com/pallets/flask/issues/898",
    "id": 21805715,
    "node_id": "MDU6SXNzdWUyMTgwNTcxNQ==",
    "number": 898,
    "title": "g request context is not per request?",
    "user": {
        "login": "tedostrem",
        "id": 2115256,
        "node_id": "MDQ6VXNlcjIxMTUyNTY=",
        "avatar_url": "https://avatars1.githubusercontent.com/u/2115256?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/tedostrem",
        "html_url": "https://github.com/tedostrem",
        "followers_url": "https://api.github.com/users/tedostrem/followers",
        "following_url": "https://api.github.com/users/tedostrem/following{/other_user}",
        "gists_url": "https://api.github.com/users/tedostrem/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/tedostrem/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/tedostrem/subscriptions",
        "organizations_url": "https://api.github.com/users/tedostrem/orgs",
        "repos_url": "https://api.github.com/users/tedostrem/repos",
        "events_url": "https://api.github.com/users/tedostrem/events{/privacy}",
        "received_events_url": "https://api.github.com/users/tedostrem/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 8,
    "created_at": "2013-10-30T05:13:15Z",
    "updated_at": "2014-02-08T22:22:52Z",
    "closed_at": "2014-02-08T22:22:52Z",
    "author_association": "NONE",
    "body": "Today in our system, one user managed to update the profile of another user.(\nThe only explanation I can come up with to this is that the Flask g context contained\nthe user_id of user_a when user_b updated his profile.\n\nAm I using g incorrectly or is this maybe a bug?\nWe have about 15k users and this is the first time I saw this happen.\n\nFlask==0.10.1\n\n```\n@app.before_request\ndef before_request():\n    g.user_token = UserToken.from_request_token(\n        request.headers.get('Authorization')\n        .replace('Token token=\"', '').replace('\"', ''))\n\n@app.route('/api/profile',  methods=['GET', 'PUT'])\ndef profile():\n    if request.method == 'PUT':\n        try:\n            user_service.update_userprofile(\n                UserProfile(\n                    g.user_token.user_id,\n                    request.json.get('name'),\n                    request.json.get('gender'),\n                    request.json.get('location')\n                    None))\n            return PostResultModel(PostResult.Success,\n                                   'Userprofile updated',\n                                   PostResultErrorCode.NoError).json()\n        except:\n            return PostResultModel(PostResult.Error,\n                                   'Could not update profile',\n                                   PostResultErrorCode.ServerError).json()\n```\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/27370510",
            "html_url": "https://github.com/pallets/flask/issues/898#issuecomment-27370510",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/898",
            "id": 27370510,
            "node_id": "MDEyOklzc3VlQ29tbWVudDI3MzcwNTEw",
            "user": {
                "login": "untitaker",
                "id": 837573,
                "node_id": "MDQ6VXNlcjgzNzU3Mw==",
                "avatar_url": "https://avatars0.githubusercontent.com/u/837573?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/untitaker",
                "html_url": "https://github.com/untitaker",
                "followers_url": "https://api.github.com/users/untitaker/followers",
                "following_url": "https://api.github.com/users/untitaker/following{/other_user}",
                "gists_url": "https://api.github.com/users/untitaker/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/untitaker/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/untitaker/subscriptions",
                "organizations_url": "https://api.github.com/users/untitaker/orgs",
                "repos_url": "https://api.github.com/users/untitaker/repos",
                "events_url": "https://api.github.com/users/untitaker/events{/privacy}",
                "received_events_url": "https://api.github.com/users/untitaker/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2013-10-30T07:50:31Z",
            "updated_at": "2013-10-30T07:50:31Z",
            "author_association": "MEMBER",
            "body": "```\n(@app.route\n```\n\nthat parens looks misplaced\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/27370638",
            "html_url": "https://github.com/pallets/flask/issues/898#issuecomment-27370638",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/898",
            "id": 27370638,
            "node_id": "MDEyOklzc3VlQ29tbWVudDI3MzcwNjM4",
            "user": {
                "login": "pengfei-xue",
                "id": 1533151,
                "node_id": "MDQ6VXNlcjE1MzMxNTE=",
                "avatar_url": "https://avatars2.githubusercontent.com/u/1533151?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/pengfei-xue",
                "html_url": "https://github.com/pengfei-xue",
                "followers_url": "https://api.github.com/users/pengfei-xue/followers",
                "following_url": "https://api.github.com/users/pengfei-xue/following{/other_user}",
                "gists_url": "https://api.github.com/users/pengfei-xue/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/pengfei-xue/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/pengfei-xue/subscriptions",
                "organizations_url": "https://api.github.com/users/pengfei-xue/orgs",
                "repos_url": "https://api.github.com/users/pengfei-xue/repos",
                "events_url": "https://api.github.com/users/pengfei-xue/events{/privacy}",
                "received_events_url": "https://api.github.com/users/pengfei-xue/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2013-10-30T07:53:56Z",
            "updated_at": "2013-10-30T07:53:56Z",
            "author_association": "CONTRIBUTOR",
            "body": "the usage is correctly, and I think the flask.g is per request, so it wont messed up among requests.\n\nI think you should double-check your application, you can print user_token before updating user's profile.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/27374645",
            "html_url": "https://github.com/pallets/flask/issues/898#issuecomment-27374645",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/898",
            "id": 27374645,
            "node_id": "MDEyOklzc3VlQ29tbWVudDI3Mzc0NjQ1",
            "user": {
                "login": "tedostrem",
                "id": 2115256,
                "node_id": "MDQ6VXNlcjIxMTUyNTY=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/2115256?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/tedostrem",
                "html_url": "https://github.com/tedostrem",
                "followers_url": "https://api.github.com/users/tedostrem/followers",
                "following_url": "https://api.github.com/users/tedostrem/following{/other_user}",
                "gists_url": "https://api.github.com/users/tedostrem/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/tedostrem/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/tedostrem/subscriptions",
                "organizations_url": "https://api.github.com/users/tedostrem/orgs",
                "repos_url": "https://api.github.com/users/tedostrem/repos",
                "events_url": "https://api.github.com/users/tedostrem/events{/privacy}",
                "received_events_url": "https://api.github.com/users/tedostrem/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2013-10-30T09:21:17Z",
            "updated_at": "2013-10-30T09:21:17Z",
            "author_association": "NONE",
            "body": "unittaker: sorry that was a typo. (edited)\n\npengfei-xue: In normal cases it works fine, It just happened on 2 users today.\nOne user suddenly updated his profile with another users information.\n\nIm also using SSL\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/27379988",
            "html_url": "https://github.com/pallets/flask/issues/898#issuecomment-27379988",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/898",
            "id": 27379988,
            "node_id": "MDEyOklzc3VlQ29tbWVudDI3Mzc5OTg4",
            "user": {
                "login": "pengfei-xue",
                "id": 1533151,
                "node_id": "MDQ6VXNlcjE1MzMxNTE=",
                "avatar_url": "https://avatars2.githubusercontent.com/u/1533151?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/pengfei-xue",
                "html_url": "https://github.com/pengfei-xue",
                "followers_url": "https://api.github.com/users/pengfei-xue/followers",
                "following_url": "https://api.github.com/users/pengfei-xue/following{/other_user}",
                "gists_url": "https://api.github.com/users/pengfei-xue/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/pengfei-xue/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/pengfei-xue/subscriptions",
                "organizations_url": "https://api.github.com/users/pengfei-xue/orgs",
                "repos_url": "https://api.github.com/users/pengfei-xue/repos",
                "events_url": "https://api.github.com/users/pengfei-xue/events{/privacy}",
                "received_events_url": "https://api.github.com/users/pengfei-xue/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2013-10-30T10:58:26Z",
            "updated_at": "2013-10-30T10:58:26Z",
            "author_association": "CONTRIBUTOR",
            "body": "I check the related code, the flask.g will be teared down for after every request,  so i think it's impossible to be messed up among requests.\n\nYou should do more tests to see if you can reproduce it, and do check the logs you got.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/27380304",
            "html_url": "https://github.com/pallets/flask/issues/898#issuecomment-27380304",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/898",
            "id": 27380304,
            "node_id": "MDEyOklzc3VlQ29tbWVudDI3MzgwMzA0",
            "user": {
                "login": "tedostrem",
                "id": 2115256,
                "node_id": "MDQ6VXNlcjIxMTUyNTY=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/2115256?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/tedostrem",
                "html_url": "https://github.com/tedostrem",
                "followers_url": "https://api.github.com/users/tedostrem/followers",
                "following_url": "https://api.github.com/users/tedostrem/following{/other_user}",
                "gists_url": "https://api.github.com/users/tedostrem/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/tedostrem/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/tedostrem/subscriptions",
                "organizations_url": "https://api.github.com/users/tedostrem/orgs",
                "repos_url": "https://api.github.com/users/tedostrem/repos",
                "events_url": "https://api.github.com/users/tedostrem/events{/privacy}",
                "received_events_url": "https://api.github.com/users/tedostrem/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2013-10-30T11:04:40Z",
            "updated_at": "2013-10-30T11:04:40Z",
            "author_association": "NONE",
            "body": "There is not much code to test in this case. \nuser_service.update_userprofile only fetches the document from mongodb based on the id in g.user_token.user_id\nupdates the fields in the document and saves it back to mongodb.\nIts a trivial piece of code.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/27570215",
            "html_url": "https://github.com/pallets/flask/issues/898#issuecomment-27570215",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/898",
            "id": 27570215,
            "node_id": "MDEyOklzc3VlQ29tbWVudDI3NTcwMjE1",
            "user": {
                "login": "ghost",
                "id": 10137,
                "node_id": "MDQ6VXNlcjEwMTM3",
                "avatar_url": "https://avatars3.githubusercontent.com/u/10137?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/ghost",
                "html_url": "https://github.com/ghost",
                "followers_url": "https://api.github.com/users/ghost/followers",
                "following_url": "https://api.github.com/users/ghost/following{/other_user}",
                "gists_url": "https://api.github.com/users/ghost/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/ghost/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ghost/subscriptions",
                "organizations_url": "https://api.github.com/users/ghost/orgs",
                "repos_url": "https://api.github.com/users/ghost/repos",
                "events_url": "https://api.github.com/users/ghost/events{/privacy}",
                "received_events_url": "https://api.github.com/users/ghost/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2013-11-01T14:42:37Z",
            "updated_at": "2013-11-01T14:42:37Z",
            "author_association": "NONE",
            "body": "@tedostrem What is your server?\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/27570496",
            "html_url": "https://github.com/pallets/flask/issues/898#issuecomment-27570496",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/898",
            "id": 27570496,
            "node_id": "MDEyOklzc3VlQ29tbWVudDI3NTcwNDk2",
            "user": {
                "login": "tedostrem",
                "id": 2115256,
                "node_id": "MDQ6VXNlcjIxMTUyNTY=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/2115256?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/tedostrem",
                "html_url": "https://github.com/tedostrem",
                "followers_url": "https://api.github.com/users/tedostrem/followers",
                "following_url": "https://api.github.com/users/tedostrem/following{/other_user}",
                "gists_url": "https://api.github.com/users/tedostrem/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/tedostrem/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/tedostrem/subscriptions",
                "organizations_url": "https://api.github.com/users/tedostrem/orgs",
                "repos_url": "https://api.github.com/users/tedostrem/repos",
                "events_url": "https://api.github.com/users/tedostrem/events{/privacy}",
                "received_events_url": "https://api.github.com/users/tedostrem/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2013-11-01T14:46:16Z",
            "updated_at": "2013-11-01T14:46:16Z",
            "author_association": "NONE",
            "body": "@gioi ec2, nginx, uwsgi\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/34558315",
            "html_url": "https://github.com/pallets/flask/issues/898#issuecomment-34558315",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/898",
            "id": 34558315,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM0NTU4MzE1",
            "user": {
                "login": "mitsuhiko",
                "id": 7396,
                "node_id": "MDQ6VXNlcjczOTY=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/7396?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/mitsuhiko",
                "html_url": "https://github.com/mitsuhiko",
                "followers_url": "https://api.github.com/users/mitsuhiko/followers",
                "following_url": "https://api.github.com/users/mitsuhiko/following{/other_user}",
                "gists_url": "https://api.github.com/users/mitsuhiko/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/mitsuhiko/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mitsuhiko/subscriptions",
                "organizations_url": "https://api.github.com/users/mitsuhiko/orgs",
                "repos_url": "https://api.github.com/users/mitsuhiko/repos",
                "events_url": "https://api.github.com/users/mitsuhiko/events{/privacy}",
                "received_events_url": "https://api.github.com/users/mitsuhiko/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2014-02-08T22:22:52Z",
            "updated_at": "2014-02-08T22:22:52Z",
            "author_association": "MEMBER",
            "body": "That's most likely not a problem with Flask but uwsgi.  Flask uses Werkzeug's context locals which are bound to the current thread.  uwsgi has been doing odd things with threads in the past already and there is a config variable to control how it works.\n"
        }
    ]
}
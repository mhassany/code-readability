{
    "url": "https://api.github.com/repos/pallets/flask/issues/3167",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/3167/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/3167/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/3167/events",
    "html_url": "https://github.com/pallets/flask/issues/3167",
    "id": 438919654,
    "node_id": "MDU6SXNzdWU0Mzg5MTk2NTQ=",
    "number": 3167,
    "title": "FactoryBoy data not created using json POST request",
    "user": {
        "login": "dpmccabe",
        "id": 527578,
        "node_id": "MDQ6VXNlcjUyNzU3OA==",
        "avatar_url": "https://avatars2.githubusercontent.com/u/527578?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dpmccabe",
        "html_url": "https://github.com/dpmccabe",
        "followers_url": "https://api.github.com/users/dpmccabe/followers",
        "following_url": "https://api.github.com/users/dpmccabe/following{/other_user}",
        "gists_url": "https://api.github.com/users/dpmccabe/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/dpmccabe/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/dpmccabe/subscriptions",
        "organizations_url": "https://api.github.com/users/dpmccabe/orgs",
        "repos_url": "https://api.github.com/users/dpmccabe/repos",
        "events_url": "https://api.github.com/users/dpmccabe/events{/privacy}",
        "received_events_url": "https://api.github.com/users/dpmccabe/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2019-04-30T18:39:35Z",
    "updated_at": "2019-05-10T14:24:19Z",
    "closed_at": "2019-05-10T14:24:19Z",
    "author_association": "NONE",
    "body": "I've discovered a weird interaction between Flask, pytest, SQLAlchemy, and FactoryBoy that I _think_ is a Flask bug. Consider these two identical routes that should both return the number of records in a database table:\r\n\r\n```py\r\nbp = Blueprint('example', __name__, url_prefix='/example')\r\n\r\n@bp.route('/form', methods = ['POST'])\r\ndef test_form():\r\n    return str(db_session.query(Person).count())\r\n\r\n@bp.route('/json', methods = ['POST'])\r\ndef test_json():\r\n    return str(db_session.query(Person).count())\r\n```\r\n\r\nThe difference is in the unit tests:\r\n\r\n```py\r\ndef test_form(self, client):\r\n    person = PersonFactory()\r\n    resp = client.post('/example/form', data={'foo': 'bar'})\r\n    assert resp.data == b'1'\r\n\r\ndef test_json(self, client):\r\n    person = PersonFactory()\r\n    resp = client.post('/example/json', json={'foo': 'bar'})\r\n    assert resp.data == b'1'\r\n```\r\n\r\nWe're posting form data in the first test and JSON in the second. The first test succeeds and you see this in the log:\r\n\r\n```pytb\r\n2019-04-30 14:26:05,425 INFO sqlalchemy.engine.base.Engine BEGIN (implicit)\r\n2019-04-30 14:26:05,427 INFO sqlalchemy.engine.base.Engine INSERT INTO people (id) VALUES (%(id)s)\r\n2019-04-30 14:26:05,427 INFO sqlalchemy.engine.base.Engine {'id': '658e241a-5522-47ca-9e61-bd6862d6ddc6}\r\n2019-04-30 14:26:05,432 INFO sqlalchemy.engine.base.Engine SELECT count(*) AS count_1 FROM (SELECT people.id AS people_id FROM people) AS anon_1\r\n2019-04-30 14:26:05,432 INFO sqlalchemy.engine.base.Engine {}\r\n2019-04-30 14:26:05,433 INFO sqlalchemy.engine.base.Engine ROLLBACK\r\n```\r\n\r\nFactoryBoy correctly inserts the data and rolls it back when the test is done. However, the second test fails because the test person isn't inserted:\r\n\r\n```pytb\r\n2019-04-30 14:28:27,341 INFO sqlalchemy.engine.base.Engine BEGIN (implicit)\r\n2019-04-30 14:28:27,342 INFO sqlalchemy.engine.base.Engine SELECT count(*) AS count_1 \r\nFROM (SELECT people.id AS people_id FROM people) AS anon_1\r\n2019-04-30 14:28:27,342 INFO sqlalchemy.engine.base.Engine {}\r\n2019-04-30 14:28:27,343 INFO sqlalchemy.engine.base.Engine ROLLBACK\r\n\r\ntests/test_example.py:40 (TestExample.test_json)\r\nb'0' != b'1'\r\n```\r\n\r\nSee this gist for how I'm creating the Flask app, initializing SQLAlchemy, and configuring the test suite: https://gist.github.com/dpmccabe/6d3bed81c37817c38fb3f2b262d1393d\r\n\r\nApologies if I'm doing anything unconventional, since I'm new to Flask.\r\n\r\n---\r\n\r\n### Expected Behavior\r\n\r\nThe format of the request body (form data vs. JSON) should have nothing to do with whether FactoryBoy inserts records.\r\n\r\n### Actual Behavior\r\n\r\nFactoryBoy records are not inserted when testing a post endpoint with a JSON body. It seems like there's some preprocessing step that's not performed with a JSON body.\r\n\r\n### Environment\r\n\r\n* Python version: 3.7\r\n* Flask version: 1.0.2\r\n* Werkzeug version: 0.15.2",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/488079696",
            "html_url": "https://github.com/pallets/flask/issues/3167#issuecomment-488079696",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3167",
            "id": 488079696,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ4ODA3OTY5Ng==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-04-30T19:16:08Z",
            "updated_at": "2019-04-30T19:16:40Z",
            "author_association": "MEMBER",
            "body": "There's no difference between the routes, because you're not parsing the form or JSON data, you're ignoring it. Parsing JSON in a request has nothing to do with SQLAlchemy queries anyway, and the Factory Boy call is outside of Flask.\r\n\r\nThis doesn't appear to be an issue with Flask, it appears to be an issue with Factory Boy not inserting data. Why do you think it's an issue with Flask?"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/488082564",
            "html_url": "https://github.com/pallets/flask/issues/3167#issuecomment-488082564",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3167",
            "id": 488082564,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ4ODA4MjU2NA==",
            "user": {
                "login": "dpmccabe",
                "id": 527578,
                "node_id": "MDQ6VXNlcjUyNzU3OA==",
                "avatar_url": "https://avatars2.githubusercontent.com/u/527578?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/dpmccabe",
                "html_url": "https://github.com/dpmccabe",
                "followers_url": "https://api.github.com/users/dpmccabe/followers",
                "following_url": "https://api.github.com/users/dpmccabe/following{/other_user}",
                "gists_url": "https://api.github.com/users/dpmccabe/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/dpmccabe/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/dpmccabe/subscriptions",
                "organizations_url": "https://api.github.com/users/dpmccabe/orgs",
                "repos_url": "https://api.github.com/users/dpmccabe/repos",
                "events_url": "https://api.github.com/users/dpmccabe/events{/privacy}",
                "received_events_url": "https://api.github.com/users/dpmccabe/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-04-30T19:24:59Z",
            "updated_at": "2019-04-30T19:25:08Z",
            "author_association": "NONE",
            "body": "Maybe it would be more accurate to claim that the problem might be with the Flask test client. I just can't imagine why changing the type of request in the test client would have anything to do with other code in that unit test that has nothing to do with the request and in fact occurs _before_ the request is made."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/488098031",
            "html_url": "https://github.com/pallets/flask/issues/3167#issuecomment-488098031",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3167",
            "id": 488098031,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ4ODA5ODAzMQ==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-04-30T20:12:51Z",
            "updated_at": "2019-04-30T20:12:51Z",
            "author_association": "MEMBER",
            "body": "The test client isn't involved in the code that's causing the issue, the issue is that Factory Boy doesn't insert data, which is not part of the Flask app or test client."
        }
    ]
}
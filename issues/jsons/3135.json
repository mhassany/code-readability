{
    "url": "https://api.github.com/repos/pallets/flask/issues/3135",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/3135/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/3135/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/3135/events",
    "html_url": "https://github.com/pallets/flask/issues/3135",
    "id": 428367827,
    "node_id": "MDU6SXNzdWU0MjgzNjc4Mjc=",
    "number": 3135,
    "title": "Flask + gevent: possible sockets leaks (in the CLOSE_WAIT state)",
    "user": {
        "login": "chubin",
        "id": 3875145,
        "node_id": "MDQ6VXNlcjM4NzUxNDU=",
        "avatar_url": "https://avatars1.githubusercontent.com/u/3875145?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/chubin",
        "html_url": "https://github.com/chubin",
        "followers_url": "https://api.github.com/users/chubin/followers",
        "following_url": "https://api.github.com/users/chubin/following{/other_user}",
        "gists_url": "https://api.github.com/users/chubin/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/chubin/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/chubin/subscriptions",
        "organizations_url": "https://api.github.com/users/chubin/orgs",
        "repos_url": "https://api.github.com/users/chubin/repos",
        "events_url": "https://api.github.com/users/chubin/events{/privacy}",
        "received_events_url": "https://api.github.com/users/chubin/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 6,
    "created_at": "2019-04-02T18:06:20Z",
    "updated_at": "2019-04-02T19:19:42Z",
    "closed_at": "2019-04-02T19:19:42Z",
    "author_association": "NONE",
    "body": "```python\r\n@app.route('/', defaults={'path': ''}, methods=['GET', 'POST'])\r\ndef catch_all(path):\r\n     session_id = 'session1'\r\n     if session_id not in sessions:\r\n         session = Session()\r\n         sessions[session_id] = session\r\n     else:\r\n         session = sessions[session_id]\r\n\r\n     session.start()\r\n     queue = register_queue()\r\n     def events():\r\n         try:\r\n             if queue:\r\n                 while True:\r\n                     for _, data in queue:\r\n                         yield data\r\n         finally:\r\n             # THIS POINT HERE IS NEVER BEING REACHED\r\n             # FOR SOME CLIENTS, becase the connection\r\n             # is getting stuck in the CLOSE_WAIT state\r\n\r\n             deregister_queue(queue)\r\n             if len(queues) == 0:\r\n                 session.kill()\r\n                 del sessions[session_id]\r\n\r\n  return Response(events(), content_type='text/event-stream')\r\n```\r\n\r\n### Expected Behavior\r\n\r\nAll sockets are getting closed after they are closed from the client side.\r\n\r\n### Actual Behavior\r\n\r\nSome sockets are getting stuck in the CLOSE_WAIT state\r\nafter they are closed from the client side.\r\n\r\n### Environment\r\n\r\n* Python version: Python 2.7.16rc1\r\n* Flask version: `Flask==1.0.2`\r\n* Werkzeug version: `Werkzeug==0.15.1`\r\n* gevent version: `gevent==1.4.0`",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/479145851",
            "html_url": "https://github.com/pallets/flask/issues/3135#issuecomment-479145851",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3135",
            "id": 479145851,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ3OTE0NTg1MQ==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-04-02T18:52:55Z",
            "updated_at": "2019-04-02T18:52:55Z",
            "author_association": "MEMBER",
            "body": "I know nothing about gevent, so you're probably going to have to investigate this on your own if you want a fix merged."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/479146452",
            "html_url": "https://github.com/pallets/flask/issues/3135#issuecomment-479146452",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3135",
            "id": 479146452,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ3OTE0NjQ1Mg==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-04-02T18:54:13Z",
            "updated_at": "2019-04-02T18:54:13Z",
            "author_association": "MEMBER",
            "body": "Please reduce this to a self contained example with both the server and client code to demonstrate the issue."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/479152664",
            "html_url": "https://github.com/pallets/flask/issues/3135#issuecomment-479152664",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3135",
            "id": 479152664,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ3OTE1MjY2NA==",
            "user": {
                "login": "chubin",
                "id": 3875145,
                "node_id": "MDQ6VXNlcjM4NzUxNDU=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/3875145?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/chubin",
                "html_url": "https://github.com/chubin",
                "followers_url": "https://api.github.com/users/chubin/followers",
                "following_url": "https://api.github.com/users/chubin/following{/other_user}",
                "gists_url": "https://api.github.com/users/chubin/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/chubin/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/chubin/subscriptions",
                "organizations_url": "https://api.github.com/users/chubin/orgs",
                "repos_url": "https://api.github.com/users/chubin/repos",
                "events_url": "https://api.github.com/users/chubin/events{/privacy}",
                "received_events_url": "https://api.github.com/users/chubin/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-04-02T19:08:52Z",
            "updated_at": "2019-04-02T19:08:52Z",
            "author_association": "NONE",
            "body": "@davidism I think that the problem is even worse that I expected. I think it happens only when some NAT or a stateful filter is in between. I will write a self contained example after the deeper investigation."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/479152824",
            "html_url": "https://github.com/pallets/flask/issues/3135#issuecomment-479152824",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3135",
            "id": 479152824,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ3OTE1MjgyNA==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-04-02T19:09:13Z",
            "updated_at": "2019-04-02T19:09:13Z",
            "author_association": "MEMBER",
            "body": "It looks like you have an infinite loop (`while True` without a `break`).\r\n\r\nI'm also not clear what the `CLOSE_WAIT` state is, it doesn't sound like part of the WSGI application layer. This sounds like an issue with Gevent not closing connections and therefore not entering the `finally` block."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/479153887",
            "html_url": "https://github.com/pallets/flask/issues/3135#issuecomment-479153887",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3135",
            "id": 479153887,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ3OTE1Mzg4Nw==",
            "user": {
                "login": "chubin",
                "id": 3875145,
                "node_id": "MDQ6VXNlcjM4NzUxNDU=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/3875145?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/chubin",
                "html_url": "https://github.com/chubin",
                "followers_url": "https://api.github.com/users/chubin/followers",
                "following_url": "https://api.github.com/users/chubin/following{/other_user}",
                "gists_url": "https://api.github.com/users/chubin/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/chubin/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/chubin/subscriptions",
                "organizations_url": "https://api.github.com/users/chubin/orgs",
                "repos_url": "https://api.github.com/users/chubin/repos",
                "events_url": "https://api.github.com/users/chubin/events{/privacy}",
                "received_events_url": "https://api.github.com/users/chubin/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-04-02T19:11:59Z",
            "updated_at": "2019-04-02T19:19:25Z",
            "author_association": "NONE",
            "body": "@davidism It is not a problem here. It works this way:\r\nafter the socket is closed, and you are trying to write to a closed socket,\r\nyou get an exception and thus leave the endless loop (jumping to the `finally`).\r\n\r\nIt is a pretty standard thing, e.g. here the flask developers are using the same technique:\r\n\r\nhttp://flask.pocoo.org/snippets/116/\r\n\r\nIn my particular case (and in this issue), it does not happen because the sockets are getting stuck in the `CLOSE_WAIT` state (it is a standard state of TCP/IP socket)."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/479157078",
            "html_url": "https://github.com/pallets/flask/issues/3135#issuecomment-479157078",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3135",
            "id": 479157078,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ3OTE1NzA3OA==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-04-02T19:19:42Z",
            "updated_at": "2019-04-02T19:19:42Z",
            "author_association": "MEMBER",
            "body": "Closing as this sounds like an issue with Gevent's WSGI server or your network stack. If you can create a minimal example demonstrating that this is an issue with Flask, I'll reopen."
        }
    ]
}
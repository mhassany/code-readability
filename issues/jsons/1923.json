{
    "url": "https://api.github.com/repos/pallets/flask/issues/1923",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/1923/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/1923/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/1923/events",
    "html_url": "https://github.com/pallets/flask/issues/1923",
    "id": 161705412,
    "node_id": "MDU6SXNzdWUxNjE3MDU0MTI=",
    "number": 1923,
    "title": "TaggedJSONSerializer encodes Python 2 strings as bytes",
    "user": {
        "login": "jaraco",
        "id": 308610,
        "node_id": "MDQ6VXNlcjMwODYxMA==",
        "avatar_url": "https://avatars2.githubusercontent.com/u/308610?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jaraco",
        "html_url": "https://github.com/jaraco",
        "followers_url": "https://api.github.com/users/jaraco/followers",
        "following_url": "https://api.github.com/users/jaraco/following{/other_user}",
        "gists_url": "https://api.github.com/users/jaraco/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/jaraco/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/jaraco/subscriptions",
        "organizations_url": "https://api.github.com/users/jaraco/orgs",
        "repos_url": "https://api.github.com/users/jaraco/repos",
        "events_url": "https://api.github.com/users/jaraco/events{/privacy}",
        "received_events_url": "https://api.github.com/users/jaraco/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 2,
    "created_at": "2016-06-22T14:56:46Z",
    "updated_at": "2016-06-22T16:25:04Z",
    "closed_at": "2016-06-22T16:25:04Z",
    "author_association": "NONE",
    "body": "I've encountered an issue while migrating one of our Flask apps from Python 2 to Python 3.\n\nConsider the canonical sessions example, with one minor tweak which forces a Python 2 ascii string into the session:\n\n```\nfrom flask import Flask, session, redirect, url_for, escape, request\n\napp = Flask(__name__)\n\n@app.route('/')\ndef index():\n    if 'username' in session:\n        return 'Logged in as %s' % escape(session['username'])\n    return 'You are not logged in'\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    if request.method == 'POST':\n        session['username'] = str(request.form['username'])\n        return redirect(url_for('index'))\n    return '''\n        <form action=\"\" method=\"post\">\n            <p><input type=text name=username>\n            <p><input type=submit value=Login>\n        </form>\n    '''\n\n@app.route('/logout')\ndef logout():\n    # remove the username from the session if it's there\n    session.pop('username', None)\n    return redirect(url_for('index'))\n\n# set the secret key.  keep this really secret:\napp.secret_key = 'A0Zr98j/3yX R~XHH!jmN]LWX/,?RT'\n```\n\nRun that app on Python 2, log in as 'jaraco', then run the app on Python 3 and refresh the `/` resource, and you'll get a response with this text:\n\n```\nLogged in as b'jaraco'\n```\n\nThe value has been typecast into bytes as a result of the TaggedJSONSerializer. This bytes value then wreaks havoc when text strings are expected.\n\nI imagine three possible ways to deal with this issue:\n1. Rewrite the applications such that they ensure that all text values are stored as unicode even on Python 2.\n2. Rewrite the TaggedJSONSerializer to only b64 encode bytes values on Python 3, but provide a hook so that if Python 2 consumers still want to encode to bytes, they can wrap the values in a special class that indicates bytes (similar to how MongoDB provides bson.Binary) which will be treated the same as bytes on Python 3.\n3. Rewrite the applications such that when consuming session values, any binary values found for text strings are decoded.\n\nOption 3 seems like a hack around the symptom, addressing the output and not the underlying issue, so I'm dismissing that out of hand.\n\nOption 1 seems the cleanest, though a lot of work for potentially a lot of applications.\n\nOption 2 seems the most robust, but has backward-compatibility concerns. On the whole, though, I expect it will save users a great deal of time and trouble as they upgrade from Python 2 to 3. I expect that most users of Flask when storing Python 2 `str` values in the session are actually intending to be storing text and not binary bytes, and this option honors that expectation while providing a solution for consumers that might need to intentionally store binary values.\n\nWhat's your recommendation? Would Flask consider a PR to implement Option 2? Is there another option I'm not considering?\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/227771871",
            "html_url": "https://github.com/pallets/flask/issues/1923#issuecomment-227771871",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1923",
            "id": 227771871,
            "node_id": "MDEyOklzc3VlQ29tbWVudDIyNzc3MTg3MQ==",
            "user": {
                "login": "ThiefMaster",
                "id": 179599,
                "node_id": "MDQ6VXNlcjE3OTU5OQ==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/179599?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/ThiefMaster",
                "html_url": "https://github.com/ThiefMaster",
                "followers_url": "https://api.github.com/users/ThiefMaster/followers",
                "following_url": "https://api.github.com/users/ThiefMaster/following{/other_user}",
                "gists_url": "https://api.github.com/users/ThiefMaster/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/ThiefMaster/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ThiefMaster/subscriptions",
                "organizations_url": "https://api.github.com/users/ThiefMaster/orgs",
                "repos_url": "https://api.github.com/users/ThiefMaster/repos",
                "events_url": "https://api.github.com/users/ThiefMaster/events{/privacy}",
                "received_events_url": "https://api.github.com/users/ThiefMaster/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2016-06-22T15:00:06Z",
            "updated_at": "2016-06-22T15:00:06Z",
            "author_association": "MEMBER",
            "body": "I think (1) makes the most sense\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/227798731",
            "html_url": "https://github.com/pallets/flask/issues/1923#issuecomment-227798731",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1923",
            "id": 227798731,
            "node_id": "MDEyOklzc3VlQ29tbWVudDIyNzc5ODczMQ==",
            "user": {
                "login": "jaraco",
                "id": 308610,
                "node_id": "MDQ6VXNlcjMwODYxMA==",
                "avatar_url": "https://avatars2.githubusercontent.com/u/308610?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/jaraco",
                "html_url": "https://github.com/jaraco",
                "followers_url": "https://api.github.com/users/jaraco/followers",
                "following_url": "https://api.github.com/users/jaraco/following{/other_user}",
                "gists_url": "https://api.github.com/users/jaraco/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/jaraco/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jaraco/subscriptions",
                "organizations_url": "https://api.github.com/users/jaraco/orgs",
                "repos_url": "https://api.github.com/users/jaraco/repos",
                "events_url": "https://api.github.com/users/jaraco/events{/privacy}",
                "received_events_url": "https://api.github.com/users/jaraco/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2016-06-22T16:25:04Z",
            "updated_at": "2016-06-22T16:25:04Z",
            "author_association": "NONE",
            "body": "I did find that another workaround is possible. If the app doesn't need to be deployed simultaneously on both Python 2 and 3 and if it's acceptable to flush existing sessions, just changing the session key causes those existing sessions to become invalid. Making this change during the upgrade to Python 3 worked around the issue.\n\nGiven the preference for (1), I'm closing this.\n"
        }
    ]
}
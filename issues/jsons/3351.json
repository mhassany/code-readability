{
    "url": "https://api.github.com/repos/pallets/flask/issues/3351",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/3351/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/3351/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/3351/events",
    "html_url": "https://github.com/pallets/flask/issues/3351",
    "id": 489057538,
    "node_id": "MDU6SXNzdWU0ODkwNTc1Mzg=",
    "number": 3351,
    "title": "Filename altered after upload",
    "user": {
        "login": "Chocorean",
        "id": 11725034,
        "node_id": "MDQ6VXNlcjExNzI1MDM0",
        "avatar_url": "https://avatars2.githubusercontent.com/u/11725034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Chocorean",
        "html_url": "https://github.com/Chocorean",
        "followers_url": "https://api.github.com/users/Chocorean/followers",
        "following_url": "https://api.github.com/users/Chocorean/following{/other_user}",
        "gists_url": "https://api.github.com/users/Chocorean/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/Chocorean/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Chocorean/subscriptions",
        "organizations_url": "https://api.github.com/users/Chocorean/orgs",
        "repos_url": "https://api.github.com/users/Chocorean/repos",
        "events_url": "https://api.github.com/users/Chocorean/events{/privacy}",
        "received_events_url": "https://api.github.com/users/Chocorean/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2019-09-04T09:50:22Z",
    "updated_at": "2019-09-05T12:04:33Z",
    "closed_at": "2019-09-04T15:22:54Z",
    "author_association": "NONE",
    "body": "Trying to upload a file named `\u0420\u0430\u0441\u0448\u0438\u0444\u0440\u043e\u0432\u043a\u0430 RootKit.com [63k].txt` via `requests.post(files={'file': open(fn, 'rb')})`. I checked the file is sent with its correct name. On the other side, `request.files['file']` does not have the good filename.\r\n\r\n### Expected Behavior\r\nThe file should be should saved with its filename.\r\n\r\n```python\r\ndef _upload_file(filename):\r\n    def filter_filename(filename: str) -> str:\r\n        \"\"\"Stolen from werkzerg and add exotic letters\"\"\"\r\n        from unicodedata import normalize\r\n        # filtered = normalize(\"NFKD\", filename)\r\n        filtered = filename\r\n        for s in sep, altsep:\r\n            if s:\r\n                filtered = filtered.replace(s, \" \")\r\n        pattern = re.compile(r\"[^\\w.-]\")\r\n        filtered = pattern.sub(\"\", \"_\".join(filtered.split()))\r\n        filtered = filtered.strip(\"._\")\r\n        # filtered = filtered.encode('utf-8')\r\n        return filtered\r\n\r\n    global TMP_PATH\r\n    u_file = request.files[filename]\r\n    u_path = pjoin(TMP_PATH, filter_filename(path))\r\n    u_file.save(u_path)  # crash: UnicodeEncodeError\r\n    return u_path\r\n```\r\n\r\n### Actual Behavior\r\nFlask fails to save the uploaded file.\r\n\r\n```pytbssh\r\nFile \"/var/www/app/eyeaieouille/app/api.py\", line 174, in post_leak\r\n[Wed Sep 04 11:46:21.960213 2019] [wsgi:error] [pid 72138:tid 140145960113920] [remote 192.168.180.67:53369]     u_path = _upload_file('dump')\r\n[Wed Sep 04 11:46:21.960240 2019] [wsgi:error] [pid 72138:tid 140145960113920] [remote 192.168.180.67:53369]   File \"/var/www/app/eyeaieouille/app/api.py\", line 76, in _upload_file\r\n[Wed Sep 04 11:46:21.960261 2019] [wsgi:error] [pid 72138:tid 140145960113920] [remote 192.168.180.67:53369]     u_file.save(u_path)\r\n[Wed Sep 04 11:46:21.960266 2019] [wsgi:error] [pid 72138:tid 140145960113920] [remote 192.168.180.67:53369]   File \"/usr/lib/python3/dist-packages/werkzeug/datastructures.py\", line 2725, in save\r\n[Wed Sep 04 11:46:21.960274 2019] [wsgi:error] [pid 72138:tid 140145960113920] [remote 192.168.180.67:53369]     dst = open(dst, 'wb')\r\n[Wed Sep 04 11:46:21.960291 2019] [wsgi:error] [pid 72138:tid 140145960113920] [remote 192.168.180.67:53369] UnicodeEncodeError: 'ascii' codec can't encode characters in position 5-15: ordinal not in range(128)\r\n\r\n```\r\n\r\nWhenever I try to print `request.files['file'].filename` with `app.logger.info()`, I have:\r\n\r\n```pytb\r\n[Wed Sep 04 11:40:08.636779 2019] [wsgi:error] [pid 71927:tid 140645057996544] [remote 192.168.180.67:53298] Message: '\\xd0\\xa0\\xd0\\xb0\\xd1\\x81\\xd1\\x88\\xd0\\xb8\\xd1\\x84\\xd1\\x80\\xd0\\xbe\\xd0\\xb2\\xd0\\xba\\xd0\\xb0 RootKit.com [63k].txt'\r\n```\r\n\r\n### Environment\r\n\r\n* Python version: 3.6.8\r\n* Flask version: 0.12.2\r\n* Werkzeug version: 0.14.1\r\n\r\nEDIT:\r\nI took a look at Wireshark, and this is what I saw:  \r\n`Content-Disposition: form-data; name=\"dump\"; filename*=utf-8''%D0%A0%D0%B0%D1%81%D1%88%D0%B8%D1%84%D1%80%D0%BE%D0%B2%D0%BA%D0%B0%20RootKit.com%20%5B63k%5D.txt`\r\nI think Flask turns this into `\\xd0\\xa0\\xd0\\xb0\\xd1\\x81\\xd1\\x88\\xd0\\xb8\\xd1\\x84\\xd1\\x80\\xd0\\xbe\\xd0\\xb2\\xd0\\xba\\xd0\\xb0 RootKit.com [63k].txt` instead of `\u0420\u0430\u0441\u0448\u0438\u0444\u0440\u043e\u0432\u043a\u0430 RootKit.com [63k].txt`. I am not expecting for a fix as long as the documentation advises to use the `werkzerg.secure_filename()` function, but as it erases some characters (`[^a-zA-Z0-9]` cleaning), but I would appreciate a wordaround, it did not manage to solve this issue.",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/527951067",
            "html_url": "https://github.com/pallets/flask/issues/3351#issuecomment-527951067",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3351",
            "id": 527951067,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUyNzk1MTA2Nw==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-09-04T15:22:54Z",
            "updated_at": "2019-09-04T15:22:54Z",
            "author_association": "MEMBER",
            "body": "That is the correct filename, `u_path.decode('utf8')` produces the original filename. If `open` is trying to open using the ascii filesystem encoding, that sounds like a misconfiguration of your system locale or Python.\r\n\r\nI tried uploading and saving a file with that name on my system, and did not encounter this issue. \r\n\r\nNote that you can pass an open file to `save` instead of a path, so you can open the file manually in a way that works for you and pass that in."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/528215596",
            "html_url": "https://github.com/pallets/flask/issues/3351#issuecomment-528215596",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3351",
            "id": 528215596,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUyODIxNTU5Ng==",
            "user": {
                "login": "Chocorean",
                "id": 11725034,
                "node_id": "MDQ6VXNlcjExNzI1MDM0",
                "avatar_url": "https://avatars2.githubusercontent.com/u/11725034?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/Chocorean",
                "html_url": "https://github.com/Chocorean",
                "followers_url": "https://api.github.com/users/Chocorean/followers",
                "following_url": "https://api.github.com/users/Chocorean/following{/other_user}",
                "gists_url": "https://api.github.com/users/Chocorean/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/Chocorean/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Chocorean/subscriptions",
                "organizations_url": "https://api.github.com/users/Chocorean/orgs",
                "repos_url": "https://api.github.com/users/Chocorean/repos",
                "events_url": "https://api.github.com/users/Chocorean/events{/privacy}",
                "received_events_url": "https://api.github.com/users/Chocorean/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-09-05T06:18:17Z",
            "updated_at": "2019-09-05T06:18:17Z",
            "author_association": "NONE",
            "body": "I wonder how do you manage to do `u_path.decode('utf8')` because it is not a `bytes` object but a `str`..."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/528331521",
            "html_url": "https://github.com/pallets/flask/issues/3351#issuecomment-528331521",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3351",
            "id": 528331521,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUyODMzMTUyMQ==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-09-05T12:04:33Z",
            "updated_at": "2019-09-05T12:04:33Z",
            "author_association": "MEMBER",
            "body": "I didn't have to, everything just worked. I was pointing out that the representation you were seeing was an encoded version of the name."
        }
    ]
}
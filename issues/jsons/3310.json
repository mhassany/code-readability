{
    "url": "https://api.github.com/repos/pallets/flask/issues/3310",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/3310/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/3310/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/3310/events",
    "html_url": "https://github.com/pallets/flask/issues/3310",
    "id": 470949892,
    "node_id": "MDU6SXNzdWU0NzA5NDk4OTI=",
    "number": 3310,
    "title": "Change Flask request context to bypass a bug at redirection when referrer is too long. ",
    "user": {
        "login": "celine-m-s",
        "id": 6150920,
        "node_id": "MDQ6VXNlcjYxNTA5MjA=",
        "avatar_url": "https://avatars1.githubusercontent.com/u/6150920?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/celine-m-s",
        "html_url": "https://github.com/celine-m-s",
        "followers_url": "https://api.github.com/users/celine-m-s/followers",
        "following_url": "https://api.github.com/users/celine-m-s/following{/other_user}",
        "gists_url": "https://api.github.com/users/celine-m-s/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/celine-m-s/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/celine-m-s/subscriptions",
        "organizations_url": "https://api.github.com/users/celine-m-s/orgs",
        "repos_url": "https://api.github.com/users/celine-m-s/repos",
        "events_url": "https://api.github.com/users/celine-m-s/events{/privacy}",
        "received_events_url": "https://api.github.com/users/celine-m-s/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2019-07-22T08:01:09Z",
    "updated_at": "2019-07-22T20:36:20Z",
    "closed_at": "2019-07-22T20:36:20Z",
    "author_association": "NONE",
    "body": "Hello! :wave: \r\n\r\nI have a problem in my Flask application. When the \"Referer\" header field is longer than about 1700 characters in any view, Flask does not perform the redirection but issues a 503 error.\r\n\r\n### Actual behavior\r\n\r\n```python\r\n# PDB\r\nimport requests\r\n\r\nheaders = {\r\n    {\r\n        'host': 'https://myhost.com',\r\n        'referer': 'https://myhost.com?id_token_hint=asuperlongtokenstrippedoutforconvenience'    \r\n    }\r\n}\r\n\r\nrequests.get('https://myurl.com', headers=headers)\r\n<Response [503]>\r\n```\r\n\r\n```python\r\n# views.py\r\n@app.route('/aview')\r\ndef original_view():\r\n    return redirect(url_for('home'))\r\n\r\n@app.route('/')\r\ndef home():\r\n    return render_template('home.html')\r\n```\r\n\r\nThe redirection works when the referrer field is shorter than about 1700 characters, I tested it several times. Note that this happens only on staging or on production and never on my dev environment. \r\n\r\nMy direction to bypass this problem is to **change the referrer** and then perform the redirection.\r\n\r\nBut if I change it in original_view, the referrer is still present in the redirected view (home). It does nothing. Example:\r\n\r\n```python\r\n# views.py\r\nfrom flask import request\r\n\r\n@app.route('/aview')\r\ndef original_view():\r\n    real_request = request._get_current_object()\r\n    real_request.environ['HTTP_REFERER'] = ''\r\n    return redirect(url_for('home'))\r\n```\r\n\r\nDoing this, the `request` object is changed in `original_view` but reappears as it was before in `home` with the old referrer still present.\r\n\r\nI read that Flask stores WSGI variables in a [local thread](https://flask.palletsprojects.com/en/1.1.x/quickstart/#context-locals) but I did not manage to change it and I don't know if it's even possible. I tried to get the context using `_request_ctx_stack` from `current app` but even if I change the referrer here, it still reappears after the redirection.\r\n\r\nDoes someone have an idea of what I can do to solve this problem in an elegant way? Thanks in advance!\r\n\r\n### Expected Behavior\r\n\r\nPerform the redirection without a 503 or delete the referrer.\r\n\r\n### Environment\r\n\r\n* Python version: 3.6.7 \r\n* Flask version: 0.12.4\r\n* Werkzeug version: 0.11.10\r\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/513944104",
            "html_url": "https://github.com/pallets/flask/issues/3310#issuecomment-513944104",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3310",
            "id": 513944104,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUxMzk0NDEwNA==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-07-22T20:36:20Z",
            "updated_at": "2019-07-22T20:36:20Z",
            "author_association": "MEMBER",
            "body": "Headers are sent by the client. Changing a header that's already been read in a request has no effect on the client. Many production servers such as Apache have a default max header length. It's likely the Werkzeug dev server, not worried about security, doesn't have a limit. You'll need to consult your hosting / server config to address this, but you should really consider why you have a URL that long to begin with."
        }
    ]
}
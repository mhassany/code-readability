{
    "url": "https://api.github.com/repos/pallets/flask/issues/2604",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/2604/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/2604/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/2604/events",
    "html_url": "https://github.com/pallets/flask/issues/2604",
    "id": 290359679,
    "node_id": "MDU6SXNzdWUyOTAzNTk2Nzk=",
    "number": 2604,
    "title": "Flask shell: Give readline a completer that is aware of shell context",
    "user": {
        "login": "CookiesBestDinner",
        "id": 6226741,
        "node_id": "MDQ6VXNlcjYyMjY3NDE=",
        "avatar_url": "https://avatars0.githubusercontent.com/u/6226741?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/CookiesBestDinner",
        "html_url": "https://github.com/CookiesBestDinner",
        "followers_url": "https://api.github.com/users/CookiesBestDinner/followers",
        "following_url": "https://api.github.com/users/CookiesBestDinner/following{/other_user}",
        "gists_url": "https://api.github.com/users/CookiesBestDinner/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/CookiesBestDinner/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/CookiesBestDinner/subscriptions",
        "organizations_url": "https://api.github.com/users/CookiesBestDinner/orgs",
        "repos_url": "https://api.github.com/users/CookiesBestDinner/repos",
        "events_url": "https://api.github.com/users/CookiesBestDinner/events{/privacy}",
        "received_events_url": "https://api.github.com/users/CookiesBestDinner/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 380608249,
            "node_id": "MDU6TGFiZWwzODA2MDgyNDk=",
            "url": "https://api.github.com/repos/pallets/flask/labels/cli",
            "name": "cli",
            "color": "1d76db",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 10,
    "created_at": "2018-01-22T06:07:06Z",
    "updated_at": "2018-01-24T17:57:04Z",
    "closed_at": "2018-01-24T17:57:04Z",
    "author_association": "NONE",
    "body": "### Problem\r\n`cli.py:shell_command` (flask shell) creates a context and passes it to `code.interact`\r\nThis leaves tab completion broken:\r\n\r\n```\r\n>>> stuff = 5\r\n>>> stuTABTABTABTAB <- no match\r\n```\r\n### Suggestion\r\nThis can be remedied by supplying a completer to readline:\r\n\r\n```\r\n>>> import readline\r\n>>> import rlcompleter\r\n>>> readline.set_completer(rlcompleter.Completer(globals()).complete)\r\n>>> stuTAB <- stuff! yay!\r\n```\r\n\r\nOr perhaps `flask/__main__.py` could be used as the context:\r\n\r\n*file: flask/cli.py*\r\n```\r\n...\r\ndef shell_command():\r\n...\r\n    import __main__\r\n    ctx = __main__.__dict__\r\n...\r\n```",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/359886610",
            "html_url": "https://github.com/pallets/flask/issues/2604#issuecomment-359886610",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2604",
            "id": 359886610,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM1OTg4NjYxMA==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-01-23T18:34:58Z",
            "updated_at": "2018-01-23T18:35:08Z",
            "author_association": "MEMBER",
            "body": "This requires setting up an `InteractiveConsole` instead of using the `code.interact` shortcut. Then we can call `runcode` on the object before calling `interact` on it. If possible, check if the completer is already set up."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/360053222",
            "html_url": "https://github.com/pallets/flask/issues/2604#issuecomment-360053222",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2604",
            "id": 360053222,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM2MDA1MzIyMg==",
            "user": {
                "login": "CookiesBestDinner",
                "id": 6226741,
                "node_id": "MDQ6VXNlcjYyMjY3NDE=",
                "avatar_url": "https://avatars0.githubusercontent.com/u/6226741?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/CookiesBestDinner",
                "html_url": "https://github.com/CookiesBestDinner",
                "followers_url": "https://api.github.com/users/CookiesBestDinner/followers",
                "following_url": "https://api.github.com/users/CookiesBestDinner/following{/other_user}",
                "gists_url": "https://api.github.com/users/CookiesBestDinner/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/CookiesBestDinner/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/CookiesBestDinner/subscriptions",
                "organizations_url": "https://api.github.com/users/CookiesBestDinner/orgs",
                "repos_url": "https://api.github.com/users/CookiesBestDinner/repos",
                "events_url": "https://api.github.com/users/CookiesBestDinner/events{/privacy}",
                "received_events_url": "https://api.github.com/users/CookiesBestDinner/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-01-24T08:13:59Z",
            "updated_at": "2018-01-24T09:02:54Z",
            "author_association": "NONE",
            "body": "Pardon me, what's wrong/missing with\r\n\r\n```\r\nreadline.set_completer(rlcompleter.Completer(globals()).complete)\r\n```\r\n?\r\n\r\nI added these three lines in my flask installation:\r\n\r\n```python\r\n    import readline\r\n    import rlcompleter\r\n    readline.set_completer(rlcompleter.Completer(ctx).complete)\r\n    code.interact(banner=banner, local=ctx)\r\n```\r\nWhich \"works for me\", you've got a far better perspective on this than me, so if it's the case that something's wrong/missing with that edit then I'm super curious about what that is.\r\n\r\nOr, without touching the completer, `flask/__main__.py` (module `__main__`) could be used as the context, that's what rlcompleter uses when it gets imported and sets a default completer. (and flask's main function could be removed from the context before starting the interactive console)\r\n\r\nThere's also the possibility of setting the completer to use `globals()` from PYTHONSTARTUP, without any change at all to flask (though a far less convenient default for the flask shell command)"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/360131956",
            "html_url": "https://github.com/pallets/flask/issues/2604#issuecomment-360131956",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2604",
            "id": 360131956,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM2MDEzMTk1Ng==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-01-24T13:24:35Z",
            "updated_at": "2018-01-24T13:56:14Z",
            "author_association": "MEMBER",
            "body": "I was under the impression it had to be called from within the new shell, since `globals` would refer to the scope of `flask.cli` otherwise, and `ctx` is just the injected values, not the full context."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/360169922",
            "html_url": "https://github.com/pallets/flask/issues/2604#issuecomment-360169922",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2604",
            "id": 360169922,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM2MDE2OTkyMg==",
            "user": {
                "login": "CookiesBestDinner",
                "id": 6226741,
                "node_id": "MDQ6VXNlcjYyMjY3NDE=",
                "avatar_url": "https://avatars0.githubusercontent.com/u/6226741?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/CookiesBestDinner",
                "html_url": "https://github.com/CookiesBestDinner",
                "followers_url": "https://api.github.com/users/CookiesBestDinner/followers",
                "following_url": "https://api.github.com/users/CookiesBestDinner/following{/other_user}",
                "gists_url": "https://api.github.com/users/CookiesBestDinner/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/CookiesBestDinner/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/CookiesBestDinner/subscriptions",
                "organizations_url": "https://api.github.com/users/CookiesBestDinner/orgs",
                "repos_url": "https://api.github.com/users/CookiesBestDinner/repos",
                "events_url": "https://api.github.com/users/CookiesBestDinner/events{/privacy}",
                "received_events_url": "https://api.github.com/users/CookiesBestDinner/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-01-24T15:25:12Z",
            "updated_at": "2018-01-24T15:47:55Z",
            "author_association": "NONE",
            "body": "Is this sufficient indication of that it is the full context?\r\n\r\n```\r\n# inside flask/cli.py shell_command\r\nctx = {}\r\nctx['ctx'] = ctx\r\nimport readline\r\nimport rlcompleter\r\nreadline.set_completer(rlcompleter.Completer(ctx).complete)\r\n```\r\n`globals()` returns `ctx`:\r\n```\r\n$ flask shell\r\n>>> ctx is globals()\r\nTrue\r\n```\r\n\r\nAnd, `InteractiveInterpreter`'s `__doc__` on what it does with that context\r\n\r\n```\r\n |  __init__(self, locals=None)\r\n |      Constructor.\r\n |      \r\n |      The optional 'locals' argument specifies the dictionary in\r\n |      which code will be executed; it defaults to a newly created\r\n |      dictionary with key \"__name__\" set to \"__console__\" and key\r\n |      \"__doc__\" set to None.\r\n```\r\nPerhaps `__name__` and `__doc__` should also get set to something, rather than allowing that to fall back to a lookup in the builtins module:\r\n\r\n```\r\n$ flask shell\r\n>>> __name__\r\n'builtins'\r\n>>> __doc__\r\n\"Built-in functions, exceptions, and other objects.\\n\\nNoteworthy: None is the `nil' object; Ellipsis represents `...' in slices.\"\r\n```\r\n\r\n```\r\n>>> help(globals)\r\nHelp on built-in function globals in module builtins:\r\n\r\nglobals()\r\n    Return the dictionary containing the current scope's global variables.\r\n    \r\n    NOTE: Updates to this dictionary *will* affect name lookups in the current\r\n    global scope and vice-versa.\r\n```"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/360192579",
            "html_url": "https://github.com/pallets/flask/issues/2604#issuecomment-360192579",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2604",
            "id": 360192579,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM2MDE5MjU3OQ==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-01-24T16:33:03Z",
            "updated_at": "2018-01-24T16:33:03Z",
            "author_association": "MEMBER",
            "body": "I've been looking into this, this is not enough to match how the standard shell behaves. It looks like `venv` messes with `site.py` and doesn't set up the completer the same way as the default `site.py`."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/360195303",
            "html_url": "https://github.com/pallets/flask/issues/2604#issuecomment-360195303",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2604",
            "id": 360195303,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM2MDE5NTMwMw==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-01-24T16:40:59Z",
            "updated_at": "2018-01-24T16:40:59Z",
            "author_association": "MEMBER",
            "body": "Essentially need to copy Python's `site.enablerlcompleter`.\r\n\r\nhttps://github.com/python/cpython/blob/22feeb88b473b288950cdb2f6c5d28692274b5f9/Lib/site.py#L401-L449"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/360195971",
            "html_url": "https://github.com/pallets/flask/issues/2604#issuecomment-360195971",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2604",
            "id": 360195971,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM2MDE5NTk3MQ==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-01-24T16:42:52Z",
            "updated_at": "2018-01-24T16:42:52Z",
            "author_association": "MEMBER",
            "body": "Looks like `venv` makes `sys.__interactivehook__` available and `code.interact` just doesn't call it like the standard shell. But when using `virtualenv` or `mkvirtualenv` it's undefined."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/360196278",
            "html_url": "https://github.com/pallets/flask/issues/2604#issuecomment-360196278",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2604",
            "id": 360196278,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM2MDE5NjI3OA==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-01-24T16:43:41Z",
            "updated_at": "2018-01-24T16:43:41Z",
            "author_association": "MEMBER",
            "body": "Unfortunately, `sys.__interactivehook__` doesn't pick up the added context, so it's not available for completion."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/360211381",
            "html_url": "https://github.com/pallets/flask/issues/2604#issuecomment-360211381",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2604",
            "id": 360211381,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM2MDIxMTM4MQ==",
            "user": {
                "login": "CookiesBestDinner",
                "id": 6226741,
                "node_id": "MDQ6VXNlcjYyMjY3NDE=",
                "avatar_url": "https://avatars0.githubusercontent.com/u/6226741?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/CookiesBestDinner",
                "html_url": "https://github.com/CookiesBestDinner",
                "followers_url": "https://api.github.com/users/CookiesBestDinner/followers",
                "following_url": "https://api.github.com/users/CookiesBestDinner/following{/other_user}",
                "gists_url": "https://api.github.com/users/CookiesBestDinner/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/CookiesBestDinner/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/CookiesBestDinner/subscriptions",
                "organizations_url": "https://api.github.com/users/CookiesBestDinner/orgs",
                "repos_url": "https://api.github.com/users/CookiesBestDinner/repos",
                "events_url": "https://api.github.com/users/CookiesBestDinner/events{/privacy}",
                "received_events_url": "https://api.github.com/users/CookiesBestDinner/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-01-24T17:30:41Z",
            "updated_at": "2018-01-24T17:44:15Z",
            "author_association": "NONE",
            "body": "Right. It got complicated real quick. I copied over CPython's Lib/site.py's setting of the completion key and reading .inputrc, while leaving historyfile untouched, and only if successfully importing readline and rlcompleter. <- this is now in the pull request.\r\n\r\nBut now I'm patching holes and being unable to reason about things, so perhaps I should drop it.\r\nI don't mean to be pushy with the pull request, that was just *giving it a try*"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/360219376",
            "html_url": "https://github.com/pallets/flask/issues/2604#issuecomment-360219376",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2604",
            "id": 360219376,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM2MDIxOTM3Ng==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-01-24T17:57:04Z",
            "updated_at": "2018-01-24T17:57:04Z",
            "author_association": "MEMBER",
            "body": "I appreciate the pull request, often it's a lot better to have something to actually test and comment on.\r\n\r\nI agree that this is too complicated, I don't like that we have to duplicate a bunch of code. Looks like it's already to reported to pypa/virtualenv#967.\r\n\r\nFor what it's worth, I don't use the default shell, I install Flask-Shell-IPython. IPython handles all this without hassle."
        }
    ]
}
{
    "url": "https://api.github.com/repos/pallets/flask/issues/1810",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/1810/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/1810/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/1810/events",
    "html_url": "https://github.com/pallets/flask/pull/1810",
    "id": 154898747,
    "node_id": "MDExOlB1bGxSZXF1ZXN0NzAxMTYyNTg=",
    "number": 1810,
    "title": "Added X-Accel-Redirect support",
    "user": {
        "login": "deelaka",
        "id": 13479441,
        "node_id": "MDQ6VXNlcjEzNDc5NDQx",
        "avatar_url": "https://avatars3.githubusercontent.com/u/13479441?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/deelaka",
        "html_url": "https://github.com/deelaka",
        "followers_url": "https://api.github.com/users/deelaka/followers",
        "following_url": "https://api.github.com/users/deelaka/following{/other_user}",
        "gists_url": "https://api.github.com/users/deelaka/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/deelaka/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/deelaka/subscriptions",
        "organizations_url": "https://api.github.com/users/deelaka/orgs",
        "repos_url": "https://api.github.com/users/deelaka/repos",
        "events_url": "https://api.github.com/users/deelaka/events{/privacy}",
        "received_events_url": "https://api.github.com/users/deelaka/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 5,
    "created_at": "2016-05-15T09:11:23Z",
    "updated_at": "2016-05-15T10:01:05Z",
    "closed_at": "2016-05-15T10:01:05Z",
    "author_association": "NONE",
    "pull_request": {
        "url": "https://api.github.com/repos/pallets/flask/pulls/1810",
        "html_url": "https://github.com/pallets/flask/pull/1810",
        "diff_url": "https://github.com/pallets/flask/pull/1810.diff",
        "patch_url": "https://github.com/pallets/flask/pull/1810.patch"
    },
    "body": "`X-Accel-Redirect` is very much alike Apache's `XSendfile` it instead however needs a `URI` pointing to the file than an absolute path. This is a tricky problem to solve and there  have been discussions on implementing a `nginx_sendfile` method, this however is disastrous since in development machines `nginx_sendfile` won't send the file since it is on a default flask server, thus every time the developer wishes to test an app on his own machine, it is required to change all `nginx_sendfile` calls to normal `flask.send_file` calls manually changing url's and such.\n\nHow is this patch different? As seen below in the test app simply set the config  `USE_X_ACCEL` to true and then when calling `send_file` set the `x_accel_uri` parameter to the internal `uri` configured in your nginx config. And when testing simply keep `USE_X_ACCEL` at the default value `False`, this will make `send_file` ignore the `x_accel_uri` even if it is set. :smile: \n## A test app:\n\n```\nfrom flask import Flask, send_file\n\napp = Flask(__name__)\napp.use_x_accel = True  \n# app.config['USE_X_ACCEL'] = True\n\n@app.route('/dl')\ndef download():\n        return send_file('files/1GB.zip', as_attachment=True, x_accel_uri='/protected/')\n\napp.run(debug=True, port=8080)\n```\n## For the following nginx config:\n\n```\nserver {\n        listen 80;\n\n        location / {\n                proxy_pass http://localhost:8080/;\n        }\n\n        location /protected {\n                internal;\n                alias /home/test/files;\n        }\n}\n```\n### Headers retrieved using `Curl`:\n\n```\ndeelaka@deelaka-Lap:~$ curl -I your.server.ip/dl\nHTTP/1.1 200 OK\nServer: nginx/1.4.6 (Ubuntu)\nDate: Sun, 15 May 2016 08:42:49 GMT\nContent-Type: application/zip\nContent-Length: 1073741824\nLast-Modified: Sat, 14 May 2016 16:51:22 GMT\nConnection: keep-alive\nContent-Disposition: attachment; filename=1GB.zip\nCache-Control: public, max-age=43200\nExpires: Sun, 15 May 2016 20:42:49 GMT\nETag: \"5737578a-40000000\"\nAccept-Ranges: bytes\n\n```\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/219274776",
            "html_url": "https://github.com/pallets/flask/pull/1810#issuecomment-219274776",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1810",
            "id": 219274776,
            "node_id": "MDEyOklzc3VlQ29tbWVudDIxOTI3NDc3Ng==",
            "user": {
                "login": "ThiefMaster",
                "id": 179599,
                "node_id": "MDQ6VXNlcjE3OTU5OQ==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/179599?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/ThiefMaster",
                "html_url": "https://github.com/ThiefMaster",
                "followers_url": "https://api.github.com/users/ThiefMaster/followers",
                "following_url": "https://api.github.com/users/ThiefMaster/following{/other_user}",
                "gists_url": "https://api.github.com/users/ThiefMaster/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/ThiefMaster/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ThiefMaster/subscriptions",
                "organizations_url": "https://api.github.com/users/ThiefMaster/orgs",
                "repos_url": "https://api.github.com/users/ThiefMaster/repos",
                "events_url": "https://api.github.com/users/ThiefMaster/events{/privacy}",
                "received_events_url": "https://api.github.com/users/ThiefMaster/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2016-05-15T09:17:58Z",
            "updated_at": "2016-05-15T09:17:58Z",
            "author_association": "MEMBER",
            "body": "First of all, this kind of PR should be squashed into a single commit.\n\nThen, I'm not sure if it makes lots of sense to put this inside Flask - but certainly not as a part of `send_file` which means you need to change your application code to support nginx/X-Accel-Redir.\n\nThis could be done much better as a WSGI middleware where you setup a mapping between xsendfile/filesystem paths and URLs:\n\n``` python\nclass XAccelMiddleware(object):\n    \"\"\"A WSGI Middleware that converts X-Sendfile headers to X-Accel-Redirect\n    headers if possible.\n\n    If the path is not mapped to a URI usable for X-Sendfile we abort with an\n    error since it likely means there is a misconfiguration.\n    \"\"\"\n\n    def __init__(self, app, mapping):\n        self.app = app\n        self.mapping = mapping.items()\n\n    def __call__(self, environ, start_response):\n        def _start_response(status, headers, exc_info=None):\n            xsf_path = None\n            new_headers = []\n            for name, value in headers:\n                if name.lower() == 'x-sendfile':\n                    xsf_path = value\n                else:\n                    new_headers.append((name, value))\n            if xsf_path:\n                uri = self.make_x_accel_header(xsf_path)\n                if not uri:\n                    raise ValueError('Could not map %s to an URI' % xsf_path)\n                new_headers.append(('X-Accel-Redirect', uri))\n            return start_response(status, new_headers, exc_info)\n\n        return self.app(environ, _start_response)\n\n    def make_x_accel_header(self, path):\n        for base, uri in self.mapping:\n            if path.startswith(base + '/'):\n                return uri + path[len(base):]\n```\n\nThis doesn't even need changes in Flask, just one line in your application to add the middleware.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/219275616",
            "html_url": "https://github.com/pallets/flask/pull/1810#issuecomment-219275616",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1810",
            "id": 219275616,
            "node_id": "MDEyOklzc3VlQ29tbWVudDIxOTI3NTYxNg==",
            "user": {
                "login": "deelaka",
                "id": 13479441,
                "node_id": "MDQ6VXNlcjEzNDc5NDQx",
                "avatar_url": "https://avatars3.githubusercontent.com/u/13479441?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/deelaka",
                "html_url": "https://github.com/deelaka",
                "followers_url": "https://api.github.com/users/deelaka/followers",
                "following_url": "https://api.github.com/users/deelaka/following{/other_user}",
                "gists_url": "https://api.github.com/users/deelaka/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/deelaka/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/deelaka/subscriptions",
                "organizations_url": "https://api.github.com/users/deelaka/orgs",
                "repos_url": "https://api.github.com/users/deelaka/repos",
                "events_url": "https://api.github.com/users/deelaka/events{/privacy}",
                "received_events_url": "https://api.github.com/users/deelaka/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2016-05-15T09:41:08Z",
            "updated_at": "2016-05-15T09:41:08Z",
            "author_association": "NONE",
            "body": "@ThiefMaster yes this should've been squashed but what I don't get is why you insist implementing X-accel support through WSGI middleware? is it for some sort of performance reason? and most importantly why has this so called \"WSGI middleware for X-Accel\" support not yet implemented in flask or werkzeug?\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/219275937",
            "html_url": "https://github.com/pallets/flask/pull/1810#issuecomment-219275937",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1810",
            "id": 219275937,
            "node_id": "MDEyOklzc3VlQ29tbWVudDIxOTI3NTkzNw==",
            "user": {
                "login": "ThiefMaster",
                "id": 179599,
                "node_id": "MDQ6VXNlcjE3OTU5OQ==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/179599?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/ThiefMaster",
                "html_url": "https://github.com/ThiefMaster",
                "followers_url": "https://api.github.com/users/ThiefMaster/followers",
                "following_url": "https://api.github.com/users/ThiefMaster/following{/other_user}",
                "gists_url": "https://api.github.com/users/ThiefMaster/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/ThiefMaster/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ThiefMaster/subscriptions",
                "organizations_url": "https://api.github.com/users/ThiefMaster/orgs",
                "repos_url": "https://api.github.com/users/ThiefMaster/repos",
                "events_url": "https://api.github.com/users/ThiefMaster/events{/privacy}",
                "received_events_url": "https://api.github.com/users/ThiefMaster/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2016-05-15T09:49:23Z",
            "updated_at": "2016-05-15T09:49:23Z",
            "author_association": "MEMBER",
            "body": "I agree that it would make sense to add this middleware to Werkzeug or Flask; I simple never ended up doing it (since that also involves writing better documentation for it).\n\nIt's not really a performance thing but mostly about keeping the `send_file` API clean of webserver-specific code (`X-Sendfile` is much more generic since it just passes the filesystem path). Doing it on the WSGI level also makes sense since now it doesn't even need to know from where in the app the send-file request comes from - as soon as there's the header it'll handle it.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/219276173",
            "html_url": "https://github.com/pallets/flask/pull/1810#issuecomment-219276173",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1810",
            "id": 219276173,
            "node_id": "MDEyOklzc3VlQ29tbWVudDIxOTI3NjE3Mw==",
            "user": {
                "login": "deelaka",
                "id": 13479441,
                "node_id": "MDQ6VXNlcjEzNDc5NDQx",
                "avatar_url": "https://avatars3.githubusercontent.com/u/13479441?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/deelaka",
                "html_url": "https://github.com/deelaka",
                "followers_url": "https://api.github.com/users/deelaka/followers",
                "following_url": "https://api.github.com/users/deelaka/following{/other_user}",
                "gists_url": "https://api.github.com/users/deelaka/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/deelaka/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/deelaka/subscriptions",
                "organizations_url": "https://api.github.com/users/deelaka/orgs",
                "repos_url": "https://api.github.com/users/deelaka/repos",
                "events_url": "https://api.github.com/users/deelaka/events{/privacy}",
                "received_events_url": "https://api.github.com/users/deelaka/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2016-05-15T09:55:52Z",
            "updated_at": "2016-05-15T09:55:52Z",
            "author_association": "NONE",
            "body": "@ThiefMaster I agree, it is important to keep the code clean, and since that is a priority I'll close this pull request. But It'd be really helpful if you could provide insight on how to easily integrate your given `XAccelMiddleware` to a simple app such the `test app` I've posted above. :)\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/219276239",
            "html_url": "https://github.com/pallets/flask/pull/1810#issuecomment-219276239",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1810",
            "id": 219276239,
            "node_id": "MDEyOklzc3VlQ29tbWVudDIxOTI3NjIzOQ==",
            "user": {
                "login": "ThiefMaster",
                "id": 179599,
                "node_id": "MDQ6VXNlcjE3OTU5OQ==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/179599?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/ThiefMaster",
                "html_url": "https://github.com/ThiefMaster",
                "followers_url": "https://api.github.com/users/ThiefMaster/followers",
                "following_url": "https://api.github.com/users/ThiefMaster/following{/other_user}",
                "gists_url": "https://api.github.com/users/ThiefMaster/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/ThiefMaster/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ThiefMaster/subscriptions",
                "organizations_url": "https://api.github.com/users/ThiefMaster/orgs",
                "repos_url": "https://api.github.com/users/ThiefMaster/repos",
                "events_url": "https://api.github.com/users/ThiefMaster/events{/privacy}",
                "received_events_url": "https://api.github.com/users/ThiefMaster/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2016-05-15T09:57:37Z",
            "updated_at": "2016-05-15T09:57:37Z",
            "author_association": "MEMBER",
            "body": "```\napp.wsgi_app = XAccelMiddleware(app.wsgi_app, app.config['X_ACCEL_MAP'])\n```\n\nThen simply add a dict called `X_ACCEL_MAP` to your config mapping filesystem paths to URLs as setup in the nginx config.\n"
        }
    ]
}
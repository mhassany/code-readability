{
    "url": "https://api.github.com/repos/pallets/flask/issues/2546",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/2546/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/2546/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/2546/events",
    "html_url": "https://github.com/pallets/flask/issues/2546",
    "id": 280198958,
    "node_id": "MDU6SXNzdWUyODAxOTg5NTg=",
    "number": 2546,
    "title": "send_from_directory() and send_file() fails on Windows",
    "user": {
        "login": "kuba-baku",
        "id": 23497198,
        "node_id": "MDQ6VXNlcjIzNDk3MTk4",
        "avatar_url": "https://avatars3.githubusercontent.com/u/23497198?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kuba-baku",
        "html_url": "https://github.com/kuba-baku",
        "followers_url": "https://api.github.com/users/kuba-baku/followers",
        "following_url": "https://api.github.com/users/kuba-baku/following{/other_user}",
        "gists_url": "https://api.github.com/users/kuba-baku/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/kuba-baku/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/kuba-baku/subscriptions",
        "organizations_url": "https://api.github.com/users/kuba-baku/orgs",
        "repos_url": "https://api.github.com/users/kuba-baku/repos",
        "events_url": "https://api.github.com/users/kuba-baku/events{/privacy}",
        "received_events_url": "https://api.github.com/users/kuba-baku/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 4,
    "created_at": "2017-12-07T16:43:17Z",
    "updated_at": "2019-05-17T23:57:26Z",
    "closed_at": "2017-12-07T17:06:13Z",
    "author_association": "NONE",
    "body": "On Windows send_from_directory() fails because posix path from safe_join() and Windows path from current_app.root_path gets mixed up.\r\n\r\nI see problem in this line:\r\nhttps://github.com/pallets/flask/blob/eb1c2faf9f1fd785616203dc00f6dd680682dc38/flask/helpers.py#L691\r\nE.g. running app from C:\\PythonApps\\FlaskApp: \r\n```python\r\nsend_from_directory(\"instance/data\", \"file1.txt\")\r\nfilename = safe_join(directory, filename)\r\n# filename == \"instance/data/file1.txt\"\r\nif not os.path.isabs(filename):\r\n        filename = os.path.join(current_app.root_path, filename)\r\n        # here's the problem -> filename == \"C:\\\\PythonApps\\\\FlaskApp\\\\instance/data/file1.txt\"\r\n    try:\r\n        if not os.path.isfile(filename):\r\n            # here it fails\r\n            raise NotFound()\r\n```\r\nReturning posix path from safe join is imo ok (see #2284) but joining with non posix path fails.\r\nI think solution can be using os.path.normpath after joining path parts:\r\n```python\r\nfilename = os.path.normpath(os.path.join(current_app.root_path, filename))\r\n```\r\nSame problem is with send_file():\r\nhttps://github.com/pallets/flask/blob/d08d96acbcabcde23307ed060f71f95ba9cb7b8d/flask/helpers.py#L520\r\n\r\n### Environment\r\n\r\n* Python version 3.5.4:\r\n* Flask version 0.12.2:\r\n* Werkzeug version 0.12.2:\r\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/350030548",
            "html_url": "https://github.com/pallets/flask/issues/2546#issuecomment-350030548",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2546",
            "id": 350030548,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM1MDAzMDU0OA==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2017-12-07T17:02:18Z",
            "updated_at": "2017-12-07T17:02:18Z",
            "author_association": "MEMBER",
            "body": "Does serving static files work?"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/350031454",
            "html_url": "https://github.com/pallets/flask/issues/2546#issuecomment-350031454",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2546",
            "id": 350031454,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM1MDAzMTQ1NA==",
            "user": {
                "login": "kuba-baku",
                "id": 23497198,
                "node_id": "MDQ6VXNlcjIzNDk3MTk4",
                "avatar_url": "https://avatars3.githubusercontent.com/u/23497198?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/kuba-baku",
                "html_url": "https://github.com/kuba-baku",
                "followers_url": "https://api.github.com/users/kuba-baku/followers",
                "following_url": "https://api.github.com/users/kuba-baku/following{/other_user}",
                "gists_url": "https://api.github.com/users/kuba-baku/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/kuba-baku/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/kuba-baku/subscriptions",
                "organizations_url": "https://api.github.com/users/kuba-baku/orgs",
                "repos_url": "https://api.github.com/users/kuba-baku/repos",
                "events_url": "https://api.github.com/users/kuba-baku/events{/privacy}",
                "received_events_url": "https://api.github.com/users/kuba-baku/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2017-12-07T17:05:25Z",
            "updated_at": "2017-12-07T17:05:25Z",
            "author_association": "NONE",
            "body": "Eh, sorry, it's a problem between my keyboard and chair.\r\nI just tried some workarounds and nothing helped and then I saw, that I had the folder in wrong location (one level up from app's root path)."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/350031699",
            "html_url": "https://github.com/pallets/flask/issues/2546#issuecomment-350031699",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2546",
            "id": 350031699,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM1MDAzMTY5OQ==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2017-12-07T17:06:13Z",
            "updated_at": "2017-12-07T17:06:13Z",
            "author_association": "MEMBER",
            "body": "Yeah, it's a bit unfortunate that the path mixes back and forward slashes, but Python on Windows should be able to handle that without intervention."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/493629674",
            "html_url": "https://github.com/pallets/flask/issues/2546#issuecomment-493629674",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2546",
            "id": 493629674,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ5MzYyOTY3NA==",
            "user": {
                "login": "sbarzowski",
                "id": 683828,
                "node_id": "MDQ6VXNlcjY4MzgyOA==",
                "avatar_url": "https://avatars2.githubusercontent.com/u/683828?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/sbarzowski",
                "html_url": "https://github.com/sbarzowski",
                "followers_url": "https://api.github.com/users/sbarzowski/followers",
                "following_url": "https://api.github.com/users/sbarzowski/following{/other_user}",
                "gists_url": "https://api.github.com/users/sbarzowski/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/sbarzowski/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/sbarzowski/subscriptions",
                "organizations_url": "https://api.github.com/users/sbarzowski/orgs",
                "repos_url": "https://api.github.com/users/sbarzowski/repos",
                "events_url": "https://api.github.com/users/sbarzowski/events{/privacy}",
                "received_events_url": "https://api.github.com/users/sbarzowski/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-05-17T23:54:26Z",
            "updated_at": "2019-05-17T23:57:26Z",
            "author_association": "NONE",
            "body": "Sorry for reviving an old issue, but I'm having a very similar problem on `1.0.3` and perhaps the context here could be relevant. When migrating some code to Windows I found out that the following results in 404 for me:\r\n```\r\n    response = flask.send_from_directory('D:\\\\Work\\\\x\\\\blah', 'a\\\\b\\\\c\\\\d.jpg')\r\n```\r\nBut this works:\r\n```\r\n    response = flask.send_from_directory('D:\\\\Work\\\\x\\\\blah', 'a/b/c/d.jpg')\r\n```\r\n\r\nThe only difference is slashes vs backslashes in the filename part. \r\n\r\nI think this is so, because in `safe_join` this function doesn't do anything with the backslashes: https://github.com/pallets/flask/blob/1.0.3/flask/helpers.py#L669 and here there's a check for any non-forward-slash separators: https://github.com/pallets/flask/blob/1.0.3/flask/helpers.py#L672"
        }
    ]
}
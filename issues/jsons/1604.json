{
    "url": "https://api.github.com/repos/pallets/flask/issues/1604",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/1604/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/1604/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/1604/events",
    "html_url": "https://github.com/pallets/flask/issues/1604",
    "id": 114637068,
    "node_id": "MDU6SXNzdWUxMTQ2MzcwNjg=",
    "number": 1604,
    "title": "OPTIONS requests sometimes match the wrong url_rule if there are multiple route handlers for different methods",
    "user": {
        "login": "ahuling13",
        "id": 174270,
        "node_id": "MDQ6VXNlcjE3NDI3MA==",
        "avatar_url": "https://avatars3.githubusercontent.com/u/174270?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ahuling13",
        "html_url": "https://github.com/ahuling13",
        "followers_url": "https://api.github.com/users/ahuling13/followers",
        "following_url": "https://api.github.com/users/ahuling13/following{/other_user}",
        "gists_url": "https://api.github.com/users/ahuling13/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/ahuling13/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ahuling13/subscriptions",
        "organizations_url": "https://api.github.com/users/ahuling13/orgs",
        "repos_url": "https://api.github.com/users/ahuling13/repos",
        "events_url": "https://api.github.com/users/ahuling13/events{/privacy}",
        "received_events_url": "https://api.github.com/users/ahuling13/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 5,
    "created_at": "2015-11-02T16:57:17Z",
    "updated_at": "2018-01-04T21:48:53Z",
    "closed_at": "2018-01-04T21:48:41Z",
    "author_association": "NONE",
    "body": "I have multiple route handlers with the same path but with different methods that they handles, e.g.\n\n```\n@app.route('/users', methods=['GET'])\n@app.route('/users', methods=['POST'])\n```\n\nThe problem occurs when a CORS pre-flight OPTIONS request is made to `/users`. Since the route and method match both endpoints, the wrong endpoint is sometimes returned which is problematic if you are trying to use the matched `url_rule` for any logic. In my case, I was using `request.url_rule.methods` to add the `Access-Control-Allow-Methods` header to the response.\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/153083690",
            "html_url": "https://github.com/pallets/flask/issues/1604#issuecomment-153083690",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1604",
            "id": 153083690,
            "node_id": "MDEyOklzc3VlQ29tbWVudDE1MzA4MzY5MA==",
            "user": {
                "login": "mitsuhiko",
                "id": 7396,
                "node_id": "MDQ6VXNlcjczOTY=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/7396?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/mitsuhiko",
                "html_url": "https://github.com/mitsuhiko",
                "followers_url": "https://api.github.com/users/mitsuhiko/followers",
                "following_url": "https://api.github.com/users/mitsuhiko/following{/other_user}",
                "gists_url": "https://api.github.com/users/mitsuhiko/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/mitsuhiko/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mitsuhiko/subscriptions",
                "organizations_url": "https://api.github.com/users/mitsuhiko/orgs",
                "repos_url": "https://api.github.com/users/mitsuhiko/repos",
                "events_url": "https://api.github.com/users/mitsuhiko/events{/privacy}",
                "received_events_url": "https://api.github.com/users/mitsuhiko/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2015-11-02T17:02:42Z",
            "updated_at": "2015-11-02T17:02:42Z",
            "author_association": "MEMBER",
            "body": "Can you please provide a testcase?\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/218673145",
            "html_url": "https://github.com/pallets/flask/issues/1604#issuecomment-218673145",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1604",
            "id": 218673145,
            "node_id": "MDEyOklzc3VlQ29tbWVudDIxODY3MzE0NQ==",
            "user": {
                "login": "vladimirze",
                "id": 541764,
                "node_id": "MDQ6VXNlcjU0MTc2NA==",
                "avatar_url": "https://avatars2.githubusercontent.com/u/541764?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/vladimirze",
                "html_url": "https://github.com/vladimirze",
                "followers_url": "https://api.github.com/users/vladimirze/followers",
                "following_url": "https://api.github.com/users/vladimirze/following{/other_user}",
                "gists_url": "https://api.github.com/users/vladimirze/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/vladimirze/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vladimirze/subscriptions",
                "organizations_url": "https://api.github.com/users/vladimirze/orgs",
                "repos_url": "https://api.github.com/users/vladimirze/repos",
                "events_url": "https://api.github.com/users/vladimirze/events{/privacy}",
                "received_events_url": "https://api.github.com/users/vladimirze/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2016-05-12T06:42:00Z",
            "updated_at": "2016-05-12T06:42:00Z",
            "author_association": "NONE",
            "body": "I had similar issue, I thought `request.url_rule.methods` will return _combined_ list of allowed methods for `/users` resource but instead it returns allowed methods for current handler function.\n\nI'm not sure why 'the wrong endpoint is _sometimes_ returned', for me its always the endpoint that was defined first in the source code, so in your case, OPTIONS always would been handled by:\n`@app.route('/users', methods=['GET'])`\n\nThere is a snippet that shows CORS implementation as decorator: http://flask.pocoo.org/snippets/56/\nIf we look at `get_methods()` function:\n\n```\n    def get_methods():\n        if methods is not None:\n            return methods\n\n        options_resp = current_app.make_default_options_response()\n        return options_resp.headers['allow']\n```\n\nAt first, default OPTIONS response is created using `make_default_options_response()` function, this is the response that flask returns by default if OPTIONS is not overwritten (so you don't have to handle OPTIONS each time you create a route).\n\nWhat happens next is that we take 'allow' header and return its value.\n'allow' header (https://github.com/pallets/werkzeug/blob/b5eb6415232df923f157a31558c52385beb72897/werkzeug/wrappers.py#L1799) contains string of all allowed methods for this endpoint, in your case it will be 'GET, POST' which is exactly what you need - list of all allowed methods that the server willing to accept for '/users' endpoint. \n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/219500664",
            "html_url": "https://github.com/pallets/flask/issues/1604#issuecomment-219500664",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1604",
            "id": 219500664,
            "node_id": "MDEyOklzc3VlQ29tbWVudDIxOTUwMDY2NA==",
            "user": {
                "login": "ahuling13",
                "id": 174270,
                "node_id": "MDQ6VXNlcjE3NDI3MA==",
                "avatar_url": "https://avatars3.githubusercontent.com/u/174270?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/ahuling13",
                "html_url": "https://github.com/ahuling13",
                "followers_url": "https://api.github.com/users/ahuling13/followers",
                "following_url": "https://api.github.com/users/ahuling13/following{/other_user}",
                "gists_url": "https://api.github.com/users/ahuling13/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/ahuling13/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ahuling13/subscriptions",
                "organizations_url": "https://api.github.com/users/ahuling13/orgs",
                "repos_url": "https://api.github.com/users/ahuling13/repos",
                "events_url": "https://api.github.com/users/ahuling13/events{/privacy}",
                "received_events_url": "https://api.github.com/users/ahuling13/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2016-05-16T18:11:36Z",
            "updated_at": "2016-05-16T18:11:36Z",
            "author_association": "NONE",
            "body": "Looks great -- I'll give it a shot. Thank you!\n\nRe: the wrong endpoint sometimes being returned, I just meant that the only time the right endpoint is returned is when you are requesting the endpoint defined first in the source code. Then the \"right\" endpoint is returned. Otherwise, the wrong endpoint (the first one) is returned.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/223701057",
            "html_url": "https://github.com/pallets/flask/issues/1604#issuecomment-223701057",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1604",
            "id": 223701057,
            "node_id": "MDEyOklzc3VlQ29tbWVudDIyMzcwMTA1Nw==",
            "user": {
                "login": "jeffwidman",
                "id": 483314,
                "node_id": "MDQ6VXNlcjQ4MzMxNA==",
                "avatar_url": "https://avatars2.githubusercontent.com/u/483314?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/jeffwidman",
                "html_url": "https://github.com/jeffwidman",
                "followers_url": "https://api.github.com/users/jeffwidman/followers",
                "following_url": "https://api.github.com/users/jeffwidman/following{/other_user}",
                "gists_url": "https://api.github.com/users/jeffwidman/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/jeffwidman/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jeffwidman/subscriptions",
                "organizations_url": "https://api.github.com/users/jeffwidman/orgs",
                "repos_url": "https://api.github.com/users/jeffwidman/repos",
                "events_url": "https://api.github.com/users/jeffwidman/events{/privacy}",
                "received_events_url": "https://api.github.com/users/jeffwidman/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2016-06-03T21:38:03Z",
            "updated_at": "2016-06-03T21:43:58Z",
            "author_association": "MEMBER",
            "body": "I suspect this is related to #1783 with the root cause being https://github.com/pallets/werkzeug/pull/907\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/355408458",
            "html_url": "https://github.com/pallets/flask/issues/1604#issuecomment-355408458",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1604",
            "id": 355408458,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM1NTQwODQ1OA==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-01-04T21:48:41Z",
            "updated_at": "2018-01-04T21:48:53Z",
            "author_association": "MEMBER",
            "body": "Sounds like the specific use case described here is already handled by the default options response, which can be overridden with `Flask.make_default_options_response`. Also, pallets/werkzeug#1137 fixed some issues with path weights including those linked by Jeff, although I'm not sure if those were actually related.\r\n  "
        }
    ]
}
{
    "url": "https://api.github.com/repos/pallets/flask/issues/3383",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/3383/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/3383/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/3383/events",
    "html_url": "https://github.com/pallets/flask/issues/3383",
    "id": 504251346,
    "node_id": "MDU6SXNzdWU1MDQyNTEzNDY=",
    "number": 3383,
    "title": "Flask caching allowing unauthenticated users to see files that should be protected",
    "user": {
        "login": "elamje",
        "id": 14875933,
        "node_id": "MDQ6VXNlcjE0ODc1OTMz",
        "avatar_url": "https://avatars1.githubusercontent.com/u/14875933?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/elamje",
        "html_url": "https://github.com/elamje",
        "followers_url": "https://api.github.com/users/elamje/followers",
        "following_url": "https://api.github.com/users/elamje/following{/other_user}",
        "gists_url": "https://api.github.com/users/elamje/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/elamje/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/elamje/subscriptions",
        "organizations_url": "https://api.github.com/users/elamje/orgs",
        "repos_url": "https://api.github.com/users/elamje/repos",
        "events_url": "https://api.github.com/users/elamje/events{/privacy}",
        "received_events_url": "https://api.github.com/users/elamje/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2019-10-08T20:06:33Z",
    "updated_at": "2019-10-12T04:19:19Z",
    "closed_at": "2019-10-08T20:08:21Z",
    "author_association": "NONE",
    "body": "<!-- **This issue tracker is a tool to address bugs in Flask itself.\r\nPlease use the #pocoo IRC channel on freenode or Stack Overflow for general\r\nquestions about using Flask or issues not related to Flask.** -->\r\n\r\n<!-- If you'd like to report a bug in Flask, fill out the template below. Provide\r\nany extra information that may be useful / related to your problem.\r\nIdeally, create an [MCVE](https://stackoverflow.com/help/mcve), which helps us\r\nunderstand the problem and helps check that it is not caused by something in\r\nyour code. -->\r\n\r\n\r\n\r\n### Expected Behavior\r\n<!-- Tell us what should happen. -->\r\nUsers are authenticated with flask-login, and should only be able to view files that they upload. `current_user.uuid` stores a unique directory for their uploads to go to so that unauthenticated users cannot access a specific users uploaded files. \r\n\r\n```python\r\n@app.route('/show/<filename>')\r\n@login_required\r\ndef show(filename: str) -> Union[Response, str]:\r\n    print('show hit')\r\n    filename = secure_filename(filename)  # clean user input\r\n    user_dir = os.path.join(app.config['UPLOAD_FOLDER'], current_user.uuid)\r\n    if os.path.exists(os.path.join(user_dir, filename)):\r\n        return send_from_directory(directory=user_dir, filename=filename)\r\n    else:\r\n        abort(404)\r\n```\r\n\r\n### Actual Behavior\r\n<!-- Tell us what happens instead. -->\r\nI can visit the `show/x.png` url and I will be able to see x.png regardless of my authentication status. \r\n\r\nThe strange thing is that in production (Nginx, Dokku, gunicorn), the `show/x.png` request never hits the flask app, possibly cached? (Nginx doesn't have caching set up, Gunicorn doesn't cache, so not sure what's happening, not my browser cache either)\r\n\r\nLocally, I can reproduce this as well, even when I'm confident there is no browser caching going on. \r\n\r\n### Environment\r\n\r\n* Python version: 3.7\r\n* Flask version: 1.1.1\r\n* Werkzeug version: 0.15.5\r\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/539680978",
            "html_url": "https://github.com/pallets/flask/issues/3383#issuecomment-539680978",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3383",
            "id": 539680978,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUzOTY4MDk3OA==",
            "user": {
                "login": "ThiefMaster",
                "id": 179599,
                "node_id": "MDQ6VXNlcjE3OTU5OQ==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/179599?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/ThiefMaster",
                "html_url": "https://github.com/ThiefMaster",
                "followers_url": "https://api.github.com/users/ThiefMaster/followers",
                "following_url": "https://api.github.com/users/ThiefMaster/following{/other_user}",
                "gists_url": "https://api.github.com/users/ThiefMaster/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/ThiefMaster/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ThiefMaster/subscriptions",
                "organizations_url": "https://api.github.com/users/ThiefMaster/orgs",
                "repos_url": "https://api.github.com/users/ThiefMaster/repos",
                "events_url": "https://api.github.com/users/ThiefMaster/events{/privacy}",
                "received_events_url": "https://api.github.com/users/ThiefMaster/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-10-08T20:07:38Z",
            "updated_at": "2019-10-08T20:07:38Z",
            "author_association": "MEMBER",
            "body": "Flask does not cache anything, so it must be somewhere in your environment..."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/539681276",
            "html_url": "https://github.com/pallets/flask/issues/3383#issuecomment-539681276",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3383",
            "id": 539681276,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUzOTY4MTI3Ng==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-10-08T20:08:21Z",
            "updated_at": "2019-10-08T20:12:37Z",
            "author_association": "MEMBER",
            "body": "I think what you're saying is that if a user logs in, downloads a file that the browser caches, and logs out, another user will be able to view that file if the cache has not expired. That's down to configuring caching for the file, which `send_from_directory`, `send_file`, and `response.cache_control` already allow you to do, and which the example you've shown is not doing."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/541283097",
            "html_url": "https://github.com/pallets/flask/issues/3383#issuecomment-541283097",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3383",
            "id": 541283097,
            "node_id": "MDEyOklzc3VlQ29tbWVudDU0MTI4MzA5Nw==",
            "user": {
                "login": "elamje",
                "id": 14875933,
                "node_id": "MDQ6VXNlcjE0ODc1OTMz",
                "avatar_url": "https://avatars1.githubusercontent.com/u/14875933?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/elamje",
                "html_url": "https://github.com/elamje",
                "followers_url": "https://api.github.com/users/elamje/followers",
                "following_url": "https://api.github.com/users/elamje/following{/other_user}",
                "gists_url": "https://api.github.com/users/elamje/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/elamje/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/elamje/subscriptions",
                "organizations_url": "https://api.github.com/users/elamje/orgs",
                "repos_url": "https://api.github.com/users/elamje/repos",
                "events_url": "https://api.github.com/users/elamje/events{/privacy}",
                "received_events_url": "https://api.github.com/users/elamje/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-10-12T04:19:19Z",
            "updated_at": "2019-10-12T04:19:19Z",
            "author_association": "NONE",
            "body": "Thanks for the explanation. Long story short, I was banging my head against the wall thinking of every layer of my app with no avail, hence why I created this issue. Unfortunately I missed that Cloudflare was caching everything, so it wasn't even code \ud83e\udd26\u200d\u2642 . "
        }
    ]
}
{
    "url": "https://api.github.com/repos/pallets/flask/issues/1094",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/1094/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/1094/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/1094/events",
    "html_url": "https://github.com/pallets/flask/issues/1094",
    "id": 36101945,
    "node_id": "MDU6SXNzdWUzNjEwMTk0NQ==",
    "number": 1094,
    "title": "Issue with deferred callbacks pattern when an exception occurs in a @teardown_request decorated function",
    "user": {
        "login": "aegarbutt",
        "id": 1959675,
        "node_id": "MDQ6VXNlcjE5NTk2NzU=",
        "avatar_url": "https://avatars3.githubusercontent.com/u/1959675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/aegarbutt",
        "html_url": "https://github.com/aegarbutt",
        "followers_url": "https://api.github.com/users/aegarbutt/followers",
        "following_url": "https://api.github.com/users/aegarbutt/following{/other_user}",
        "gists_url": "https://api.github.com/users/aegarbutt/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/aegarbutt/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/aegarbutt/subscriptions",
        "organizations_url": "https://api.github.com/users/aegarbutt/orgs",
        "repos_url": "https://api.github.com/users/aegarbutt/repos",
        "events_url": "https://api.github.com/users/aegarbutt/events{/privacy}",
        "received_events_url": "https://api.github.com/users/aegarbutt/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 2,
    "created_at": "2014-06-19T17:55:38Z",
    "updated_at": "2017-05-29T21:41:44Z",
    "closed_at": "2017-05-29T21:41:44Z",
    "author_association": "NONE",
    "body": "We recently stumbled across an issue with the @after_this_request decorator deferred callback pattern (described at http://flask.pocoo.org/docs/patterns/deferredcallbacks/).\n\nThis issue does not occur in v0.9, but does occur in v0.10 and v0.10.1. The issue also does not occur when using the @after_this_request decorator defined in 'flask/ctx.py'.\n\nIf an exception occurs in a function decorated with @teardown_request, any callback added with the @after_this_request decorator copied from the pattern will continue to be executed on subsequent requests. This occurs when running standalone:\n\n  $ python flask_teardown_exception.py\n\nand when running under uwsgi:\n\n  $ uwsgi --yaml uwsgi.yaml (Be sure to correct paths if you want to use this)\n\nWe realize that @teardown_request documentation indicates that one should be careful never to throw an exception, but the end result was still very surprising.\n\nA minimal testcase can be found in the github repo referenced at the bottom. It defines two functions to be executed after the current request. One using the built-in decorator, and one using the pattern and code sample. Both functions add a header to the response indicating the handling processID and an incrementing request ID. An exception can be triggered in the @teardown_request function by passing any value to the \"e\" GET parameter. After an exception is triggered, the built-in @after_this_request continues to work as expected an all subsequent requests that do not throw an exception. However, the functions added with the custom @after_this_request decorator following the pattern code sample continue to execute for all subsequent requests. For example, if I trigger an exception on request 6, and make 4 more requests, then the second to last request (request 9) will have the headers for request 6 ,7, 8 and 9; and the last request (request 10) will have the headers for request 6, 7, 8, 9 and 10.\n\nThe github repo also includes console output running under both uwsgi and standalone, and HTTP request/response pairs for 10 requests showing the outcome.\n\nhttps://github.com/aegarbutt/teardown_request_exception\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/92894393",
            "html_url": "https://github.com/pallets/flask/issues/1094#issuecomment-92894393",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1094",
            "id": 92894393,
            "node_id": "MDEyOklzc3VlQ29tbWVudDkyODk0Mzkz",
            "user": {
                "login": "vlmphipps",
                "id": 103690,
                "node_id": "MDQ6VXNlcjEwMzY5MA==",
                "avatar_url": "https://avatars0.githubusercontent.com/u/103690?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/vlmphipps",
                "html_url": "https://github.com/vlmphipps",
                "followers_url": "https://api.github.com/users/vlmphipps/followers",
                "following_url": "https://api.github.com/users/vlmphipps/following{/other_user}",
                "gists_url": "https://api.github.com/users/vlmphipps/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/vlmphipps/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/vlmphipps/subscriptions",
                "organizations_url": "https://api.github.com/users/vlmphipps/orgs",
                "repos_url": "https://api.github.com/users/vlmphipps/repos",
                "events_url": "https://api.github.com/users/vlmphipps/events{/privacy}",
                "received_events_url": "https://api.github.com/users/vlmphipps/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2015-04-14T15:05:30Z",
            "updated_at": "2015-04-14T15:05:30Z",
            "author_association": "NONE",
            "body": "Given the issues I found when @teardown_appcontext raises (http://stackoverflow.com/questions/23301968/invalid-transaction-persisting-across-requests), I would use the wrapper there to make sure teardown functions never raise. I'm planning to open a PR against the Flask docs to emphasize this, since I certainly didn't think it was as big a deal as it is when I first encountered problems with teardown functions.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/205718905",
            "html_url": "https://github.com/pallets/flask/issues/1094#issuecomment-205718905",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1094",
            "id": 205718905,
            "node_id": "MDEyOklzc3VlQ29tbWVudDIwNTcxODkwNQ==",
            "user": {
                "login": "jeffwidman",
                "id": 483314,
                "node_id": "MDQ6VXNlcjQ4MzMxNA==",
                "avatar_url": "https://avatars2.githubusercontent.com/u/483314?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/jeffwidman",
                "html_url": "https://github.com/jeffwidman",
                "followers_url": "https://api.github.com/users/jeffwidman/followers",
                "following_url": "https://api.github.com/users/jeffwidman/following{/other_user}",
                "gists_url": "https://api.github.com/users/jeffwidman/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/jeffwidman/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jeffwidman/subscriptions",
                "organizations_url": "https://api.github.com/users/jeffwidman/orgs",
                "repos_url": "https://api.github.com/users/jeffwidman/repos",
                "events_url": "https://api.github.com/users/jeffwidman/events{/privacy}",
                "received_events_url": "https://api.github.com/users/jeffwidman/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2016-04-05T08:42:22Z",
            "updated_at": "2016-04-05T08:42:22Z",
            "author_association": "MEMBER",
            "body": "See also #1767\n"
        }
    ]
}
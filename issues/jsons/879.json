{
    "url": "https://api.github.com/repos/pallets/flask/issues/879",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/879/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/879/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/879/events",
    "html_url": "https://github.com/pallets/flask/issues/879",
    "id": 20459057,
    "node_id": "MDU6SXNzdWUyMDQ1OTA1Nw==",
    "number": 879,
    "title": "before_app_first_request strange behaviour",
    "user": {
        "login": "zvin",
        "id": 180331,
        "node_id": "MDQ6VXNlcjE4MDMzMQ==",
        "avatar_url": "https://avatars2.githubusercontent.com/u/180331?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/zvin",
        "html_url": "https://github.com/zvin",
        "followers_url": "https://api.github.com/users/zvin/followers",
        "following_url": "https://api.github.com/users/zvin/following{/other_user}",
        "gists_url": "https://api.github.com/users/zvin/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/zvin/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/zvin/subscriptions",
        "organizations_url": "https://api.github.com/users/zvin/orgs",
        "repos_url": "https://api.github.com/users/zvin/repos",
        "events_url": "https://api.github.com/users/zvin/events{/privacy}",
        "received_events_url": "https://api.github.com/users/zvin/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2013-10-03T14:57:11Z",
    "updated_at": "2014-02-09T13:27:12Z",
    "closed_at": "2014-02-09T13:27:12Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hello,\n\nWhen you set an initialization function with the before_app_first_request decorator you expect this function to be launched once **before** the first request.\n\nBut, if this function takes some time to execute, flask may respond to requests before it has finished.\n\nHere is the code of Flask.try_trigger_before_first_request_functions(self)\n\n``` python\nif self._got_first_request:\n    return\nwith self._before_request_lock:\n    if self._got_first_request:\n        return\n    self._got_first_request = True\n    for func in self.before_first_request_funcs:\n        func()\n```\n\nNow, imagine 2 concurrent requests when the server starts:\n- the first one takes the lock and sets _got_first_request to True BEFORE calling functions in self.before_first_request_funcs\n- the second sees that _got_first_request is True and returns\n\nThe fix is simple: just put self._got_first_request = True after the calls to functions in self.before_first_request_funcs.\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/25799894",
            "html_url": "https://github.com/pallets/flask/issues/879#issuecomment-25799894",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/879",
            "id": 25799894,
            "node_id": "MDEyOklzc3VlQ29tbWVudDI1Nzk5ODk0",
            "user": {
                "login": "markunsworth",
                "id": 133945,
                "node_id": "MDQ6VXNlcjEzMzk0NQ==",
                "avatar_url": "https://avatars2.githubusercontent.com/u/133945?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/markunsworth",
                "html_url": "https://github.com/markunsworth",
                "followers_url": "https://api.github.com/users/markunsworth/followers",
                "following_url": "https://api.github.com/users/markunsworth/following{/other_user}",
                "gists_url": "https://api.github.com/users/markunsworth/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/markunsworth/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/markunsworth/subscriptions",
                "organizations_url": "https://api.github.com/users/markunsworth/orgs",
                "repos_url": "https://api.github.com/users/markunsworth/repos",
                "events_url": "https://api.github.com/users/markunsworth/events{/privacy}",
                "received_events_url": "https://api.github.com/users/markunsworth/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2013-10-07T11:00:37Z",
            "updated_at": "2013-10-07T11:00:57Z",
            "author_association": "NONE",
            "body": "This will also fix an issue which I have been experiencing where an initialisation (in my case to create a flask.pymongo instance) fails and throws an exception. Because `self._got_first_request` has been set the initialisation never gets called again and any initialisations that came after the one that failed also won't get called.\n\nThe other option in this case would be to use a try except block and set `self._got_first_request` back to false in the case of any exception, but it would be unnecessary when 536c948 should fix this\n"
        }
    ]
}
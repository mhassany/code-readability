{
    "url": "https://api.github.com/repos/pallets/flask/issues/3360",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/3360/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/3360/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/3360/events",
    "html_url": "https://github.com/pallets/flask/pull/3360",
    "id": 491673149,
    "node_id": "MDExOlB1bGxSZXF1ZXN0MzE1OTk1MTQ4",
    "number": 3360,
    "title": "Add feature flask.cli.with_testrequestcontext,",
    "user": {
        "login": "MaicoTimmerman",
        "id": 904824,
        "node_id": "MDQ6VXNlcjkwNDgyNA==",
        "avatar_url": "https://avatars3.githubusercontent.com/u/904824?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MaicoTimmerman",
        "html_url": "https://github.com/MaicoTimmerman",
        "followers_url": "https://api.github.com/users/MaicoTimmerman/followers",
        "following_url": "https://api.github.com/users/MaicoTimmerman/following{/other_user}",
        "gists_url": "https://api.github.com/users/MaicoTimmerman/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/MaicoTimmerman/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/MaicoTimmerman/subscriptions",
        "organizations_url": "https://api.github.com/users/MaicoTimmerman/orgs",
        "repos_url": "https://api.github.com/users/MaicoTimmerman/repos",
        "events_url": "https://api.github.com/users/MaicoTimmerman/events{/privacy}",
        "received_events_url": "https://api.github.com/users/MaicoTimmerman/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 5,
    "created_at": "2019-09-10T13:29:09Z",
    "updated_at": "2019-09-10T17:08:25Z",
    "closed_at": "2019-09-10T14:25:05Z",
    "author_association": "NONE",
    "pull_request": {
        "url": "https://api.github.com/repos/pallets/flask/pulls/3360",
        "html_url": "https://github.com/pallets/flask/pull/3360",
        "diff_url": "https://github.com/pallets/flask/pull/3360.diff",
        "patch_url": "https://github.com/pallets/flask/pull/3360.patch"
    },
    "body": "For a project of mine I had the need to have a request context available in a cli command. This PR adds the code used, together with test and relevant code.\r\n\r\nI have not added the ``versionadded`` yet, should it contain 1.1.2?\r\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/529950093",
            "html_url": "https://github.com/pallets/flask/pull/3360#issuecomment-529950093",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3360",
            "id": 529950093,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUyOTk1MDA5Mw==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-09-10T14:02:55Z",
            "updated_at": "2019-09-10T14:06:20Z",
            "author_association": "MEMBER",
            "body": "I don't think I want to include this, using a request context during something that's not request-like is a bad pattern to enable. Things outside requests should only require the app context. For example, in the test you've shown, it would make more sense to extract the report logic from the view that generates it, so it can be called independently of being in a request, such as by passing CLI options.\r\n\r\n```python\r\ndef make_report(year):\r\n    # work\r\n    return report\r\n\r\n@app.cli.command('report')\r\n@click.option(\"--year\", default=date.today().year)\r\ndef report_command(year):\r\n    report = make_report(year)\r\n    report.save()\r\n\r\n@app.route(\"/report/<year>\")\r\ndef show_report(year):\r\n    report = make_report(year)\r\n    return report.to_html()\r\n```\r\n\r\nIf it's not something you can change, you can already get a request context without another decorator (or at least a simpler decorator) by using `with_appcontext` and `current_app`:\r\n\r\n```python\r\n@app.cli.command('report')\r\n@with_appcontext\r\ndef report_command():\r\n    with current_app.test_request_context():\r\n        # report stuff\r\n```"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/529960385",
            "html_url": "https://github.com/pallets/flask/pull/3360#issuecomment-529960385",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3360",
            "id": 529960385,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUyOTk2MDM4NQ==",
            "user": {
                "login": "MaicoTimmerman",
                "id": 904824,
                "node_id": "MDQ6VXNlcjkwNDgyNA==",
                "avatar_url": "https://avatars3.githubusercontent.com/u/904824?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/MaicoTimmerman",
                "html_url": "https://github.com/MaicoTimmerman",
                "followers_url": "https://api.github.com/users/MaicoTimmerman/followers",
                "following_url": "https://api.github.com/users/MaicoTimmerman/following{/other_user}",
                "gists_url": "https://api.github.com/users/MaicoTimmerman/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/MaicoTimmerman/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/MaicoTimmerman/subscriptions",
                "organizations_url": "https://api.github.com/users/MaicoTimmerman/orgs",
                "repos_url": "https://api.github.com/users/MaicoTimmerman/repos",
                "events_url": "https://api.github.com/users/MaicoTimmerman/events{/privacy}",
                "received_events_url": "https://api.github.com/users/MaicoTimmerman/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-09-10T14:25:05Z",
            "updated_at": "2019-09-10T14:25:05Z",
            "author_association": "NONE",
            "body": "Alright, makes  sense. For our use-case we cannot split it (yet) due to the tight coupling of database with requests introduced by flask_sqlalchemy. \r\nFor now I'll close the PR."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/529963140",
            "html_url": "https://github.com/pallets/flask/pull/3360#issuecomment-529963140",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3360",
            "id": 529963140,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUyOTk2MzE0MA==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-09-10T14:31:03Z",
            "updated_at": "2019-09-10T14:31:03Z",
            "author_association": "MEMBER",
            "body": "Flask-SQLAlchemy doesn't require a request context, only an app context."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/530025394",
            "html_url": "https://github.com/pallets/flask/pull/3360#issuecomment-530025394",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3360",
            "id": 530025394,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUzMDAyNTM5NA==",
            "user": {
                "login": "MaicoTimmerman",
                "id": 904824,
                "node_id": "MDQ6VXNlcjkwNDgyNA==",
                "avatar_url": "https://avatars3.githubusercontent.com/u/904824?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/MaicoTimmerman",
                "html_url": "https://github.com/MaicoTimmerman",
                "followers_url": "https://api.github.com/users/MaicoTimmerman/followers",
                "following_url": "https://api.github.com/users/MaicoTimmerman/following{/other_user}",
                "gists_url": "https://api.github.com/users/MaicoTimmerman/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/MaicoTimmerman/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/MaicoTimmerman/subscriptions",
                "organizations_url": "https://api.github.com/users/MaicoTimmerman/orgs",
                "repos_url": "https://api.github.com/users/MaicoTimmerman/repos",
                "events_url": "https://api.github.com/users/MaicoTimmerman/events{/privacy}",
                "received_events_url": "https://api.github.com/users/MaicoTimmerman/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-09-10T16:51:24Z",
            "updated_at": "2019-09-10T16:51:24Z",
            "author_association": "NONE",
            "body": "In our case we select i18n columns based on the language, which is actually dependent on request context  ;) "
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/530031827",
            "html_url": "https://github.com/pallets/flask/pull/3360#issuecomment-530031827",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3360",
            "id": 530031827,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUzMDAzMTgyNw==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-09-10T17:07:33Z",
            "updated_at": "2019-09-10T17:08:25Z",
            "author_association": "MEMBER",
            "body": "That's an issue with i18n then, not Flask-SQLAlchemy. Whatever i18n provider you use should have a way to set the language outside a request context. The language would then be a Click option and not require a request."
        }
    ]
}
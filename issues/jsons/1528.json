{
    "url": "https://api.github.com/repos/pallets/flask/issues/1528",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/1528/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/1528/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/1528/events",
    "html_url": "https://github.com/pallets/flask/issues/1528",
    "id": 94542359,
    "node_id": "MDU6SXNzdWU5NDU0MjM1OQ==",
    "number": 1528,
    "title": "Application/request stack corruption if unhandled exception is raised in session interface",
    "user": {
        "login": "WeirdCarrotMonster",
        "id": 935751,
        "node_id": "MDQ6VXNlcjkzNTc1MQ==",
        "avatar_url": "https://avatars1.githubusercontent.com/u/935751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/WeirdCarrotMonster",
        "html_url": "https://github.com/WeirdCarrotMonster",
        "followers_url": "https://api.github.com/users/WeirdCarrotMonster/followers",
        "following_url": "https://api.github.com/users/WeirdCarrotMonster/following{/other_user}",
        "gists_url": "https://api.github.com/users/WeirdCarrotMonster/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/WeirdCarrotMonster/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/WeirdCarrotMonster/subscriptions",
        "organizations_url": "https://api.github.com/users/WeirdCarrotMonster/orgs",
        "repos_url": "https://api.github.com/users/WeirdCarrotMonster/repos",
        "events_url": "https://api.github.com/users/WeirdCarrotMonster/events{/privacy}",
        "received_events_url": "https://api.github.com/users/WeirdCarrotMonster/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2015-07-12T07:06:49Z",
    "updated_at": "2017-04-22T21:43:26Z",
    "closed_at": "2017-04-22T21:43:26Z",
    "author_association": "NONE",
    "body": "RequestContext push is called in [wsgi_app method](https://github.com/mitsuhiko/flask/blob/master/flask/app.py#L1952), outside try..finally block. In [push() method](https://github.com/mitsuhiko/flask/blob/master/flask/ctx.py#L332) application's open_session call takes place, which can possibly lead to exception. But, since original call is not in try..finally block, removal of stack top never takes place. This leads to following problems:\n### 1. Application context stack never updates again\n\nRequestContext.push() only [checks](https://github.com/mitsuhiko/flask/blob/master/flask/ctx.py#L316) that application context exists or belongs to current application, but same rules apply to previous context.\n### 2. Request context stack grows\n\nAgain, request context stack is pushed, but never removed. Actually just a memory leak :)\n### 3. Misleading code comment about open_session usage\n\nInspired by [this comment](https://github.com/mitsuhiko/flask/blob/master/flask/ctx.py#L328), i started to develop multi-tenant application, and found nothing but disappointment. **You can't actually access request_context before open_session interface call.** This means, you can't configure which database to use before opening a session.\n## My proposition.\n\nMove open_session call to full_dispatch_request, and add interfaces and methods, similar to before_request - before_open_session, or call before_request before opening session (may break code that depends on session interface)\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/120822656",
            "html_url": "https://github.com/pallets/flask/issues/1528#issuecomment-120822656",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1528",
            "id": 120822656,
            "node_id": "MDEyOklzc3VlQ29tbWVudDEyMDgyMjY1Ng==",
            "user": {
                "login": "WeirdCarrotMonster",
                "id": 935751,
                "node_id": "MDQ6VXNlcjkzNTc1MQ==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/935751?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/WeirdCarrotMonster",
                "html_url": "https://github.com/WeirdCarrotMonster",
                "followers_url": "https://api.github.com/users/WeirdCarrotMonster/followers",
                "following_url": "https://api.github.com/users/WeirdCarrotMonster/following{/other_user}",
                "gists_url": "https://api.github.com/users/WeirdCarrotMonster/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/WeirdCarrotMonster/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/WeirdCarrotMonster/subscriptions",
                "organizations_url": "https://api.github.com/users/WeirdCarrotMonster/orgs",
                "repos_url": "https://api.github.com/users/WeirdCarrotMonster/repos",
                "events_url": "https://api.github.com/users/WeirdCarrotMonster/events{/privacy}",
                "received_events_url": "https://api.github.com/users/WeirdCarrotMonster/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2015-07-13T05:52:50Z",
            "updated_at": "2015-07-13T06:28:55Z",
            "author_association": "NONE",
            "body": "I wrote a testcase for my situation: https://github.com/WeirdCarrotMonster/flask/blob/8efa675c9eb6541273164b075e531982eaaff267/tests/test_appctx.py#L46\n\nThis case also fails tests:\n1. test_app_context_provides_current_app\n2. test_request_locals\n3. test_preserve_only_once\n"
        }
    ]
}
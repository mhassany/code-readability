{
    "url": "https://api.github.com/repos/pallets/flask/issues/3161",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/3161/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/3161/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/3161/events",
    "html_url": "https://github.com/pallets/flask/issues/3161",
    "id": 436704674,
    "node_id": "MDU6SXNzdWU0MzY3MDQ2NzQ=",
    "number": 3161,
    "title": "flask.testing uses extraneous app_context for json client requests",
    "user": {
        "login": "Hooksie",
        "id": 1211530,
        "node_id": "MDQ6VXNlcjEyMTE1MzA=",
        "avatar_url": "https://avatars2.githubusercontent.com/u/1211530?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Hooksie",
        "html_url": "https://github.com/Hooksie",
        "followers_url": "https://api.github.com/users/Hooksie/followers",
        "following_url": "https://api.github.com/users/Hooksie/following{/other_user}",
        "gists_url": "https://api.github.com/users/Hooksie/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/Hooksie/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Hooksie/subscriptions",
        "organizations_url": "https://api.github.com/users/Hooksie/orgs",
        "repos_url": "https://api.github.com/users/Hooksie/repos",
        "events_url": "https://api.github.com/users/Hooksie/events{/privacy}",
        "received_events_url": "https://api.github.com/users/Hooksie/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2019-04-24T13:42:01Z",
    "updated_at": "2019-04-24T15:06:44Z",
    "closed_at": "2019-04-24T13:55:28Z",
    "author_association": "NONE",
    "body": "At flask.testing:81, there exists the block below added in e97253e4c:\r\n\r\n```\r\n    if 'json' in kwargs:\r\n        ...\r\n        # push a context so flask.json can use app's json attributes\r\n        with app.app_context():\r\n            kwargs['data'] = json_dumps(kwargs.pop('json'))\r\n```\r\n\r\nThis enables the werkzeug client to use app or blueprint defaults for the JSONEncode to use. However this invokes an app context and consequently (and surprisingly) the handlers handlers registered to the app context lifecycle.\r\n\r\nSince this behavior only happens when the `json` kwarg is used on the test client, it can lead to surprising behavior in tests that make use of json and inconsistent behavior between tests that do and do not use json. A more expected behavior would be to have consistent behavior both when and when not using the `json` kwarg. \r\n\r\nI also do not see any other usages of the app_context context manager in flask.testing, so this doesn't seem like a pattern that should be expected (not that I'm well versed in Flasks internal patterns, so take that for what its worth).\r\n\r\nI discovered this because Flask-SQLALchemy registers an app context teardown that removes the session and unexpectedly rolls back a session mid testcase. I imagine this behavior is not unique to Flask-SQLAlchemy.\r\n\r\nI propose removing the app_context context handler surrounding the `json_dumps` call, since\r\n\r\n* **this was the behavior prior to e97253e4c**\r\n* the general flask pattern is already to wrap the higher level calls in an app context, so there is unlikely to be significant impact\r\n* json_dumps already degrades gracefully when there is no app context\r\n* the behavior change is constrained to the testing utilities\r\n\r\nI can submit the PR for this if there's appetite, since it's just a couple of lines.\r\n\r\nPython3, flask 1.02.",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/486243250",
            "html_url": "https://github.com/pallets/flask/issues/3161#issuecomment-486243250",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3161",
            "id": 486243250,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ4NjI0MzI1MA==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-04-24T13:55:28Z",
            "updated_at": "2019-04-24T13:55:28Z",
            "author_association": "MEMBER",
            "body": "Duplicate of #2900"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/486243697",
            "html_url": "https://github.com/pallets/flask/issues/3161#issuecomment-486243697",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3161",
            "id": 486243697,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ4NjI0MzY5Nw==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-04-24T13:56:30Z",
            "updated_at": "2019-04-24T13:56:30Z",
            "author_association": "MEMBER",
            "body": "I'm always happy to review a PR though!"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/486282043",
            "html_url": "https://github.com/pallets/flask/issues/3161#issuecomment-486282043",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3161",
            "id": 486282043,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ4NjI4MjA0Mw==",
            "user": {
                "login": "Hooksie",
                "id": 1211530,
                "node_id": "MDQ6VXNlcjEyMTE1MzA=",
                "avatar_url": "https://avatars2.githubusercontent.com/u/1211530?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/Hooksie",
                "html_url": "https://github.com/Hooksie",
                "followers_url": "https://api.github.com/users/Hooksie/followers",
                "following_url": "https://api.github.com/users/Hooksie/following{/other_user}",
                "gists_url": "https://api.github.com/users/Hooksie/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/Hooksie/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Hooksie/subscriptions",
                "organizations_url": "https://api.github.com/users/Hooksie/orgs",
                "repos_url": "https://api.github.com/users/Hooksie/repos",
                "events_url": "https://api.github.com/users/Hooksie/events{/privacy}",
                "received_events_url": "https://api.github.com/users/Hooksie/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-04-24T15:06:44Z",
            "updated_at": "2019-04-24T15:06:44Z",
            "author_association": "NONE",
            "body": "@davidism I'll go ahead and write the patch as described above, assuming it works out in testing."
        }
    ]
}
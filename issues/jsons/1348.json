{
    "url": "https://api.github.com/repos/pallets/flask/issues/1348",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/1348/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/1348/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/1348/events",
    "html_url": "https://github.com/pallets/flask/issues/1348",
    "id": 56962953,
    "node_id": "MDU6SXNzdWU1Njk2Mjk1Mw==",
    "number": 1348,
    "title": "sessions not saved when streaming",
    "user": {
        "login": "kneeke",
        "id": 4102889,
        "node_id": "MDQ6VXNlcjQxMDI4ODk=",
        "avatar_url": "https://avatars1.githubusercontent.com/u/4102889?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kneeke",
        "html_url": "https://github.com/kneeke",
        "followers_url": "https://api.github.com/users/kneeke/followers",
        "following_url": "https://api.github.com/users/kneeke/following{/other_user}",
        "gists_url": "https://api.github.com/users/kneeke/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/kneeke/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/kneeke/subscriptions",
        "organizations_url": "https://api.github.com/users/kneeke/orgs",
        "repos_url": "https://api.github.com/users/kneeke/repos",
        "events_url": "https://api.github.com/users/kneeke/events{/privacy}",
        "received_events_url": "https://api.github.com/users/kneeke/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 135583063,
            "node_id": "MDU6TGFiZWwxMzU1ODMwNjM=",
            "url": "https://api.github.com/repos/pallets/flask/labels/bug",
            "name": "bug",
            "color": "d93f0b",
            "default": true,
            "description": null
        },
        {
            "id": 398835124,
            "node_id": "MDU6TGFiZWwzOTg4MzUxMjQ=",
            "url": "https://api.github.com/repos/pallets/flask/labels/session",
            "name": "session",
            "color": "1d76db",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": {
        "login": "davidism",
        "id": 1242887,
        "node_id": "MDQ6VXNlcjEyNDI4ODc=",
        "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidism",
        "html_url": "https://github.com/davidism",
        "followers_url": "https://api.github.com/users/davidism/followers",
        "following_url": "https://api.github.com/users/davidism/following{/other_user}",
        "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
        "organizations_url": "https://api.github.com/users/davidism/orgs",
        "repos_url": "https://api.github.com/users/davidism/repos",
        "events_url": "https://api.github.com/users/davidism/events{/privacy}",
        "received_events_url": "https://api.github.com/users/davidism/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "davidism",
            "id": 1242887,
            "node_id": "MDQ6VXNlcjEyNDI4ODc=",
            "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/davidism",
            "html_url": "https://github.com/davidism",
            "followers_url": "https://api.github.com/users/davidism/followers",
            "following_url": "https://api.github.com/users/davidism/following{/other_user}",
            "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
            "organizations_url": "https://api.github.com/users/davidism/orgs",
            "repos_url": "https://api.github.com/users/davidism/repos",
            "events_url": "https://api.github.com/users/davidism/events{/privacy}",
            "received_events_url": "https://api.github.com/users/davidism/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": {
        "url": "https://api.github.com/repos/pallets/flask/milestones/2",
        "html_url": "https://github.com/pallets/flask/milestone/2",
        "labels_url": "https://api.github.com/repos/pallets/flask/milestones/2/labels",
        "id": 795954,
        "node_id": "MDk6TWlsZXN0b25lNzk1OTU0",
        "number": 2,
        "title": "1.0",
        "description": "",
        "creator": {
            "login": "untitaker",
            "id": 837573,
            "node_id": "MDQ6VXNlcjgzNzU3Mw==",
            "avatar_url": "https://avatars0.githubusercontent.com/u/837573?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/untitaker",
            "html_url": "https://github.com/untitaker",
            "followers_url": "https://api.github.com/users/untitaker/followers",
            "following_url": "https://api.github.com/users/untitaker/following{/other_user}",
            "gists_url": "https://api.github.com/users/untitaker/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/untitaker/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/untitaker/subscriptions",
            "organizations_url": "https://api.github.com/users/untitaker/orgs",
            "repos_url": "https://api.github.com/users/untitaker/repos",
            "events_url": "https://api.github.com/users/untitaker/events{/privacy}",
            "received_events_url": "https://api.github.com/users/untitaker/received_events",
            "type": "User",
            "site_admin": false
        },
        "open_issues": 0,
        "closed_issues": 159,
        "state": "closed",
        "created_at": "2014-09-19T15:47:20Z",
        "updated_at": "2018-04-26T21:07:44Z",
        "due_on": "2018-04-26T07:00:00Z",
        "closed_at": "2018-04-26T21:07:44Z"
    },
    "comments": 3,
    "created_at": "2015-02-08T19:03:16Z",
    "updated_at": "2017-06-03T19:26:15Z",
    "closed_at": "2017-06-03T19:26:15Z",
    "author_association": "NONE",
    "body": "When streaming, changes to the session object at the start of the request \r\nprocessing are never saved at all, the moment template rendering starts, a new \r\nsession object is created which is then saved.\r\n\r\nThe statement on IRC was first that this is due to the fact that sessions (by default) are stored client side, and can not change anymore after the headers are send.\r\nThis is only true for sessions that are stored client side, if the sessions are server side it should be possible to change (and save) them during the whole request/response.\r\nThe real problem here seems to be that a new session is created when the stream starts.\r\n\r\nWe used the following example to stream contents: http://flask.pocoo.org/docs/0.10/patterns/streaming/\r\n\r\nFor now a workaround is to explicitly save the session after modifying, before rendering the template / starting the stream.\r\n\r\nExpected output is always the same, one time session open and one time session save.\r\nIn the stream example the output is different; 2 sessions are opend, the first one is the one that changes, but the second one (this is opened when the stream starts) is the only one that is saved.\r\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/73425631",
            "html_url": "https://github.com/pallets/flask/issues/1348#issuecomment-73425631",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1348",
            "id": 73425631,
            "node_id": "MDEyOklzc3VlQ29tbWVudDczNDI1NjMx",
            "user": {
                "login": "kneeke",
                "id": 4102889,
                "node_id": "MDQ6VXNlcjQxMDI4ODk=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/4102889?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/kneeke",
                "html_url": "https://github.com/kneeke",
                "followers_url": "https://api.github.com/users/kneeke/followers",
                "following_url": "https://api.github.com/users/kneeke/following{/other_user}",
                "gists_url": "https://api.github.com/users/kneeke/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/kneeke/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/kneeke/subscriptions",
                "organizations_url": "https://api.github.com/users/kneeke/orgs",
                "repos_url": "https://api.github.com/users/kneeke/repos",
                "events_url": "https://api.github.com/users/kneeke/events{/privacy}",
                "received_events_url": "https://api.github.com/users/kneeke/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2015-02-08T19:04:24Z",
            "updated_at": "2017-06-02T17:36:41Z",
            "author_association": "NONE",
            "body": "```python\r\nfrom flask import Flask, Response, stream_with_context, session\r\nfrom flask.sessions import SessionMixin, SessionInterface\r\nfrom werkzeug.datastructures import CallbackDict\r\n\r\nclass Session(CallbackDict, SessionMixin):\r\n    modified = True\r\n\r\nclass TestSessionInterface(SessionInterface):\r\n    def open_session(self, *args, **kwargs):\r\n        print(\"OPEN SESSION CALLED\")\r\n        return Session()\r\n\r\n    def save_session(self, *args, **kwargs):\r\n        print(\"SAVE SESSION CALLED\")\r\n\r\napp = Flask(__name__)\r\napp.session_interface = TestSessionInterface()\r\n\r\n@app.route('/return')\r\ndef returndata():\r\n    return \"SDFSDF\"\r\n\r\n@app.route('/stream')\r\ndef stream():\r\n    def generate():\r\n        yield \"resp\"\r\n    return Response(stream_with_context(generate()))\r\n\r\nif __name__ == '__main__':\r\n    app.run()\r\n```"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/305865261",
            "html_url": "https://github.com/pallets/flask/issues/1348#issuecomment-305865261",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1348",
            "id": 305865261,
            "node_id": "MDEyOklzc3VlQ29tbWVudDMwNTg2NTI2MQ==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2017-06-02T17:54:16Z",
            "updated_at": "2017-06-02T17:55:17Z",
            "author_association": "MEMBER",
            "body": "Shorter example:\r\n\r\n~~~python\r\nfrom flask import Flask, Response, stream_with_context, session\r\n\r\napp = Flask(__name__)\r\napp.secret_key = 'dev'\r\n\r\n@app.route('/')\r\ndef index():\r\n    session['test'] = 'flask'\r\n\r\n    @stream_with_context\r\n    def gen():\r\n        yield session['test']\r\n\r\n    return Response(gen())\r\n~~~\r\n\r\nAccessing `session['test']` inside the generator raises a `KeyError` because a new session based on the initial request was opened by `stream_with_context`."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/305867640",
            "html_url": "https://github.com/pallets/flask/issues/1348#issuecomment-305867640",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1348",
            "id": 305867640,
            "node_id": "MDEyOklzc3VlQ29tbWVudDMwNTg2NzY0MA==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2017-06-02T18:03:26Z",
            "updated_at": "2017-06-02T18:03:26Z",
            "author_association": "MEMBER",
            "body": "[These lines](https://github.com/pallets/flask/blob/0.12.2/flask/ctx.py#L332-L334) should only happen if the request is not already pushed. If `request.session` is set, it should be kept."
        }
    ]
}
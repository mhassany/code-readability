{
    "url": "https://api.github.com/repos/pallets/flask/issues/2466",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/2466/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/2466/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/2466/events",
    "html_url": "https://github.com/pallets/flask/issues/2466",
    "id": 255592816,
    "node_id": "MDU6SXNzdWUyNTU1OTI4MTY=",
    "number": 2466,
    "title": "Flask Custom jinja2 extension caching template states after new request",
    "user": {
        "login": "hyperking",
        "id": 1525894,
        "node_id": "MDQ6VXNlcjE1MjU4OTQ=",
        "avatar_url": "https://avatars2.githubusercontent.com/u/1525894?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hyperking",
        "html_url": "https://github.com/hyperking",
        "followers_url": "https://api.github.com/users/hyperking/followers",
        "following_url": "https://api.github.com/users/hyperking/following{/other_user}",
        "gists_url": "https://api.github.com/users/hyperking/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/hyperking/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/hyperking/subscriptions",
        "organizations_url": "https://api.github.com/users/hyperking/orgs",
        "repos_url": "https://api.github.com/users/hyperking/repos",
        "events_url": "https://api.github.com/users/hyperking/events{/privacy}",
        "received_events_url": "https://api.github.com/users/hyperking/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 1,
    "created_at": "2017-09-06T12:52:19Z",
    "updated_at": "2017-09-06T12:56:02Z",
    "closed_at": "2017-09-06T12:56:01Z",
    "author_association": "NONE",
    "body": "I'm Looking to create a similar custom extension to push any javascript code blocks to a designated area on the page or below footer.\r\n\r\nMy version works using Python 3.6,Flask and Jinja 2.9. However I have a major\r\nissue that occurs after changing the line number or content within the blocks.\r\nThe content will appear multiple times on render.\r\n\r\n    from jinja2 import nodes\r\n    from jinja2.ext import Extension\r\n    \r\n    class JavascriptBuilderExtension(Extension):\r\n        tags = set(['push'])\r\n    \r\n        def __init__(self, environment):\r\n            super(JavascriptBuilderExtension, self).__init__(environment)\r\n            self._myScope = {}\r\n            environment.extend(\r\n                pull = self._myScope\r\n                )\r\n        def parse(self, parser):\r\n            \"\"\"Parse tokens \"\"\"\r\n            tag = parser.stream.__next__()\r\n            args = [parser.parse_expression(), nodes.Const(tag.lineno)]\r\n            body = parser.parse_statements(['name:endpush'], drop_needle=True)\r\n            callback = self.call_method('compiled', args)\r\n            return nodes.CallBlock(callback,[], [], body).set_lineno(tag.lineno)\r\n    \r\n        def compiled(self,tagname,linenum,caller):\r\n            tagname = \"{}_{}\".format( tagname, linenum)\r\n            self._myScope[tagname] = caller()\r\n            return \"<!-- moved {} from line {} -->\".format(tagname,linenum)\r\n        \r\n\r\nMy template code looks like this\r\n\r\n    <html> <head></head> <body> <h1>Test template</h1>\r\n    {% push 'js' %} X {% endpush %}\r\n    {% push 'html' %} Z {% endpush %}\r\n    {% push 'js' %} Y {% endpush %}\r\n    {{ pull }}\r\n    </body> </html>\r\n\r\nMy rendered output is below:\r\n\r\n    <html> <head></head> <body> <h1>Test template</h1>\r\n    name = hyper testing jinja\r\n    date = right now\r\n    <!-- moved js_4 from line 4 -->\r\n    <!-- moved html_5 from line 5 -->\r\n    <!-- moved js_6 from line 6 -->\r\n    {'js_4': ' X ', 'html_5': ' Z ', 'js_6': ' Y '}\r\n    </body> </html>\r\n\r\n**The Problem happens after I change the template block line number or content.**\r\n\r\n**After changing content and line numbers**\r\n\r\n    <html> <head></head> <body> <h1>Test template</h1>\r\n    {% push 'js' %} ABC {% endpush %}\r\n\r\n    {% push 'html' %} Z {% endpush %}\r\n\r\n    {% push 'js' %} 123{% endpush %}\r\n    {{ pull }}\r\n    </body> </html>\r\n\r\n**Render changed blocks now has prior content**\r\n\r\n    <html> <head></head> <body> <h1>Test template</h1>\r\n    name = hyper testing jinja\r\n    date = right now\r\n    <!-- moved js_4 from line 4 -->\r\n\r\n    <!-- moved html_7 from line 7 -->\r\n\r\n    <!-- moved js_9 from line 9 -->\r\n    {'js_4': ' X ABC', 'html_5': ' Z ', 'js_6': ' Y ','js_9':'123','html_7':'Z'}\r\n    </body> </html>\r\n\r\nThis issue causes duplicate content to be added into the response.\r\n\r\nIs there a way to call the extension on ever page request to re-parse the template for new changes? or Possible to not cache the enclosed extension blocks?\r\n\r\nI have already tried adding the code below to auto reload templates but does not help the issue.\r\n\r\n`app.jinja_env.auto_reload = True`\r\n\r\n\r\n### Environment\r\n\r\n* Python version: 3.6\r\n* Flask version:0.10\r\n* Werkzeug version:0.12.2\r\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/327474442",
            "html_url": "https://github.com/pallets/flask/issues/2466#issuecomment-327474442",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2466",
            "id": 327474442,
            "node_id": "MDEyOklzc3VlQ29tbWVudDMyNzQ3NDQ0Mg==",
            "user": {
                "login": "ThiefMaster",
                "id": 179599,
                "node_id": "MDQ6VXNlcjE3OTU5OQ==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/179599?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/ThiefMaster",
                "html_url": "https://github.com/ThiefMaster",
                "followers_url": "https://api.github.com/users/ThiefMaster/followers",
                "following_url": "https://api.github.com/users/ThiefMaster/following{/other_user}",
                "gists_url": "https://api.github.com/users/ThiefMaster/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/ThiefMaster/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ThiefMaster/subscriptions",
                "organizations_url": "https://api.github.com/users/ThiefMaster/orgs",
                "repos_url": "https://api.github.com/users/ThiefMaster/repos",
                "events_url": "https://api.github.com/users/ThiefMaster/events{/privacy}",
                "received_events_url": "https://api.github.com/users/ThiefMaster/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2017-09-06T12:56:01Z",
            "updated_at": "2017-09-06T12:56:01Z",
            "author_association": "MEMBER",
            "body": "That's a Jinja question for sure.\r\n\r\nAnd there's only one instance of the extension so of course `self._myScope` keeps growing. Fixing this is not going to be easy for sure. Best to ask this on IRC and/or Stack Overflow."
        }
    ]
}
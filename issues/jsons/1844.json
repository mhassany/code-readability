{
    "url": "https://api.github.com/repos/pallets/flask/issues/1844",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/1844/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/1844/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/1844/events",
    "html_url": "https://github.com/pallets/flask/issues/1844",
    "id": 157941348,
    "node_id": "MDU6SXNzdWUxNTc5NDEzNDg=",
    "number": 1844,
    "title": "Middleware doesn't execute inside test_request_context()",
    "user": {
        "login": "amorey",
        "id": 75881,
        "node_id": "MDQ6VXNlcjc1ODgx",
        "avatar_url": "https://avatars1.githubusercontent.com/u/75881?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/amorey",
        "html_url": "https://github.com/amorey",
        "followers_url": "https://api.github.com/users/amorey/followers",
        "following_url": "https://api.github.com/users/amorey/following{/other_user}",
        "gists_url": "https://api.github.com/users/amorey/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/amorey/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/amorey/subscriptions",
        "organizations_url": "https://api.github.com/users/amorey/orgs",
        "repos_url": "https://api.github.com/users/amorey/repos",
        "events_url": "https://api.github.com/users/amorey/events{/privacy}",
        "received_events_url": "https://api.github.com/users/amorey/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 5,
    "created_at": "2016-06-01T15:46:35Z",
    "updated_at": "2018-12-18T16:28:44Z",
    "closed_at": "2016-06-01T23:46:19Z",
    "author_association": "NONE",
    "body": "I'm trying to write a unittest for a custom middleware layer in my app and I'm having difficulty getting the middleware to execute inside a test request context. Here's a simple script that illustrates the problem:\n\n``` python\nfrom flask import Flask, url_for\n\nclass Middleware(object):\n    def __init__(self, app):\n        print ' - initialized middleware'\n        self.app = app\n\n    def __call__(self, environ, start_response):\n        print ' - executed middleware'\n        return self.app(environ, start_response)\n\n# create app\napp = Flask(__name__)\n\n# add middleware\napp.wsgi_app = Middleware(app.wsgi_app)\n\n# add route\n@app.route('/')\ndef index():\n    return 'index'\n\n# test GET                                                                      \nprint '\\nTesting GET...'\nresp = app.test_client().get('/')\nprint ' - Response: ' + resp.data\n\n# test context                                                                  \nprint '\\nTesting request context...'\nwith app.test_request_context('/'):\n    app.preprocess_request()\n    ret = app.dispatch_request()\n    resp = app.make_response(ret)\n    resp = app.process_response(resp)\n    print ' - Response: ' + resp.data\n```\n\nThe middleware executes inside the test client GET request but not inside the test request context. Here's the output:\n\n``` bash\n$ python test.py\n - initialized middleware\n\nTesting GET...\n - executed middleware\n - Response: index\n\nTesting request context...\n - Response: index\n```\n\nAm I doing something wrong or is this the intentional behavior inside a test request context? I'm using Flask 0.11 and Werkzeug 0.11.10.\n\nThanks for your help!\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/223157860",
            "html_url": "https://github.com/pallets/flask/issues/1844#issuecomment-223157860",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1844",
            "id": 223157860,
            "node_id": "MDEyOklzc3VlQ29tbWVudDIyMzE1Nzg2MA==",
            "user": {
                "login": "mitsuhiko",
                "id": 7396,
                "node_id": "MDQ6VXNlcjczOTY=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/7396?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/mitsuhiko",
                "html_url": "https://github.com/mitsuhiko",
                "followers_url": "https://api.github.com/users/mitsuhiko/followers",
                "following_url": "https://api.github.com/users/mitsuhiko/following{/other_user}",
                "gists_url": "https://api.github.com/users/mitsuhiko/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/mitsuhiko/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mitsuhiko/subscriptions",
                "organizations_url": "https://api.github.com/users/mitsuhiko/orgs",
                "repos_url": "https://api.github.com/users/mitsuhiko/repos",
                "events_url": "https://api.github.com/users/mitsuhiko/events{/privacy}",
                "received_events_url": "https://api.github.com/users/mitsuhiko/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2016-06-01T23:46:19Z",
            "updated_at": "2016-06-01T23:46:19Z",
            "author_association": "MEMBER",
            "body": "WSGI middlewares cannot access a request context. That would be a violation of separation of concerns here.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/223170075",
            "html_url": "https://github.com/pallets/flask/issues/1844#issuecomment-223170075",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1844",
            "id": 223170075,
            "node_id": "MDEyOklzc3VlQ29tbWVudDIyMzE3MDA3NQ==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2016-06-02T01:10:50Z",
            "updated_at": "2016-06-02T01:10:50Z",
            "author_association": "MEMBER",
            "body": "If you're in a request context, you're already in Flask, not the middleware around it.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/223174315",
            "html_url": "https://github.com/pallets/flask/issues/1844#issuecomment-223174315",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1844",
            "id": 223174315,
            "node_id": "MDEyOklzc3VlQ29tbWVudDIyMzE3NDMxNQ==",
            "user": {
                "login": "amorey",
                "id": 75881,
                "node_id": "MDQ6VXNlcjc1ODgx",
                "avatar_url": "https://avatars1.githubusercontent.com/u/75881?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/amorey",
                "html_url": "https://github.com/amorey",
                "followers_url": "https://api.github.com/users/amorey/followers",
                "following_url": "https://api.github.com/users/amorey/following{/other_user}",
                "gists_url": "https://api.github.com/users/amorey/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/amorey/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/amorey/subscriptions",
                "organizations_url": "https://api.github.com/users/amorey/orgs",
                "repos_url": "https://api.github.com/users/amorey/repos",
                "events_url": "https://api.github.com/users/amorey/events{/privacy}",
                "received_events_url": "https://api.github.com/users/amorey/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2016-06-02T01:44:52Z",
            "updated_at": "2016-06-02T01:45:11Z",
            "author_association": "NONE",
            "body": "Thanks, that makes sense.\n\nWhat's the best way to test middleware inside a Flask app? I see how to write an isolated test for each individual middleware layer but if you want to test how the middleware behaves inside the app it seems like the only option is to execute a full request. Is there a better way to write a more targeted app-level test?\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/223524184",
            "html_url": "https://github.com/pallets/flask/issues/1844#issuecomment-223524184",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1844",
            "id": 223524184,
            "node_id": "MDEyOklzc3VlQ29tbWVudDIyMzUyNDE4NA==",
            "user": {
                "login": "jeffwidman",
                "id": 483314,
                "node_id": "MDQ6VXNlcjQ4MzMxNA==",
                "avatar_url": "https://avatars2.githubusercontent.com/u/483314?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/jeffwidman",
                "html_url": "https://github.com/jeffwidman",
                "followers_url": "https://api.github.com/users/jeffwidman/followers",
                "following_url": "https://api.github.com/users/jeffwidman/following{/other_user}",
                "gists_url": "https://api.github.com/users/jeffwidman/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/jeffwidman/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jeffwidman/subscriptions",
                "organizations_url": "https://api.github.com/users/jeffwidman/orgs",
                "repos_url": "https://api.github.com/users/jeffwidman/repos",
                "events_url": "https://api.github.com/users/jeffwidman/events{/privacy}",
                "received_events_url": "https://api.github.com/users/jeffwidman/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2016-06-03T08:43:38Z",
            "updated_at": "2016-06-03T08:43:38Z",
            "author_association": "MEMBER",
            "body": "@amorey it's a good question, but a better fit for StackOverflow rather than the issue tracker.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/448281613",
            "html_url": "https://github.com/pallets/flask/issues/1844#issuecomment-448281613",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1844",
            "id": 448281613,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ0ODI4MTYxMw==",
            "user": {
                "login": "muodov",
                "id": 2726132,
                "node_id": "MDQ6VXNlcjI3MjYxMzI=",
                "avatar_url": "https://avatars0.githubusercontent.com/u/2726132?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/muodov",
                "html_url": "https://github.com/muodov",
                "followers_url": "https://api.github.com/users/muodov/followers",
                "following_url": "https://api.github.com/users/muodov/following{/other_user}",
                "gists_url": "https://api.github.com/users/muodov/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/muodov/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/muodov/subscriptions",
                "organizations_url": "https://api.github.com/users/muodov/orgs",
                "repos_url": "https://api.github.com/users/muodov/repos",
                "events_url": "https://api.github.com/users/muodov/events{/privacy}",
                "received_events_url": "https://api.github.com/users/muodov/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-12-18T16:28:44Z",
            "updated_at": "2018-12-18T16:28:44Z",
            "author_association": "NONE",
            "body": "Middleware doesn't have access to request context, but it can change WSGI environ, which, in turn, may affect session context.\r\nFor example, this snippet does exactly that, and it's very hard to mock it in the tests http://flask.pocoo.org/snippets/121/"
        }
    ]
}
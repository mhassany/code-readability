{
    "url": "https://api.github.com/repos/pallets/flask/issues/2777",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/2777/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/2777/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/2777/events",
    "html_url": "https://github.com/pallets/flask/pull/2777",
    "id": 322557970,
    "node_id": "MDExOlB1bGxSZXF1ZXN0MTg3NjQ5MDM2",
    "number": 2777,
    "title": "fix broken sys.argv list",
    "user": {
        "login": "miguelgrinberg",
        "id": 2715854,
        "node_id": "MDQ6VXNlcjI3MTU4NTQ=",
        "avatar_url": "https://avatars0.githubusercontent.com/u/2715854?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/miguelgrinberg",
        "html_url": "https://github.com/miguelgrinberg",
        "followers_url": "https://api.github.com/users/miguelgrinberg/followers",
        "following_url": "https://api.github.com/users/miguelgrinberg/following{/other_user}",
        "gists_url": "https://api.github.com/users/miguelgrinberg/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/miguelgrinberg/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/miguelgrinberg/subscriptions",
        "organizations_url": "https://api.github.com/users/miguelgrinberg/orgs",
        "repos_url": "https://api.github.com/users/miguelgrinberg/repos",
        "events_url": "https://api.github.com/users/miguelgrinberg/events{/privacy}",
        "received_events_url": "https://api.github.com/users/miguelgrinberg/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 7,
    "created_at": "2018-05-13T02:22:49Z",
    "updated_at": "2018-12-08T22:28:32Z",
    "closed_at": "2018-12-08T22:28:32Z",
    "author_association": "MEMBER",
    "pull_request": {
        "url": "https://api.github.com/repos/pallets/flask/pulls/2777",
        "html_url": "https://github.com/pallets/flask/pull/2777",
        "diff_url": "https://github.com/pallets/flask/pull/2777.diff",
        "patch_url": "https://github.com/pallets/flask/pull/2777.patch"
    },
    "body": "The `cli.main()` function captures the command-line arguments, and then attempts to change the arguments in the `sys.argv` list from `flask ...` to `python -m flask ...`. The problem is that it misses the `sys,argv[0]` element, so the modified argument list begins with `-m` in the 0th element.\r\n\r\nI honestly don't remember why `sys.argv` needs to be changed to the `python -m` form, but I assume there is a good reason for that, so this change adds `sys.executable` as the first argument.",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/388630738",
            "html_url": "https://github.com/pallets/flask/pull/2777#issuecomment-388630738",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2777",
            "id": 388630738,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM4ODYzMDczOA==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-05-13T14:25:06Z",
            "updated_at": "2018-05-13T14:25:06Z",
            "author_association": "MEMBER",
            "body": "The reloader in Werkzeug adds in `sys.executable`. Was something not working that requires this change? `main` has worked this way from the start."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/388631944",
            "html_url": "https://github.com/pallets/flask/pull/2777#issuecomment-388631944",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2777",
            "id": 388631944,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM4ODYzMTk0NA==",
            "user": {
                "login": "miguelgrinberg",
                "id": 2715854,
                "node_id": "MDQ6VXNlcjI3MTU4NTQ=",
                "avatar_url": "https://avatars0.githubusercontent.com/u/2715854?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/miguelgrinberg",
                "html_url": "https://github.com/miguelgrinberg",
                "followers_url": "https://api.github.com/users/miguelgrinberg/followers",
                "following_url": "https://api.github.com/users/miguelgrinberg/following{/other_user}",
                "gists_url": "https://api.github.com/users/miguelgrinberg/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/miguelgrinberg/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/miguelgrinberg/subscriptions",
                "organizations_url": "https://api.github.com/users/miguelgrinberg/orgs",
                "repos_url": "https://api.github.com/users/miguelgrinberg/repos",
                "events_url": "https://api.github.com/users/miguelgrinberg/events{/privacy}",
                "received_events_url": "https://api.github.com/users/miguelgrinberg/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-05-13T14:41:59Z",
            "updated_at": "2018-05-13T14:41:59Z",
            "author_association": "MEMBER",
            "body": "@davidism as far as I can see this is broken with or without the reloader. Example app:\r\n\r\n```python\r\nimport sys\r\nfrom flask import Flask\r\n\r\napp = Flask(__name__)\r\n\r\n@app.route('/')\r\ndef index():\r\n    print(sys.argv)\r\n    return 'hello'\r\n```\r\n\r\nIf you run it with `flask run` it's all fine, but if you run it with `python -m flask run` the `sys.argv` list does not have the 0th element.\r\n\r\nIn general this isn't a problem because most apps do not need to use `sys.argv` directly. I suspect that is the reason why this was never seen before. I'm currently working on a little \"experiment\" to improve the cli and stumbled upon this."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/391720680",
            "html_url": "https://github.com/pallets/flask/pull/2777#issuecomment-391720680",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2777",
            "id": 391720680,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM5MTcyMDY4MA==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-05-24T13:46:42Z",
            "updated_at": "2018-05-24T13:46:42Z",
            "author_association": "MEMBER",
            "body": "There is also pallets/werkzeug#531 (also by @miguelgrinberg) and pallets/werkzeug#1242. I feel like I don't understand clearly why Flask and Werkzeug are manipulating `sys.executable` and `sys.argv` the way they are, or where the actual fix needs to happen. Can we try to reconcile these three PRs?"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/404543701",
            "html_url": "https://github.com/pallets/flask/pull/2777#issuecomment-404543701",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2777",
            "id": 404543701,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQwNDU0MzcwMQ==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-07-12T15:02:52Z",
            "updated_at": "2018-07-12T15:02:52Z",
            "author_association": "MEMBER",
            "body": "@miguelgrinberg (or anyone) could you comment on how the issues I linked above are related to this? I'm willing to merge one or more of these as soon as I understand where the fix should happen."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/404604035",
            "html_url": "https://github.com/pallets/flask/pull/2777#issuecomment-404604035",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2777",
            "id": 404604035,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQwNDYwNDAzNQ==",
            "user": {
                "login": "miguelgrinberg",
                "id": 2715854,
                "node_id": "MDQ6VXNlcjI3MTU4NTQ=",
                "avatar_url": "https://avatars0.githubusercontent.com/u/2715854?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/miguelgrinberg",
                "html_url": "https://github.com/miguelgrinberg",
                "followers_url": "https://api.github.com/users/miguelgrinberg/followers",
                "following_url": "https://api.github.com/users/miguelgrinberg/following{/other_user}",
                "gists_url": "https://api.github.com/users/miguelgrinberg/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/miguelgrinberg/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/miguelgrinberg/subscriptions",
                "organizations_url": "https://api.github.com/users/miguelgrinberg/orgs",
                "repos_url": "https://api.github.com/users/miguelgrinberg/repos",
                "events_url": "https://api.github.com/users/miguelgrinberg/events{/privacy}",
                "received_events_url": "https://api.github.com/users/miguelgrinberg/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-07-12T18:18:54Z",
            "updated_at": "2018-07-12T18:20:40Z",
            "author_association": "MEMBER",
            "body": "My understanding is that these issues come from the fact the when you start your application with \"python -m module\", Python does some unexpected changes to `sys.argv` and `sys.path`. If you are using the reloader, this becomes a problem, because the parent process somehow needs to figure out how to start the child process in the same way the parent process was started.\r\n\r\nhttps://github.com/pallets/werkzeug/pull/531 is an enhancement to Werkzeug that adds the lazy loading of the WSGI app, like Flask does, and it fixes `sys.path` as part of that.\r\n\r\nThis PR however, tries to make sure that `sys.argv` is set correctly, so that when Click comes and looks at it everything is at the expected place. This part of the code rarely run, because `as_module` is usually `True`. I have found this issue when trying to route `app.run()` through this same `main()` function so that it gets the same CLI as the `flask` command.\r\n\r\nIn my opinion these two issues are completely unrelated, and just share the fact that both try to compensate for the way Python handles the `-m` option. I wasn't familiar with https://github.com/pallets/werkzeug/pull/1242, that seems to be yet another argument related fix, to make the reloader work when starting the app with a wrapper script instead of Python directly. I have not seen any such cases myself."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/404674749",
            "html_url": "https://github.com/pallets/flask/pull/2777#issuecomment-404674749",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2777",
            "id": 404674749,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQwNDY3NDc0OQ==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-07-12T22:51:00Z",
            "updated_at": "2018-07-12T22:51:00Z",
            "author_association": "MEMBER",
            "body": "One thing I remember taking a look at was that on Windows, the `py` command also produces a different `sys.argv`, since it looks like `py -3 -m flask`, and that failed. Does this address that as well?"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/404675732",
            "html_url": "https://github.com/pallets/flask/pull/2777#issuecomment-404675732",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2777",
            "id": 404675732,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQwNDY3NTczMg==",
            "user": {
                "login": "miguelgrinberg",
                "id": 2715854,
                "node_id": "MDQ6VXNlcjI3MTU4NTQ=",
                "avatar_url": "https://avatars0.githubusercontent.com/u/2715854?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/miguelgrinberg",
                "html_url": "https://github.com/miguelgrinberg",
                "followers_url": "https://api.github.com/users/miguelgrinberg/followers",
                "following_url": "https://api.github.com/users/miguelgrinberg/following{/other_user}",
                "gists_url": "https://api.github.com/users/miguelgrinberg/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/miguelgrinberg/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/miguelgrinberg/subscriptions",
                "organizations_url": "https://api.github.com/users/miguelgrinberg/orgs",
                "repos_url": "https://api.github.com/users/miguelgrinberg/repos",
                "events_url": "https://api.github.com/users/miguelgrinberg/events{/privacy}",
                "received_events_url": "https://api.github.com/users/miguelgrinberg/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-07-12T22:54:28Z",
            "updated_at": "2018-07-12T22:54:28Z",
            "author_association": "MEMBER",
            "body": "I'm not sure this PR will handle that any better than it is currently handled, I wasn't even aware of this difference on Windows. I'll test on a Windows machine tonight and report back."
        }
    ]
}
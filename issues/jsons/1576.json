{
    "url": "https://api.github.com/repos/pallets/flask/issues/1576",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/1576/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/1576/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/1576/events",
    "html_url": "https://github.com/pallets/flask/issues/1576",
    "id": 109127624,
    "node_id": "MDU6SXNzdWUxMDkxMjc2MjQ=",
    "number": 1576,
    "title": "an context confuse when i using the celery ",
    "user": {
        "login": "jiaqizho",
        "id": 8388185,
        "node_id": "MDQ6VXNlcjgzODgxODU=",
        "avatar_url": "https://avatars1.githubusercontent.com/u/8388185?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jiaqizho",
        "html_url": "https://github.com/jiaqizho",
        "followers_url": "https://api.github.com/users/jiaqizho/followers",
        "following_url": "https://api.github.com/users/jiaqizho/following{/other_user}",
        "gists_url": "https://api.github.com/users/jiaqizho/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/jiaqizho/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/jiaqizho/subscriptions",
        "organizations_url": "https://api.github.com/users/jiaqizho/orgs",
        "repos_url": "https://api.github.com/users/jiaqizho/repos",
        "events_url": "https://api.github.com/users/jiaqizho/events{/privacy}",
        "received_events_url": "https://api.github.com/users/jiaqizho/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 4,
    "created_at": "2015-09-30T16:14:24Z",
    "updated_at": "2018-10-06T03:09:36Z",
    "closed_at": "2015-10-31T21:15:19Z",
    "author_association": "NONE",
    "body": "it appear in when i using the celery with flask_sqlalchemy \n\ni am using the celery with context  by  http://flask.pocoo.org/docs/0.10/patterns/celery/\nbut i find \"copy_current_request_context\" is not work , because the context is typeof the AppContext not the RequestContext . so when invoke @copy_current_request_context , it raise the \n\nRuntimeError('This decorator can only be used at local scopes '\n            'when a request context is on the stack.  For instance within '\n            'view functions.')\n\nso i try to  replace the RequestContext with AppContext in @copy_current_request_context , it work!\nthe code which i changed ( from flask/ctx.py ): \n\n```\ndef copy_current_request_context(f):\n\n    top = _app_ctx_stack.top\n    if top is None:\n        raise RuntimeError('This decorator can only be used at local scopes '\n            'when a request context is on the stack.  For instance within '\n            'view functions.')\n    reqctx = top.copy()\n    def wrapper(*args, **kwargs):\n        with reqctx:\n            return f(*args, **kwargs)\n    return update_wrapper(wrapper, f)\n\n\n\n\n\nclass AppContext(object):\n\n    def __init__(self, app):\n        self.app = app\n        self.url_adapter = app.create_url_adapter(None)\n        self.g = app.app_ctx_globals_class()\n\n        # Like request context, app contexts can be pushed multiple times\n        # but there a basic \"refcount\" is enough to track them.\n        self._refcnt = 0\n\n    def copy(self):\n\n        mapp = self.__class__(self.app,)\n        return mapp\n\n    def push(self):\n        \"\"\"Binds the app context to the current context.\"\"\"\n        self._refcnt += 1\n        _app_ctx_stack.push(self)\n        appcontext_pushed.send(self.app)\n\n    def pop(self, exc=None):\n        \"\"\"Pops the app context.\"\"\"\n        self._refcnt -= 1\n        if self._refcnt <= 0:\n            if exc is None:\n                exc = sys.exc_info()[1]\n            self.app.do_teardown_appcontext(exc)\n        rv = _app_ctx_stack.pop()\n        assert rv is self, 'Popped wrong app context.  (%r instead of %r)' \\\n            % (rv, self)\n        appcontext_popped.send(self.app)\n\n    def __enter__(self):\n        self.push()\n        return self\n\n    def __exit__(self, exc_type, exc_value, tb):\n        self.pop(exc_value)\n```\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/144466208",
            "html_url": "https://github.com/pallets/flask/issues/1576#issuecomment-144466208",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1576",
            "id": 144466208,
            "node_id": "MDEyOklzc3VlQ29tbWVudDE0NDQ2NjIwOA==",
            "user": {
                "login": "jiaqizho",
                "id": 8388185,
                "node_id": "MDQ6VXNlcjgzODgxODU=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/8388185?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/jiaqizho",
                "html_url": "https://github.com/jiaqizho",
                "followers_url": "https://api.github.com/users/jiaqizho/followers",
                "following_url": "https://api.github.com/users/jiaqizho/following{/other_user}",
                "gists_url": "https://api.github.com/users/jiaqizho/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/jiaqizho/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jiaqizho/subscriptions",
                "organizations_url": "https://api.github.com/users/jiaqizho/orgs",
                "repos_url": "https://api.github.com/users/jiaqizho/repos",
                "events_url": "https://api.github.com/users/jiaqizho/events{/privacy}",
                "received_events_url": "https://api.github.com/users/jiaqizho/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2015-09-30T16:22:39Z",
            "updated_at": "2015-09-30T16:22:39Z",
            "author_association": "NONE",
            "body": "i think it not reasonable to copy_current_request_context using the RequestContext\ncause in other thread in gevent it also use the ormaping not the request or something\n\nby the way . i use the celery to merge the data from mongo to mysql . \n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/144485078",
            "html_url": "https://github.com/pallets/flask/issues/1576#issuecomment-144485078",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1576",
            "id": 144485078,
            "node_id": "MDEyOklzc3VlQ29tbWVudDE0NDQ4NTA3OA==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2015-09-30T17:34:29Z",
            "updated_at": "2015-09-30T17:34:51Z",
            "author_association": "MEMBER",
            "body": "You can only use that decorator within an app context, since it relies on an app context being present.  I'm not clear where you even got that code from, it's not in the docs.  The whole point of the code in the docs is so that the workers will execute tasks in an app context without having to pass it explicitly.  If your task requires information from the request, pass it manually rather than trying to copy the request context.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/144488466",
            "html_url": "https://github.com/pallets/flask/issues/1576#issuecomment-144488466",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1576",
            "id": 144488466,
            "node_id": "MDEyOklzc3VlQ29tbWVudDE0NDQ4ODQ2Ng==",
            "user": {
                "login": "jiaqizho",
                "id": 8388185,
                "node_id": "MDQ6VXNlcjgzODgxODU=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/8388185?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/jiaqizho",
                "html_url": "https://github.com/jiaqizho",
                "followers_url": "https://api.github.com/users/jiaqizho/followers",
                "following_url": "https://api.github.com/users/jiaqizho/following{/other_user}",
                "gists_url": "https://api.github.com/users/jiaqizho/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/jiaqizho/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jiaqizho/subscriptions",
                "organizations_url": "https://api.github.com/users/jiaqizho/orgs",
                "repos_url": "https://api.github.com/users/jiaqizho/repos",
                "events_url": "https://api.github.com/users/jiaqizho/events{/privacy}",
                "received_events_url": "https://api.github.com/users/jiaqizho/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2015-09-30T17:46:42Z",
            "updated_at": "2015-09-30T17:46:42Z",
            "author_association": "NONE",
            "body": "@davidism \n\u4e2d\u6587 : \u8fd9\u4ee3\u7801\u662f\u6211\u6539\u7684,ctx.py , \u4f60\u8bf4\u7684\u5b8c\u5168\u662f\u778e\u9e21\u5df4\u56de\u7684.\n\nthis code is from ctx.py which i changed , before i changed , the decorator require the request context , but i only get the app context from the docs . so you know nothing about  it \n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/152801829",
            "html_url": "https://github.com/pallets/flask/issues/1576#issuecomment-152801829",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1576",
            "id": 152801829,
            "node_id": "MDEyOklzc3VlQ29tbWVudDE1MjgwMTgyOQ==",
            "user": {
                "login": "ThiefMaster",
                "id": 179599,
                "node_id": "MDQ6VXNlcjE3OTU5OQ==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/179599?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/ThiefMaster",
                "html_url": "https://github.com/ThiefMaster",
                "followers_url": "https://api.github.com/users/ThiefMaster/followers",
                "following_url": "https://api.github.com/users/ThiefMaster/following{/other_user}",
                "gists_url": "https://api.github.com/users/ThiefMaster/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/ThiefMaster/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ThiefMaster/subscriptions",
                "organizations_url": "https://api.github.com/users/ThiefMaster/orgs",
                "repos_url": "https://api.github.com/users/ThiefMaster/repos",
                "events_url": "https://api.github.com/users/ThiefMaster/events{/privacy}",
                "received_events_url": "https://api.github.com/users/ThiefMaster/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2015-11-01T07:06:42Z",
            "updated_at": "2018-10-06T03:09:36Z",
            "author_association": "MEMBER",
            "body": "Seriously? You couldn't even be bothered to format all your code properly and post a rather unclear issue and then start insulting people?\n"
        }
    ]
}
{
    "url": "https://api.github.com/repos/pallets/flask/issues/2468",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/2468/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/2468/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/2468/events",
    "html_url": "https://github.com/pallets/flask/issues/2468",
    "id": 256206011,
    "node_id": "MDU6SXNzdWUyNTYyMDYwMTE=",
    "number": 2468,
    "title": "helpers.send_file doesn't close file",
    "user": {
        "login": "xliiv",
        "id": 298994,
        "node_id": "MDQ6VXNlcjI5ODk5NA==",
        "avatar_url": "https://avatars3.githubusercontent.com/u/298994?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/xliiv",
        "html_url": "https://github.com/xliiv",
        "followers_url": "https://api.github.com/users/xliiv/followers",
        "following_url": "https://api.github.com/users/xliiv/following{/other_user}",
        "gists_url": "https://api.github.com/users/xliiv/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/xliiv/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/xliiv/subscriptions",
        "organizations_url": "https://api.github.com/users/xliiv/orgs",
        "repos_url": "https://api.github.com/users/xliiv/repos",
        "events_url": "https://api.github.com/users/xliiv/events{/privacy}",
        "received_events_url": "https://api.github.com/users/xliiv/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 3,
    "created_at": "2017-09-08T10:11:45Z",
    "updated_at": "2019-08-02T18:14:53Z",
    "closed_at": "2017-09-22T01:01:52Z",
    "author_association": "NONE",
    "body": "### Expected Behavior\r\n`send_file` closes the file which it opens\r\nhttps://github.com/pallets/flask/blob/0.12.2/flask/helpers.py#L549\r\n\r\n### Actual Behavior\r\n\r\nFile is not closed.\r\nTests are yelling:\r\n`tests2.py:14: ResourceWarning: unclosed file <_io.BufferedReader name='path/tests2.py'>`\r\n\r\n```\r\n> python3 tests2.py \r\ntests2.py:14: ResourceWarning: unclosed file <_io.BufferedReader name='path/tests2.py'>\r\n  self.client.get('/')\r\n.\r\n----------------------------------------------------------------------\r\nRan 1 test in 0.012s\r\n\r\nOK\r\n\r\n> cat tests2.py \r\nimport unittest\r\nfrom flask import Flask\r\nfrom flask import current_app, send_from_directory\r\napp = Flask(__name__)\r\n\r\n@app.route(\"/\")\r\ndef hello():\r\n    return send_from_directory('.', __file__)\r\n\r\nclass TestCase(unittest.TestCase):\r\n    def test_x(self):\r\n        self.client = app.test_client()\r\n\r\n        self.client.get('/')\r\n\r\n\r\nif __name__ == '__main__':\r\n    unittest.main()\r\n```\r\n\r\n### Environment\r\n\r\n* Python version: Python 3.5.3\r\n* Flask version: Flask==0.12.2\r\n* Werkzeug version: Werkzeug==0.12.2\r\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/331321203",
            "html_url": "https://github.com/pallets/flask/issues/2468#issuecomment-331321203",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2468",
            "id": 331321203,
            "node_id": "MDEyOklzc3VlQ29tbWVudDMzMTMyMTIwMw==",
            "user": {
                "login": "adamrt",
                "id": 58468,
                "node_id": "MDQ6VXNlcjU4NDY4",
                "avatar_url": "https://avatars3.githubusercontent.com/u/58468?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/adamrt",
                "html_url": "https://github.com/adamrt",
                "followers_url": "https://api.github.com/users/adamrt/followers",
                "following_url": "https://api.github.com/users/adamrt/following{/other_user}",
                "gists_url": "https://api.github.com/users/adamrt/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/adamrt/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/adamrt/subscriptions",
                "organizations_url": "https://api.github.com/users/adamrt/orgs",
                "repos_url": "https://api.github.com/users/adamrt/repos",
                "events_url": "https://api.github.com/users/adamrt/events{/privacy}",
                "received_events_url": "https://api.github.com/users/adamrt/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2017-09-22T00:57:00Z",
            "updated_at": "2017-09-22T00:57:00Z",
            "author_association": "NONE",
            "body": "I tried your test on my local python2 (OS X 10.11.6 / Python 2.7.13) and in docker on your version (3.5.3) and both worked without issue.\r\n\r\n    # docker run --rm -v `pwd`:/tmp/ python:3.5.3 /bin/bash -c \"pip install flask && python3 /tmp/tests2.py\"\r\n    .\r\n    ----------------------------------------------------------------------\r\n    Ran 1 test in 0.014s\r\n\r\n    OK"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/331321836",
            "html_url": "https://github.com/pallets/flask/issues/2468#issuecomment-331321836",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2468",
            "id": 331321836,
            "node_id": "MDEyOklzc3VlQ29tbWVudDMzMTMyMTgzNg==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2017-09-22T01:01:51Z",
            "updated_at": "2017-09-22T01:01:51Z",
            "author_association": "MEMBER",
            "body": "People misunderstand the fact that `send_file` opens the file but doesn't close it. Other parts of the WSGI flow will close files after the response is built, so that things like streaming work.\r\n\r\nThere are some cases where tests will raise this warning because other tests failed, but it's not really an issue because tests end, the file doesn't stay open. As far as I can tell, the test suite has cases for this already and passes."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/517797518",
            "html_url": "https://github.com/pallets/flask/issues/2468#issuecomment-517797518",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2468",
            "id": 517797518,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUxNzc5NzUxOA==",
            "user": {
                "login": "pbatey",
                "id": 4576901,
                "node_id": "MDQ6VXNlcjQ1NzY5MDE=",
                "avatar_url": "https://avatars0.githubusercontent.com/u/4576901?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/pbatey",
                "html_url": "https://github.com/pbatey",
                "followers_url": "https://api.github.com/users/pbatey/followers",
                "following_url": "https://api.github.com/users/pbatey/following{/other_user}",
                "gists_url": "https://api.github.com/users/pbatey/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/pbatey/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/pbatey/subscriptions",
                "organizations_url": "https://api.github.com/users/pbatey/orgs",
                "repos_url": "https://api.github.com/users/pbatey/repos",
                "events_url": "https://api.github.com/users/pbatey/events{/privacy}",
                "received_events_url": "https://api.github.com/users/pbatey/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-08-02T18:14:53Z",
            "updated_at": "2019-08-02T18:14:53Z",
            "author_association": "NONE",
            "body": "I found that closing the response from the test client addressed the `ResourceWarning: unclosed file <_io.BufferedReader` I was getting:\r\n\r\n```\r\nresponse = self.client.get('/')\r\nself.assertEqual(response.status_code, 200)\r\nresponse.close()\r\n```"
        }
    ]
}
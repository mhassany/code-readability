{
    "url": "https://api.github.com/repos/pallets/flask/issues/1129",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/1129/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/1129/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/1129/events",
    "html_url": "https://github.com/pallets/flask/issues/1129",
    "id": 38421649,
    "node_id": "MDU6SXNzdWUzODQyMTY0OQ==",
    "number": 1129,
    "title": "url_for _external does not use PREFERRED_URL_SCHEME",
    "user": {
        "login": "philipithomas",
        "id": 1312414,
        "node_id": "MDQ6VXNlcjEzMTI0MTQ=",
        "avatar_url": "https://avatars0.githubusercontent.com/u/1312414?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/philipithomas",
        "html_url": "https://github.com/philipithomas",
        "followers_url": "https://api.github.com/users/philipithomas/followers",
        "following_url": "https://api.github.com/users/philipithomas/following{/other_user}",
        "gists_url": "https://api.github.com/users/philipithomas/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/philipithomas/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/philipithomas/subscriptions",
        "organizations_url": "https://api.github.com/users/philipithomas/orgs",
        "repos_url": "https://api.github.com/users/philipithomas/repos",
        "events_url": "https://api.github.com/users/philipithomas/events{/privacy}",
        "received_events_url": "https://api.github.com/users/philipithomas/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 5,
    "created_at": "2014-07-22T17:10:49Z",
    "updated_at": "2014-09-29T07:22:34Z",
    "closed_at": "2014-08-12T18:46:56Z",
    "author_association": "NONE",
    "body": "To reproduce:\n\n1) set a PREFERRED_URL_SCHEME in the app config != http\n2) Use a url_for with _external=True\n3) Note that the URL does not use the PREFERRED_URL_SCHEME\n\nNotes: I'm using blueprints and Flask version 0.10.1\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/51324675",
            "html_url": "https://github.com/pallets/flask/issues/1129#issuecomment-51324675",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1129",
            "id": 51324675,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUxMzI0Njc1",
            "user": {
                "login": "iurisilvio",
                "id": 105852,
                "node_id": "MDQ6VXNlcjEwNTg1Mg==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/105852?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/iurisilvio",
                "html_url": "https://github.com/iurisilvio",
                "followers_url": "https://api.github.com/users/iurisilvio/followers",
                "following_url": "https://api.github.com/users/iurisilvio/following{/other_user}",
                "gists_url": "https://api.github.com/users/iurisilvio/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/iurisilvio/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/iurisilvio/subscriptions",
                "organizations_url": "https://api.github.com/users/iurisilvio/orgs",
                "repos_url": "https://api.github.com/users/iurisilvio/repos",
                "events_url": "https://api.github.com/users/iurisilvio/events{/privacy}",
                "received_events_url": "https://api.github.com/users/iurisilvio/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2014-08-06T11:53:29Z",
            "updated_at": "2014-08-06T12:09:07Z",
            "author_association": "NONE",
            "body": "In a request context, it uses the request scheme instead of the `PREFERRED_URL_SCHEME`.\n\nDocumentation definitely is not clear:\n\n> PREFERRED_URL_SCHEME: The URL scheme that should be used for URL generation if no URL scheme is available. This defaults to http.\n\n``` python\n>>> from flask import Flask, url_for\n>>> app = Flask(__name__)\n>>> @app.route('/')\n>>> def func():\n...    pass\n>>> app.config['PREFERRED_URL_SCHEME'] = 'https'\n>>> app.config['SERVER_NAME'] = 'example.com'\n>>> with app.app_context():\n...    print url_for('func', _external=True)\nhttps://example.com/\n>>> with app.test_request_context():\n...    print url_for('func', _external=True)\nhttp://example.com/\n```\n\nI'm not sure if it is the expected behaviour. I don't like it either. If you want always want https urls:\n\n``` python\nimport functools\nurl_for = functools.partial(url_for, _scheme='https')\n```\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/51353137",
            "html_url": "https://github.com/pallets/flask/issues/1129#issuecomment-51353137",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1129",
            "id": 51353137,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUxMzUzMTM3",
            "user": {
                "login": "philipithomas",
                "id": 1312414,
                "node_id": "MDQ6VXNlcjEzMTI0MTQ=",
                "avatar_url": "https://avatars0.githubusercontent.com/u/1312414?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/philipithomas",
                "html_url": "https://github.com/philipithomas",
                "followers_url": "https://api.github.com/users/philipithomas/followers",
                "following_url": "https://api.github.com/users/philipithomas/following{/other_user}",
                "gists_url": "https://api.github.com/users/philipithomas/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/philipithomas/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/philipithomas/subscriptions",
                "organizations_url": "https://api.github.com/users/philipithomas/orgs",
                "repos_url": "https://api.github.com/users/philipithomas/repos",
                "events_url": "https://api.github.com/users/philipithomas/events{/privacy}",
                "received_events_url": "https://api.github.com/users/philipithomas/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2014-08-06T15:43:05Z",
            "updated_at": "2014-08-06T15:43:05Z",
            "author_association": "NONE",
            "body": "Great, thanks. This is particularly important if flask is behind a load balancer that terminates SSL because the request Flask sees could be HTTP and overriding the external URL structure that really should be SSL. \n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/51366606",
            "html_url": "https://github.com/pallets/flask/issues/1129#issuecomment-51366606",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1129",
            "id": 51366606,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUxMzY2NjA2",
            "user": {
                "login": "untitaker",
                "id": 837573,
                "node_id": "MDQ6VXNlcjgzNzU3Mw==",
                "avatar_url": "https://avatars0.githubusercontent.com/u/837573?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/untitaker",
                "html_url": "https://github.com/untitaker",
                "followers_url": "https://api.github.com/users/untitaker/followers",
                "following_url": "https://api.github.com/users/untitaker/following{/other_user}",
                "gists_url": "https://api.github.com/users/untitaker/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/untitaker/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/untitaker/subscriptions",
                "organizations_url": "https://api.github.com/users/untitaker/orgs",
                "repos_url": "https://api.github.com/users/untitaker/repos",
                "events_url": "https://api.github.com/users/untitaker/events{/privacy}",
                "received_events_url": "https://api.github.com/users/untitaker/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2014-08-06T17:17:51Z",
            "updated_at": "2014-08-06T17:17:51Z",
            "author_association": "MEMBER",
            "body": "@philipithomas That's almost certainly the wrong fix for your problem, which probably could be solved by middleware such as [`ProxyFix`](http://werkzeug.pocoo.org/docs/contrib/fixers/#werkzeug.contrib.fixers.ProxyFix).\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/51759359",
            "html_url": "https://github.com/pallets/flask/issues/1129#issuecomment-51759359",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1129",
            "id": 51759359,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUxNzU5MzU5",
            "user": {
                "login": "DasIch",
                "id": 182316,
                "node_id": "MDQ6VXNlcjE4MjMxNg==",
                "avatar_url": "https://avatars0.githubusercontent.com/u/182316?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/DasIch",
                "html_url": "https://github.com/DasIch",
                "followers_url": "https://api.github.com/users/DasIch/followers",
                "following_url": "https://api.github.com/users/DasIch/following{/other_user}",
                "gists_url": "https://api.github.com/users/DasIch/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/DasIch/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/DasIch/subscriptions",
                "organizations_url": "https://api.github.com/users/DasIch/orgs",
                "repos_url": "https://api.github.com/users/DasIch/repos",
                "events_url": "https://api.github.com/users/DasIch/events{/privacy}",
                "received_events_url": "https://api.github.com/users/DasIch/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2014-08-11T09:37:05Z",
            "updated_at": "2014-08-11T09:37:05Z",
            "author_association": "CONTRIBUTOR",
            "body": "The documentation by itself is not clear but the behaviour in combination makes the intention obvious. Within a request context a schema is available - the one used by the client - and schema is used by `url_for`. If no request is available, `url_for` uses what's preferred.\n\nAlways using the preferred schema - even when another schema is available - is clearly not what's intended.\n\nSo the solution for this issue in particular should be to improve the documentation and not the code.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/51780875",
            "html_url": "https://github.com/pallets/flask/issues/1129#issuecomment-51780875",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1129",
            "id": 51780875,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUxNzgwODc1",
            "user": {
                "login": "iurisilvio",
                "id": 105852,
                "node_id": "MDQ6VXNlcjEwNTg1Mg==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/105852?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/iurisilvio",
                "html_url": "https://github.com/iurisilvio",
                "followers_url": "https://api.github.com/users/iurisilvio/followers",
                "following_url": "https://api.github.com/users/iurisilvio/following{/other_user}",
                "gists_url": "https://api.github.com/users/iurisilvio/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/iurisilvio/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/iurisilvio/subscriptions",
                "organizations_url": "https://api.github.com/users/iurisilvio/orgs",
                "repos_url": "https://api.github.com/users/iurisilvio/repos",
                "events_url": "https://api.github.com/users/iurisilvio/events{/privacy}",
                "received_events_url": "https://api.github.com/users/iurisilvio/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2014-08-11T13:39:42Z",
            "updated_at": "2014-08-11T13:39:42Z",
            "author_association": "NONE",
            "body": "I agree. The documentation improvement is a good solution.\n"
        }
    ]
}
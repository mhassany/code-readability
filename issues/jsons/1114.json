{
    "url": "https://api.github.com/repos/pallets/flask/issues/1114",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/1114/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/1114/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/1114/events",
    "html_url": "https://github.com/pallets/flask/issues/1114",
    "id": 37719993,
    "node_id": "MDU6SXNzdWUzNzcxOTk5Mw==",
    "number": 1114,
    "title": "Race condition in get_flashed_messages()",
    "user": {
        "login": "peter-conalgo",
        "id": 1482781,
        "node_id": "MDQ6VXNlcjE0ODI3ODE=",
        "avatar_url": "https://avatars3.githubusercontent.com/u/1482781?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/peter-conalgo",
        "html_url": "https://github.com/peter-conalgo",
        "followers_url": "https://api.github.com/users/peter-conalgo/followers",
        "following_url": "https://api.github.com/users/peter-conalgo/following{/other_user}",
        "gists_url": "https://api.github.com/users/peter-conalgo/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/peter-conalgo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/peter-conalgo/subscriptions",
        "organizations_url": "https://api.github.com/users/peter-conalgo/orgs",
        "repos_url": "https://api.github.com/users/peter-conalgo/repos",
        "events_url": "https://api.github.com/users/peter-conalgo/events{/privacy}",
        "received_events_url": "https://api.github.com/users/peter-conalgo/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 7,
    "created_at": "2014-07-12T13:53:34Z",
    "updated_at": "2014-07-15T03:29:46Z",
    "closed_at": "2014-07-12T17:44:30Z",
    "author_association": "NONE",
    "body": "In https://github.com/mitsuhiko/flask/blob/master/flask/helpers.py#L401:\n\n``` python\n_request_ctx_stack.top.flashes = flashes = session.pop('_flashes') \\\n      if '_flashes' in session else []\n```\n\nThis check for the key existence, and then a pop causes a race condition in my system because it is possible for the `_flashes` key to disappear between the check and the pop, leading to a `KeyError`. (I saw it happen under load.)\n\nThe fix is easy: use the \"default\" argument to the `pop`. That path is implemented in an atomic manner in my session code already.\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/48818186",
            "html_url": "https://github.com/pallets/flask/issues/1114#issuecomment-48818186",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1114",
            "id": 48818186,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ4ODE4MTg2",
            "user": {
                "login": "danielchatfield",
                "id": 1058676,
                "node_id": "MDQ6VXNlcjEwNTg2NzY=",
                "avatar_url": "https://avatars3.githubusercontent.com/u/1058676?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/danielchatfield",
                "html_url": "https://github.com/danielchatfield",
                "followers_url": "https://api.github.com/users/danielchatfield/followers",
                "following_url": "https://api.github.com/users/danielchatfield/following{/other_user}",
                "gists_url": "https://api.github.com/users/danielchatfield/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/danielchatfield/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/danielchatfield/subscriptions",
                "organizations_url": "https://api.github.com/users/danielchatfield/orgs",
                "repos_url": "https://api.github.com/users/danielchatfield/repos",
                "events_url": "https://api.github.com/users/danielchatfield/events{/privacy}",
                "received_events_url": "https://api.github.com/users/danielchatfield/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2014-07-12T17:15:50Z",
            "updated_at": "2014-07-12T17:15:50Z",
            "author_association": "NONE",
            "body": "I'm not seeing how this can occur.\n\n`session` is tied to the request context so no other request can possibly alter it.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/48818199",
            "html_url": "https://github.com/pallets/flask/issues/1114#issuecomment-48818199",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1114",
            "id": 48818199,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ4ODE4MTk5",
            "user": {
                "login": "danielchatfield",
                "id": 1058676,
                "node_id": "MDQ6VXNlcjEwNTg2NzY=",
                "avatar_url": "https://avatars3.githubusercontent.com/u/1058676?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/danielchatfield",
                "html_url": "https://github.com/danielchatfield",
                "followers_url": "https://api.github.com/users/danielchatfield/followers",
                "following_url": "https://api.github.com/users/danielchatfield/following{/other_user}",
                "gists_url": "https://api.github.com/users/danielchatfield/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/danielchatfield/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/danielchatfield/subscriptions",
                "organizations_url": "https://api.github.com/users/danielchatfield/orgs",
                "repos_url": "https://api.github.com/users/danielchatfield/repos",
                "events_url": "https://api.github.com/users/danielchatfield/events{/privacy}",
                "received_events_url": "https://api.github.com/users/danielchatfield/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2014-07-12T17:16:36Z",
            "updated_at": "2014-07-12T17:16:36Z",
            "author_association": "NONE",
            "body": "I.E. two different requests have a completely different `sessions` object and one request cannot interfere with another.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/48818966",
            "html_url": "https://github.com/pallets/flask/issues/1114#issuecomment-48818966",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1114",
            "id": 48818966,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ4ODE4OTY2",
            "user": {
                "login": "mitsuhiko",
                "id": 7396,
                "node_id": "MDQ6VXNlcjczOTY=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/7396?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/mitsuhiko",
                "html_url": "https://github.com/mitsuhiko",
                "followers_url": "https://api.github.com/users/mitsuhiko/followers",
                "following_url": "https://api.github.com/users/mitsuhiko/following{/other_user}",
                "gists_url": "https://api.github.com/users/mitsuhiko/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/mitsuhiko/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mitsuhiko/subscriptions",
                "organizations_url": "https://api.github.com/users/mitsuhiko/orgs",
                "repos_url": "https://api.github.com/users/mitsuhiko/repos",
                "events_url": "https://api.github.com/users/mitsuhiko/events{/privacy}",
                "received_events_url": "https://api.github.com/users/mitsuhiko/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2014-07-12T17:44:30Z",
            "updated_at": "2014-07-12T17:44:30Z",
            "author_association": "MEMBER",
            "body": "What @danielchatfield said.  You cannot use multiple threads / greenlets in the same request without manual locking.  That's entirely (and intentionally) not supported.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/48844280",
            "html_url": "https://github.com/pallets/flask/issues/1114#issuecomment-48844280",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1114",
            "id": 48844280,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ4ODQ0Mjgw",
            "user": {
                "login": "peter-conalgo",
                "id": 1482781,
                "node_id": "MDQ6VXNlcjE0ODI3ODE=",
                "avatar_url": "https://avatars3.githubusercontent.com/u/1482781?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/peter-conalgo",
                "html_url": "https://github.com/peter-conalgo",
                "followers_url": "https://api.github.com/users/peter-conalgo/followers",
                "following_url": "https://api.github.com/users/peter-conalgo/following{/other_user}",
                "gists_url": "https://api.github.com/users/peter-conalgo/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/peter-conalgo/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/peter-conalgo/subscriptions",
                "organizations_url": "https://api.github.com/users/peter-conalgo/orgs",
                "repos_url": "https://api.github.com/users/peter-conalgo/repos",
                "events_url": "https://api.github.com/users/peter-conalgo/events{/privacy}",
                "received_events_url": "https://api.github.com/users/peter-conalgo/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2014-07-13T15:58:07Z",
            "updated_at": "2014-07-13T15:58:07Z",
            "author_association": "NONE",
            "body": "Sorry, I should have said that I'm using lots of custom code based loosely on http://flask.pocoo.org/snippets/75/ to store all the session state in a shared Redis instance.\n\nSession data can expire based on time (key expiry) although I don't think that's an issue in this case, and I also have other processes (other than the web server) occasionally interacting with the session via Redis.\n\nMy session object is derived from a [redis-collection Dictionary object](https://redis-collections.readthedocs.org/en/latest/) which re-implements most dict methods either as Redis transactions or atomic operations. So in the end, a `session.pop()` does the right thing to be atomic, but doing this check/pop sequence is quite different.\n\n@mitsuhiko I'm not using threads or greenlets.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/48845065",
            "html_url": "https://github.com/pallets/flask/issues/1114#issuecomment-48845065",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1114",
            "id": 48845065,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ4ODQ1MDY1",
            "user": {
                "login": "DasIch",
                "id": 182316,
                "node_id": "MDQ6VXNlcjE4MjMxNg==",
                "avatar_url": "https://avatars0.githubusercontent.com/u/182316?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/DasIch",
                "html_url": "https://github.com/DasIch",
                "followers_url": "https://api.github.com/users/DasIch/followers",
                "following_url": "https://api.github.com/users/DasIch/following{/other_user}",
                "gists_url": "https://api.github.com/users/DasIch/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/DasIch/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/DasIch/subscriptions",
                "organizations_url": "https://api.github.com/users/DasIch/orgs",
                "repos_url": "https://api.github.com/users/DasIch/repos",
                "events_url": "https://api.github.com/users/DasIch/events{/privacy}",
                "received_events_url": "https://api.github.com/users/DasIch/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2014-07-13T16:26:28Z",
            "updated_at": "2014-07-13T16:26:28Z",
            "author_association": "CONTRIBUTOR",
            "body": "If your code is based on the snippet, the session data cannot expire while a request is being handled. Anything else would be a bad solution.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/48956845",
            "html_url": "https://github.com/pallets/flask/issues/1114#issuecomment-48956845",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1114",
            "id": 48956845,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ4OTU2ODQ1",
            "user": {
                "login": "mitsuhiko",
                "id": 7396,
                "node_id": "MDQ6VXNlcjczOTY=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/7396?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/mitsuhiko",
                "html_url": "https://github.com/mitsuhiko",
                "followers_url": "https://api.github.com/users/mitsuhiko/followers",
                "following_url": "https://api.github.com/users/mitsuhiko/following{/other_user}",
                "gists_url": "https://api.github.com/users/mitsuhiko/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/mitsuhiko/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mitsuhiko/subscriptions",
                "organizations_url": "https://api.github.com/users/mitsuhiko/orgs",
                "repos_url": "https://api.github.com/users/mitsuhiko/repos",
                "events_url": "https://api.github.com/users/mitsuhiko/events{/privacy}",
                "received_events_url": "https://api.github.com/users/mitsuhiko/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2014-07-14T20:43:07Z",
            "updated_at": "2014-07-14T20:43:07Z",
            "author_association": "MEMBER",
            "body": "Do not implement sessions as something that proxies it through to redis directly.  That's a terrible idea and will never work.  You would need to implement it as some sort of MVCC pattern which is what the original snippet does.\n"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/48986657",
            "html_url": "https://github.com/pallets/flask/issues/1114#issuecomment-48986657",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/1114",
            "id": 48986657,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQ4OTg2NjU3",
            "user": {
                "login": "peter-conalgo",
                "id": 1482781,
                "node_id": "MDQ6VXNlcjE0ODI3ODE=",
                "avatar_url": "https://avatars3.githubusercontent.com/u/1482781?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/peter-conalgo",
                "html_url": "https://github.com/peter-conalgo",
                "followers_url": "https://api.github.com/users/peter-conalgo/followers",
                "following_url": "https://api.github.com/users/peter-conalgo/following{/other_user}",
                "gists_url": "https://api.github.com/users/peter-conalgo/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/peter-conalgo/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/peter-conalgo/subscriptions",
                "organizations_url": "https://api.github.com/users/peter-conalgo/orgs",
                "repos_url": "https://api.github.com/users/peter-conalgo/repos",
                "events_url": "https://api.github.com/users/peter-conalgo/events{/privacy}",
                "received_events_url": "https://api.github.com/users/peter-conalgo/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2014-07-15T03:29:46Z",
            "updated_at": "2014-07-15T03:29:46Z",
            "author_association": "NONE",
            "body": "I hear what you're all saying, but surely it's better to write:\n\n``` python\n_request_ctx_stack.top.flashes = flashes = session.pop('_flashes'), [])\n```\n\nrather than:\n\n``` python\n_request_ctx_stack.top.flashes = flashes = session.pop('_flashes') \\\n      if '_flashes' in session else []\n```\n\nYou may treat the fact that is fixes an issue in my specific case as a happy accident.\n\nI felt I had to report this bug because it was so easy to fix and I was happy to have caught a race condition red-handed as it were. I've already fixed my code, so I'm not dependent on this path anymore. Feel free to leave this closed. Thanks for the discussion though.\n"
        }
    ]
}
{
    "url": "https://api.github.com/repos/pallets/flask/issues/3256",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/3256/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/3256/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/3256/events",
    "html_url": "https://github.com/pallets/flask/issues/3256",
    "id": 453893464,
    "node_id": "MDU6SXNzdWU0NTM4OTM0NjQ=",
    "number": 3256,
    "title": "flask run is not compatible with werkzeug middlewares",
    "user": {
        "login": "killthekitten",
        "id": 1201569,
        "node_id": "MDQ6VXNlcjEyMDE1Njk=",
        "avatar_url": "https://avatars3.githubusercontent.com/u/1201569?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/killthekitten",
        "html_url": "https://github.com/killthekitten",
        "followers_url": "https://api.github.com/users/killthekitten/followers",
        "following_url": "https://api.github.com/users/killthekitten/following{/other_user}",
        "gists_url": "https://api.github.com/users/killthekitten/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/killthekitten/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/killthekitten/subscriptions",
        "organizations_url": "https://api.github.com/users/killthekitten/orgs",
        "repos_url": "https://api.github.com/users/killthekitten/repos",
        "events_url": "https://api.github.com/users/killthekitten/events{/privacy}",
        "received_events_url": "https://api.github.com/users/killthekitten/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 6,
    "created_at": "2019-06-09T12:35:22Z",
    "updated_at": "2019-06-09T16:48:37Z",
    "closed_at": "2019-06-09T16:48:37Z",
    "author_association": "NONE",
    "body": "\r\n### Expected Behavior\r\n\r\nWhen using `DispatcherMiddleware` to combine multiple flask apps, I expect to be able to run the app with the following command:\r\n\r\n```bash\r\nFLASK_APP=main:app flask run\r\n```\r\n\r\n```python\r\nfrom flask import Flask\r\nfrom werkzeug.middleware.dispatcher import DispatcherMiddleware\r\n\r\n\r\napi = Flask(\"api\")\r\nadmin = Flask(\"admin\")\r\napp = DispatcherMiddleware(api, {\"/admin\": admin})\r\n```\r\n\r\n### Actual Behavior\r\n\r\nThe `app` object fails the following typecheck:\r\n\r\nhttps://github.com/pallets/flask/blob/d4b688bd035b9704b3168b28fed39c8fcfe3b997/src/flask/cli.py#L198\r\n\r\n```pytb\r\n127.0.0.1 - - [09/Jun/2019 15:16:30] \"GET /admin/ HTTP/1.1\" 500 -\r\nTraceback (most recent call last):\r\n  File \"/Users/nshebanov/.pyenv/versions/3.7.2/lib/python3.7/site-packages/flask/_compat.py\", line 36, in reraise\r\n    raise value\r\n  File \"/Users/nshebanov/.pyenv/versions/3.7.2/lib/python3.7/site-packages/flask/cli.py\", line 199, in find_app_by_string\r\n    module=module.__name__, app_name=app_name\r\nflask.cli.NoAppException: A valid Flask application was not obtained from \"main:app\".\r\n```\r\n\r\n### Environment\r\n\r\n* Python version: 3.7.2\r\n* Flask version: 1.0.3\r\n* Werkzeug version: 0.15.4\r\n\r\n### Suggestion\r\n\r\nDrop the check when FLASK_APP is specified and it is not a factory, or change the check to allow for middlewares (it's hard to imagine such a check though). \r\n\r\nChecking for type `Flask` makes sense within [`find_best_app`](https://github.com/pallets/flask/blob/d4b688bd035b9704b3168b28fed39c8fcfe3b997/src/flask/cli.py#L52) and at the moment of [`call_factory` result evaluation](https://github.com/pallets/flask/blob/master/src/flask/cli.py#L184) within `find_app_by_string`. \r\n\r\n\r\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/500213179",
            "html_url": "https://github.com/pallets/flask/issues/3256#issuecomment-500213179",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3256",
            "id": 500213179,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDIxMzE3OQ==",
            "user": {
                "login": "killthekitten",
                "id": 1201569,
                "node_id": "MDQ6VXNlcjEyMDE1Njk=",
                "avatar_url": "https://avatars3.githubusercontent.com/u/1201569?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/killthekitten",
                "html_url": "https://github.com/killthekitten",
                "followers_url": "https://api.github.com/users/killthekitten/followers",
                "following_url": "https://api.github.com/users/killthekitten/following{/other_user}",
                "gists_url": "https://api.github.com/users/killthekitten/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/killthekitten/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/killthekitten/subscriptions",
                "organizations_url": "https://api.github.com/users/killthekitten/orgs",
                "repos_url": "https://api.github.com/users/killthekitten/repos",
                "events_url": "https://api.github.com/users/killthekitten/events{/privacy}",
                "received_events_url": "https://api.github.com/users/killthekitten/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-06-09T13:39:19Z",
            "updated_at": "2019-06-09T13:39:19Z",
            "author_association": "NONE",
            "body": "I implemented the patch according to the suggestion, and it seems to work with the existing tests, however, I didn't add any new \u2013 there is a [`multiapp`](https://github.com/pallets/flask/blob/d4b688bd035b9704b3168b28fed39c8fcfe3b997/tests/test_apps/cliapp/multiapp.py#L6) example already that isn't covered with tests, so would be great to understand why it's left out, and whether it can/should be extended for this case."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/500214283",
            "html_url": "https://github.com/pallets/flask/issues/3256#issuecomment-500214283",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3256",
            "id": 500214283,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDIxNDI4Mw==",
            "user": {
                "login": "miguelgrinberg",
                "id": 2715854,
                "node_id": "MDQ6VXNlcjI3MTU4NTQ=",
                "avatar_url": "https://avatars0.githubusercontent.com/u/2715854?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/miguelgrinberg",
                "html_url": "https://github.com/miguelgrinberg",
                "followers_url": "https://api.github.com/users/miguelgrinberg/followers",
                "following_url": "https://api.github.com/users/miguelgrinberg/following{/other_user}",
                "gists_url": "https://api.github.com/users/miguelgrinberg/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/miguelgrinberg/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/miguelgrinberg/subscriptions",
                "organizations_url": "https://api.github.com/users/miguelgrinberg/orgs",
                "repos_url": "https://api.github.com/users/miguelgrinberg/repos",
                "events_url": "https://api.github.com/users/miguelgrinberg/events{/privacy}",
                "received_events_url": "https://api.github.com/users/miguelgrinberg/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-06-09T13:58:20Z",
            "updated_at": "2019-06-09T13:58:20Z",
            "author_association": "MEMBER",
            "body": "The WSGI callable for a Flask application is `app.wsgi_app`. Try this:\r\n\r\n```python\r\napp = Flask(\"api\")\r\nadmin = Flask(\"admin\")\r\napp.wsgi_app = DispatcherMiddleware(app.wsgi_app, {\"/admin\": admin})\r\n```\r\n\r\nSee [the docs](http://flask.pocoo.org/docs/1.0/api/#flask.Flask.wsgi_app)."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/500215368",
            "html_url": "https://github.com/pallets/flask/issues/3256#issuecomment-500215368",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3256",
            "id": 500215368,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDIxNTM2OA==",
            "user": {
                "login": "killthekitten",
                "id": 1201569,
                "node_id": "MDQ6VXNlcjEyMDE1Njk=",
                "avatar_url": "https://avatars3.githubusercontent.com/u/1201569?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/killthekitten",
                "html_url": "https://github.com/killthekitten",
                "followers_url": "https://api.github.com/users/killthekitten/followers",
                "following_url": "https://api.github.com/users/killthekitten/following{/other_user}",
                "gists_url": "https://api.github.com/users/killthekitten/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/killthekitten/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/killthekitten/subscriptions",
                "organizations_url": "https://api.github.com/users/killthekitten/orgs",
                "repos_url": "https://api.github.com/users/killthekitten/repos",
                "events_url": "https://api.github.com/users/killthekitten/events{/privacy}",
                "received_events_url": "https://api.github.com/users/killthekitten/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-06-09T14:14:28Z",
            "updated_at": "2019-06-09T14:14:44Z",
            "author_association": "NONE",
            "body": "I could do that too but it feels... a hack? It obviously doesn't do any harm, but still. \r\n\r\nAlso, the current behavior makes the [application dispatching example](http://flask.pocoo.org/docs/1.0/patterns/appdispatch/#combining-applications) from docs technically broken. "
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/500217747",
            "html_url": "https://github.com/pallets/flask/issues/3256#issuecomment-500217747",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3256",
            "id": 500217747,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDIxNzc0Nw==",
            "user": {
                "login": "miguelgrinberg",
                "id": 2715854,
                "node_id": "MDQ6VXNlcjI3MTU4NTQ=",
                "avatar_url": "https://avatars0.githubusercontent.com/u/2715854?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/miguelgrinberg",
                "html_url": "https://github.com/miguelgrinberg",
                "followers_url": "https://api.github.com/users/miguelgrinberg/followers",
                "following_url": "https://api.github.com/users/miguelgrinberg/following{/other_user}",
                "gists_url": "https://api.github.com/users/miguelgrinberg/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/miguelgrinberg/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/miguelgrinberg/subscriptions",
                "organizations_url": "https://api.github.com/users/miguelgrinberg/orgs",
                "repos_url": "https://api.github.com/users/miguelgrinberg/repos",
                "events_url": "https://api.github.com/users/miguelgrinberg/events{/privacy}",
                "received_events_url": "https://api.github.com/users/miguelgrinberg/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-06-09T14:48:43Z",
            "updated_at": "2019-06-09T14:48:43Z",
            "author_association": "MEMBER",
            "body": "@killthekitten the solution I pointed you at is the recommended way to do this. The `wsgi_app` attribute has been in Flask for ages and it was created explicitly to prevent the Flask app instance from being buried under a potentially long chain of middlewares.\r\n\r\nThe solution that you are proposing breaks the CLI, by the way. If your `api` application has any custom CLI commands, those are gone once you add the dispatcher middleware. Do it in the recommended way with `wsgi_app` and the commands remain accessible."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/500224643",
            "html_url": "https://github.com/pallets/flask/issues/3256#issuecomment-500224643",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3256",
            "id": 500224643,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDIyNDY0Mw==",
            "user": {
                "login": "RonnyPfannschmidt",
                "id": 156838,
                "node_id": "MDQ6VXNlcjE1NjgzOA==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/156838?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/RonnyPfannschmidt",
                "html_url": "https://github.com/RonnyPfannschmidt",
                "followers_url": "https://api.github.com/users/RonnyPfannschmidt/followers",
                "following_url": "https://api.github.com/users/RonnyPfannschmidt/following{/other_user}",
                "gists_url": "https://api.github.com/users/RonnyPfannschmidt/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/RonnyPfannschmidt/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/RonnyPfannschmidt/subscriptions",
                "organizations_url": "https://api.github.com/users/RonnyPfannschmidt/orgs",
                "repos_url": "https://api.github.com/users/RonnyPfannschmidt/repos",
                "events_url": "https://api.github.com/users/RonnyPfannschmidt/events{/privacy}",
                "received_events_url": "https://api.github.com/users/RonnyPfannschmidt/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-06-09T16:04:38Z",
            "updated_at": "2019-06-09T16:04:38Z",
            "author_association": "CONTRIBUTOR",
            "body": "the example is correct\r\n\r\nflask.run uses Flask applications, the examples explicitly use wsgi server dispatching\r\n\r\nthe documented method to apply a wsgi  middleware to the wsgi details of an application is to replace the attribute as documented (its a necessary evil as wsgi middleware itself is a \"decorator/proxy style pattern\")"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/500227754",
            "html_url": "https://github.com/pallets/flask/issues/3256#issuecomment-500227754",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3256",
            "id": 500227754,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDIyNzc1NA==",
            "user": {
                "login": "killthekitten",
                "id": 1201569,
                "node_id": "MDQ6VXNlcjEyMDE1Njk=",
                "avatar_url": "https://avatars3.githubusercontent.com/u/1201569?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/killthekitten",
                "html_url": "https://github.com/killthekitten",
                "followers_url": "https://api.github.com/users/killthekitten/followers",
                "following_url": "https://api.github.com/users/killthekitten/following{/other_user}",
                "gists_url": "https://api.github.com/users/killthekitten/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/killthekitten/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/killthekitten/subscriptions",
                "organizations_url": "https://api.github.com/users/killthekitten/orgs",
                "repos_url": "https://api.github.com/users/killthekitten/repos",
                "events_url": "https://api.github.com/users/killthekitten/events{/privacy}",
                "received_events_url": "https://api.github.com/users/killthekitten/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-06-09T16:48:37Z",
            "updated_at": "2019-06-09T16:48:37Z",
            "author_association": "NONE",
            "body": "\ud83d\udc4d thanks for the details guys. I guess I'll have to live with it."
        }
    ]
}
{
    "url": "https://api.github.com/repos/pallets/flask/issues/2900",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/2900/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/2900/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/2900/events",
    "html_url": "https://github.com/pallets/flask/issues/2900",
    "id": 356245153,
    "node_id": "MDU6SXNzdWUzNTYyNDUxNTM=",
    "number": 2900,
    "title": "avoid creating a new app context when using json argument in test client",
    "user": {
        "login": "mbarakaja",
        "id": 7861175,
        "node_id": "MDQ6VXNlcjc4NjExNzU=",
        "avatar_url": "https://avatars0.githubusercontent.com/u/7861175?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mbarakaja",
        "html_url": "https://github.com/mbarakaja",
        "followers_url": "https://api.github.com/users/mbarakaja/followers",
        "following_url": "https://api.github.com/users/mbarakaja/following{/other_user}",
        "gists_url": "https://api.github.com/users/mbarakaja/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/mbarakaja/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mbarakaja/subscriptions",
        "organizations_url": "https://api.github.com/users/mbarakaja/orgs",
        "repos_url": "https://api.github.com/users/mbarakaja/repos",
        "events_url": "https://api.github.com/users/mbarakaja/events{/privacy}",
        "received_events_url": "https://api.github.com/users/mbarakaja/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [
        {
            "id": 398831866,
            "node_id": "MDU6TGFiZWwzOTg4MzE4NjY=",
            "url": "https://api.github.com/repos/pallets/flask/labels/json",
            "name": "json",
            "color": "1d76db",
            "default": false,
            "description": null
        },
        {
            "id": 386620463,
            "node_id": "MDU6TGFiZWwzODY2MjA0NjM=",
            "url": "https://api.github.com/repos/pallets/flask/labels/testing",
            "name": "testing",
            "color": "006b75",
            "default": false,
            "description": null
        }
    ],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": {
        "url": "https://api.github.com/repos/pallets/flask/milestones/7",
        "html_url": "https://github.com/pallets/flask/milestone/7",
        "labels_url": "https://api.github.com/repos/pallets/flask/milestones/7/labels",
        "id": 3354647,
        "node_id": "MDk6TWlsZXN0b25lMzM1NDY0Nw==",
        "number": 7,
        "title": "1.0.3",
        "description": "",
        "creator": {
            "login": "davidism",
            "id": 1242887,
            "node_id": "MDQ6VXNlcjEyNDI4ODc=",
            "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/davidism",
            "html_url": "https://github.com/davidism",
            "followers_url": "https://api.github.com/users/davidism/followers",
            "following_url": "https://api.github.com/users/davidism/following{/other_user}",
            "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
            "organizations_url": "https://api.github.com/users/davidism/orgs",
            "repos_url": "https://api.github.com/users/davidism/repos",
            "events_url": "https://api.github.com/users/davidism/events{/privacy}",
            "received_events_url": "https://api.github.com/users/davidism/received_events",
            "type": "User",
            "site_admin": false
        },
        "open_issues": 0,
        "closed_issues": 31,
        "state": "closed",
        "created_at": "2018-05-17T13:23:45Z",
        "updated_at": "2019-05-17T17:43:44Z",
        "due_on": null,
        "closed_at": "2019-05-17T17:43:44Z"
    },
    "comments": 5,
    "created_at": "2018-09-02T01:36:15Z",
    "updated_at": "2019-05-17T16:05:43Z",
    "closed_at": "2019-05-17T16:05:43Z",
    "author_association": "NONE",
    "body": "At this moment, when a Flask test client method uses the **json** argument, a new application context is created in the line below.\r\n\r\nhttps://github.com/pallets/flask/blob/b9b88b0cdf70190dee5c7d31a83efb1cae888a63/flask/testing.py#L82\r\n\r\nThe problem is that when the above created context goes out of scope, anything registered to `teardown_appcontext` is called. This is the case of Flask-SQLAlchemy, which remove the current session when that happens.\r\n\r\nThis is problematic is some tests scenarios.\r\n\r\nI am using PostgreSQL SAVEPOINT to rollback any changes made by a test case. My approach is similar to this example provided by [SQLAlchemy here](http://docs.sqlalchemy.org/en/latest/orm/session_transaction.html#joining-a-session-into-an-external-transaction-such-as-for-test-suites), so I'm not going to put all my code here, just a shallow example.\r\n\r\nI have a class that creates a nested transaction and rollback everything when needed.\r\n\r\n```python\r\nclient = app.test_client()\r\ntrn = TransactionManager(database)\r\n\r\nwith app.app_context():\r\n    trn.start() # start a new nested transaction\r\n\r\n    client.post('/products', data=json.dumps({'name': 'Cake'}))\r\n    client.get('/products')\r\n    \r\n    trn.end() # Rollback before the session is removed.\r\n```\r\n\r\nThe above works well because everything happens inside the same transaction and each test client interaction can see changes made to the database by previous client calls.\r\n\r\nBut using the **`json`** argument, the POST call will first create an application context, which immediately will go out of scope making Flask-SQLAlchemy's `teardown_appcontext` registered function **remove the current session before the next client call**, making each database interaction in a different transaction.\r\n\r\nWhy do we need an application context to dump the JSON string?\r\nhttps://github.com/pallets/flask/blob/b9b88b0cdf70190dee5c7d31a83efb1cae888a63/flask/testing.py#L83\r\n\r\n\r\nI don't understand, but if the the above logic is necessary I think the code should check first if there is an application context pushed already using **`has_app_context`**.\r\n\r\nAm I doing something wrong or I am missing something?\r\n\r\n\r\n\r\n\r\n\r\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/423299861",
            "html_url": "https://github.com/pallets/flask/issues/2900#issuecomment-423299861",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2900",
            "id": 423299861,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQyMzI5OTg2MQ==",
            "user": {
                "login": "kumy",
                "id": 176794,
                "node_id": "MDQ6VXNlcjE3Njc5NA==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/176794?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/kumy",
                "html_url": "https://github.com/kumy",
                "followers_url": "https://api.github.com/users/kumy/followers",
                "following_url": "https://api.github.com/users/kumy/following{/other_user}",
                "gists_url": "https://api.github.com/users/kumy/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/kumy/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/kumy/subscriptions",
                "organizations_url": "https://api.github.com/users/kumy/orgs",
                "repos_url": "https://api.github.com/users/kumy/repos",
                "events_url": "https://api.github.com/users/kumy/events{/privacy}",
                "received_events_url": "https://api.github.com/users/kumy/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-09-20T19:13:13Z",
            "updated_at": "2018-09-22T16:08:20Z",
            "author_association": "NONE",
            "body": "Hi, I passed hours trying to find why my blended objects were detached from the session just after using `get()` function. I finally reached to the same problematic line. Removing the context creation or replacing it with `test_request_context` fixed my problem.\r\n\r\nWhat do Flask gurus think about the current implementation?\r\nhttps://github.com/pallets/flask/blob/c92001d2fbaf4d5aa43bd44e56416ed27313377c/flask/testing.py#L81-L86"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/423731719",
            "html_url": "https://github.com/pallets/flask/issues/2900#issuecomment-423731719",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2900",
            "id": 423731719,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQyMzczMTcxOQ==",
            "user": {
                "login": "garenchan",
                "id": 13200012,
                "node_id": "MDQ6VXNlcjEzMjAwMDEy",
                "avatar_url": "https://avatars2.githubusercontent.com/u/13200012?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/garenchan",
                "html_url": "https://github.com/garenchan",
                "followers_url": "https://api.github.com/users/garenchan/followers",
                "following_url": "https://api.github.com/users/garenchan/following{/other_user}",
                "gists_url": "https://api.github.com/users/garenchan/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/garenchan/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/garenchan/subscriptions",
                "organizations_url": "https://api.github.com/users/garenchan/orgs",
                "repos_url": "https://api.github.com/users/garenchan/repos",
                "events_url": "https://api.github.com/users/garenchan/events{/privacy}",
                "received_events_url": "https://api.github.com/users/garenchan/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-09-22T09:55:59Z",
            "updated_at": "2018-09-23T08:19:13Z",
            "author_association": "CONTRIBUTOR",
            "body": "I think this may be better than using ``test_request_context``:\r\n```\r\nfrom flask import current_app\r\n\r\ntry:\r\n    push_ctx = current_app is not app\r\n    if push_ctx:\r\n        ctx = app.app_context()\r\n        ctx.push()\r\n\r\n    kwargs['data'] = json_dumps(kwargs.pop('json'))\r\nfinally:\r\n    if push_ctx:\r\n        ctx.pop()\r\n```"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/423752915",
            "html_url": "https://github.com/pallets/flask/issues/2900#issuecomment-423752915",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2900",
            "id": 423752915,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQyMzc1MjkxNQ==",
            "user": {
                "login": "mbarakaja",
                "id": 7861175,
                "node_id": "MDQ6VXNlcjc4NjExNzU=",
                "avatar_url": "https://avatars0.githubusercontent.com/u/7861175?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/mbarakaja",
                "html_url": "https://github.com/mbarakaja",
                "followers_url": "https://api.github.com/users/mbarakaja/followers",
                "following_url": "https://api.github.com/users/mbarakaja/following{/other_user}",
                "gists_url": "https://api.github.com/users/mbarakaja/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/mbarakaja/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mbarakaja/subscriptions",
                "organizations_url": "https://api.github.com/users/mbarakaja/orgs",
                "repos_url": "https://api.github.com/users/mbarakaja/repos",
                "events_url": "https://api.github.com/users/mbarakaja/events{/privacy}",
                "received_events_url": "https://api.github.com/users/mbarakaja/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-09-22T15:44:00Z",
            "updated_at": "2018-09-22T15:44:00Z",
            "author_association": "NONE",
            "body": "@kumy Did you test your code?.\r\n\r\nThe Flask test client and `test_request_context` use [`make_test_environ_builder`](https://github.com/pallets/flask/blob/0b7a74dda3284b03fac49851eaf130e876f183bd/flask/testing.py#L24) under the hood. So, probably your code is going to end up in a **recursive call**."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/423754231",
            "html_url": "https://github.com/pallets/flask/issues/2900#issuecomment-423754231",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2900",
            "id": 423754231,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQyMzc1NDIzMQ==",
            "user": {
                "login": "kumy",
                "id": 176794,
                "node_id": "MDQ6VXNlcjE3Njc5NA==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/176794?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/kumy",
                "html_url": "https://github.com/kumy",
                "followers_url": "https://api.github.com/users/kumy/followers",
                "following_url": "https://api.github.com/users/kumy/following{/other_user}",
                "gists_url": "https://api.github.com/users/kumy/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/kumy/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/kumy/subscriptions",
                "organizations_url": "https://api.github.com/users/kumy/orgs",
                "repos_url": "https://api.github.com/users/kumy/repos",
                "events_url": "https://api.github.com/users/kumy/events{/privacy}",
                "received_events_url": "https://api.github.com/users/kumy/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-09-22T16:03:52Z",
            "updated_at": "2018-09-22T16:03:52Z",
            "author_association": "NONE",
            "body": "@mbarakaja Yes, it is currently deployed in my dev environment and it works.\r\nI also just tested code from @garenchan and it's also working in my use case."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/435639783",
            "html_url": "https://github.com/pallets/flask/issues/2900#issuecomment-435639783",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2900",
            "id": 435639783,
            "node_id": "MDEyOklzc3VlQ29tbWVudDQzNTYzOTc4Mw==",
            "user": {
                "login": "soundstripe",
                "id": 1015332,
                "node_id": "MDQ6VXNlcjEwMTUzMzI=",
                "avatar_url": "https://avatars3.githubusercontent.com/u/1015332?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/soundstripe",
                "html_url": "https://github.com/soundstripe",
                "followers_url": "https://api.github.com/users/soundstripe/followers",
                "following_url": "https://api.github.com/users/soundstripe/following{/other_user}",
                "gists_url": "https://api.github.com/users/soundstripe/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/soundstripe/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/soundstripe/subscriptions",
                "organizations_url": "https://api.github.com/users/soundstripe/orgs",
                "repos_url": "https://api.github.com/users/soundstripe/repos",
                "events_url": "https://api.github.com/users/soundstripe/events{/privacy}",
                "received_events_url": "https://api.github.com/users/soundstripe/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-11-04T03:49:07Z",
            "updated_at": "2018-11-04T03:49:07Z",
            "author_association": "NONE",
            "body": "I\u2019m in the exact same situation. The double app context teardown is making it difficult to roll back sessions in test environments. Once for jsonify and once again for the actual request. "
        }
    ]
}
{
    "url": "https://api.github.com/repos/pallets/flask/issues/3358",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/3358/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/3358/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/3358/events",
    "html_url": "https://github.com/pallets/flask/issues/3358",
    "id": 491476732,
    "node_id": "MDU6SXNzdWU0OTE0NzY3MzI=",
    "number": 3358,
    "title": "Flask.send_file incorrectly sends blank files",
    "user": {
        "login": "ColdHeat",
        "id": 166333,
        "node_id": "MDQ6VXNlcjE2NjMzMw==",
        "avatar_url": "https://avatars3.githubusercontent.com/u/166333?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ColdHeat",
        "html_url": "https://github.com/ColdHeat",
        "followers_url": "https://api.github.com/users/ColdHeat/followers",
        "following_url": "https://api.github.com/users/ColdHeat/following{/other_user}",
        "gists_url": "https://api.github.com/users/ColdHeat/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/ColdHeat/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ColdHeat/subscriptions",
        "organizations_url": "https://api.github.com/users/ColdHeat/orgs",
        "repos_url": "https://api.github.com/users/ColdHeat/repos",
        "events_url": "https://api.github.com/users/ColdHeat/events{/privacy}",
        "received_events_url": "https://api.github.com/users/ColdHeat/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": {
        "url": "https://api.github.com/repos/pallets/flask/milestones/9",
        "html_url": "https://github.com/pallets/flask/milestone/9",
        "labels_url": "https://api.github.com/repos/pallets/flask/milestones/9/labels",
        "id": 4325529,
        "node_id": "MDk6TWlsZXN0b25lNDMyNTUyOQ==",
        "number": 9,
        "title": "2.0.0",
        "description": "",
        "creator": {
            "login": "davidism",
            "id": 1242887,
            "node_id": "MDQ6VXNlcjEyNDI4ODc=",
            "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/davidism",
            "html_url": "https://github.com/davidism",
            "followers_url": "https://api.github.com/users/davidism/followers",
            "following_url": "https://api.github.com/users/davidism/following{/other_user}",
            "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
            "organizations_url": "https://api.github.com/users/davidism/orgs",
            "repos_url": "https://api.github.com/users/davidism/repos",
            "events_url": "https://api.github.com/users/davidism/events{/privacy}",
            "received_events_url": "https://api.github.com/users/davidism/received_events",
            "type": "User",
            "site_admin": false
        },
        "open_issues": 0,
        "closed_issues": 6,
        "state": "open",
        "created_at": "2019-05-17T17:44:14Z",
        "updated_at": "2019-11-19T17:08:08Z",
        "due_on": null,
        "closed_at": null
    },
    "comments": 4,
    "created_at": "2019-09-10T06:29:55Z",
    "updated_at": "2019-11-19T07:17:07Z",
    "closed_at": "2019-11-19T05:45:18Z",
    "author_association": "NONE",
    "body": "`Flask.send_file` sends blank files when using `io.StringIO` in Python 3. There is a warning that this is wrong but the response code is still 200 but with a blank file. \r\n\r\nTesting this behavior with a test_client will however still result in output. Which doesn't really make sense. \r\n\r\nRelated Info:\r\nhttps://stackoverflow.com/questions/35710361/python-flask-send-file-stringio-blank-files\r\n\r\n### Expected Behavior\r\n\r\n- `Flask.send_file` should accept an `io.StringIO` file object and send it to the browser properly\r\n- `Flask.send_file` should 500 on the the request instead of a blank file\r\n- `app.test_client` shouldn't have data in this setup\r\n\r\nTest Case:\r\nRun in Python 3\r\n```python\r\nimport sys\r\nif sys.version_info >= (3, 0):\r\n    from io import StringIO\r\nelse:\r\n    from StringIO import StringIO\r\n\r\nfrom flask import Flask, send_file\r\nimport csv\r\napp = Flask(__name__)\r\n\r\n@app.route('/')\r\ndef hello_world():\r\n    temp = StringIO()\r\n    writer = csv.writer(temp)\r\n    header = ['test', 'test']\r\n    writer.writerow(header)\r\n\r\n    temp.seek(0)\r\n\r\n    return send_file(\r\n        temp,\r\n        as_attachment=True,\r\n        cache_timeout=-1,\r\n        attachment_filename=\"test.csv\"\r\n    )\r\n\r\napp.test_client()\r\n\r\nwith app.test_client() as c:\r\n    rv = c.get('/')\r\n    print(rv.data)\r\n\r\napp.run(debug=True, threaded=True, host=\"127.0.0.1\", port=4000)\r\n```\r\n```\r\n\u276f python3 test_case.py\r\nb'test,test\\r\\n'\r\n * Serving Flask app \"test_case\" (lazy loading)\r\n * Environment: production\r\n   WARNING: Do not use the development server in a production environment.\r\n   Use a production WSGI server instead.\r\n * Debug mode: on\r\n * Running on http://127.0.0.1:4000/ (Press CTRL+C to quit)\r\n * Restarting with stat\r\nb'test,test\\r\\n'\r\n * Debugger is active!\r\n * Debugger PIN: 881-854-930\r\n127.0.0.1 - - [10/Sep/2019 02:15:54] \"GET / HTTP/1.1\" 200 -\r\nError on request:\r\nTraceback (most recent call last):\r\n  File \"/Users/kchung/.virtualenvs/ctfd3/lib/python3.7/site-packages/werkzeug/serving.py\", line 303, in run_wsgi\r\n    execute(self.server.app)\r\n  File \"/Users/kchung/.virtualenvs/ctfd3/lib/python3.7/site-packages/werkzeug/serving.py\", line 294, in execute\r\n    write(data)\r\n  File \"/Users/kchung/.virtualenvs/ctfd3/lib/python3.7/site-packages/werkzeug/serving.py\", line 274, in write\r\n    assert isinstance(data, bytes), \"applications must write bytes\"\r\nAssertionError: applications must write bytes\r\n```\r\n\r\n```\r\n\u276f curl -vvv http://localhost:4000\r\n* Rebuilt URL to: http://localhost:4000/\r\n*   Trying ::1...\r\n* TCP_NODELAY set\r\n* Connection failed\r\n* connect to ::1 port 4000 failed: Connection refused\r\n*   Trying 127.0.0.1...\r\n* TCP_NODELAY set\r\n* Connected to localhost (127.0.0.1) port 4000 (#0)\r\n> GET / HTTP/1.1\r\n> Host: localhost:4000\r\n> User-Agent: curl/7.54.0\r\n> Accept: */*\r\n>\r\n* HTTP 1.0, assume close after body\r\n< HTTP/1.0 200 OK\r\n< Content-Disposition: attachment; filename=test.csv\r\n< Content-Type: text/csv; charset=utf-8\r\n< Cache-Control: public, max-age=-1\r\n< Expires: Tue, 10 Sep 2019 06:29:28 GMT\r\n< Connection: close\r\n< Server: Werkzeug/0.15.6 Python/3.7.4\r\n< Date: Tue, 10 Sep 2019 06:29:29 GMT\r\n<\r\n* Closing connection 0\r\n```\r\n\r\n### Actual Behavior\r\n- With Python 3 Hitting the endpoint in a browser results in an empty file but in the test_client there is a data response. \r\n\r\n### Environment\r\n\r\n* Python version: 3.7.4\r\n* Flask version: 1.1.1\r\n* Werkzeug version: 0.15.3\r\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/533887383",
            "html_url": "https://github.com/pallets/flask/issues/3358#issuecomment-533887383",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3358",
            "id": 533887383,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUzMzg4NzM4Mw==",
            "user": {
                "login": "wagnerluis1982",
                "id": 428341,
                "node_id": "MDQ6VXNlcjQyODM0MQ==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/428341?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/wagnerluis1982",
                "html_url": "https://github.com/wagnerluis1982",
                "followers_url": "https://api.github.com/users/wagnerluis1982/followers",
                "following_url": "https://api.github.com/users/wagnerluis1982/following{/other_user}",
                "gists_url": "https://api.github.com/users/wagnerluis1982/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/wagnerluis1982/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/wagnerluis1982/subscriptions",
                "organizations_url": "https://api.github.com/users/wagnerluis1982/orgs",
                "repos_url": "https://api.github.com/users/wagnerluis1982/repos",
                "events_url": "https://api.github.com/users/wagnerluis1982/events{/privacy}",
                "received_events_url": "https://api.github.com/users/wagnerluis1982/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-09-22T14:35:55Z",
            "updated_at": "2019-09-22T14:35:55Z",
            "author_association": "NONE",
            "body": "Sorry the spam, I didn't see the PR was from another project..."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/533887535",
            "html_url": "https://github.com/pallets/flask/issues/3358#issuecomment-533887535",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3358",
            "id": 533887535,
            "node_id": "MDEyOklzc3VlQ29tbWVudDUzMzg4NzUzNQ==",
            "user": {
                "login": "wagnerluis1982",
                "id": 428341,
                "node_id": "MDQ6VXNlcjQyODM0MQ==",
                "avatar_url": "https://avatars1.githubusercontent.com/u/428341?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/wagnerluis1982",
                "html_url": "https://github.com/wagnerluis1982",
                "followers_url": "https://api.github.com/users/wagnerluis1982/followers",
                "following_url": "https://api.github.com/users/wagnerluis1982/following{/other_user}",
                "gists_url": "https://api.github.com/users/wagnerluis1982/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/wagnerluis1982/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/wagnerluis1982/subscriptions",
                "organizations_url": "https://api.github.com/users/wagnerluis1982/orgs",
                "repos_url": "https://api.github.com/users/wagnerluis1982/repos",
                "events_url": "https://api.github.com/users/wagnerluis1982/events{/privacy}",
                "received_events_url": "https://api.github.com/users/wagnerluis1982/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-09-22T14:37:57Z",
            "updated_at": "2019-09-22T14:37:57Z",
            "author_association": "NONE",
            "body": "Ok, now entering in the subject, I understand the suggested behavior is not retrocompatible, right?"
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/555343635",
            "html_url": "https://github.com/pallets/flask/issues/3358#issuecomment-555343635",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3358",
            "id": 555343635,
            "node_id": "MDEyOklzc3VlQ29tbWVudDU1NTM0MzYzNQ==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-11-19T05:45:18Z",
            "updated_at": "2019-11-19T05:45:18Z",
            "author_association": "MEMBER",
            "body": "The fact that we support `BytesIO` is not an indication that we should support `StringIO`. `send_file` only expects to be given binary file-like objects. The same issue happens when passing an open file in text mode. The function doesn't deal with encoding, so it wouldn't know how to encode the string to bytes, and I think that should remain up to the user code calling it."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/555352240",
            "html_url": "https://github.com/pallets/flask/issues/3358#issuecomment-555352240",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/3358",
            "id": 555352240,
            "node_id": "MDEyOklzc3VlQ29tbWVudDU1NTM1MjI0MA==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2019-11-19T06:19:56Z",
            "updated_at": "2019-11-19T06:19:56Z",
            "author_association": "MEMBER",
            "body": "Determining if a given file-like object reads bytes appears to be non-trivial, especially with compatibility with Python 2's `file`. It's probably not worth the overhead in general for `send_file`. As a compromise, I can add a mention of the mode to the docs, and raise an error if it's an instance of `io.TextIOBase`, which should cover most cases including the one given here."
        }
    ]
}
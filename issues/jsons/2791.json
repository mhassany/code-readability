{
    "url": "https://api.github.com/repos/pallets/flask/issues/2791",
    "repository_url": "https://api.github.com/repos/pallets/flask",
    "labels_url": "https://api.github.com/repos/pallets/flask/issues/2791/labels{/name}",
    "comments_url": "https://api.github.com/repos/pallets/flask/issues/2791/comments",
    "events_url": "https://api.github.com/repos/pallets/flask/issues/2791/events",
    "html_url": "https://github.com/pallets/flask/issues/2791",
    "id": 324319695,
    "node_id": "MDU6SXNzdWUzMjQzMTk2OTU=",
    "number": 2791,
    "title": "Addition of Click breaks Flask apps in some deployments",
    "user": {
        "login": "fluffy-critter",
        "id": 347162,
        "node_id": "MDQ6VXNlcjM0NzE2Mg==",
        "avatar_url": "https://avatars0.githubusercontent.com/u/347162?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fluffy-critter",
        "html_url": "https://github.com/fluffy-critter",
        "followers_url": "https://api.github.com/users/fluffy-critter/followers",
        "following_url": "https://api.github.com/users/fluffy-critter/following{/other_user}",
        "gists_url": "https://api.github.com/users/fluffy-critter/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/fluffy-critter/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/fluffy-critter/subscriptions",
        "organizations_url": "https://api.github.com/users/fluffy-critter/orgs",
        "repos_url": "https://api.github.com/users/fluffy-critter/repos",
        "events_url": "https://api.github.com/users/fluffy-critter/events{/privacy}",
        "received_events_url": "https://api.github.com/users/fluffy-critter/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": null,
    "assignees": [],
    "milestone": null,
    "comments": 6,
    "created_at": "2018-05-18T08:37:57Z",
    "updated_at": "2018-05-18T18:42:12Z",
    "closed_at": "2018-05-18T16:15:36Z",
    "author_association": "NONE",
    "body": "### Expected Behavior\r\n\r\nWhen Flask isn't running from the command line, it should not try to initialize Click, or should not fail to start due to locale mismatches.\r\n\r\n\r\n### Actual Behavior\r\n\r\nI am running a Flask app on Dreamhost shared hosting using their Passenger-WSGI wrapper. As their wrapper is not configured to work with Pipenv, I use the following `passenger_wsgi.py` (based on [Dreamhost's instructions](https://help.dreamhost.com/hc/en-us/articles/215769548-Passenger-and-Python-WSGI)) to shunt my interpreter over to my pipenv's Python 3.6 and then import my `app` object from `main.py`:\r\n\r\n```\r\nimport sys\r\nimport os\r\nimport subprocess\r\n\r\nINTERP = subprocess.check_output(\r\n    ['pipenv', 'run', 'which', 'python3']).strip().decode('utf-8')\r\nif sys.executable != INTERP:\r\n    os.execl(INTERP, INTERP, *sys.argv)\r\n\r\nsys.path.append(os.getcwd())\r\nfrom main import app as application\r\n```\r\n\r\nThis was working fine before Flask added the Click dependency; however, after upgrading, I got the following error at startup:\r\n\r\n```\r\nTraceback (most recent call last):\r\nFile \"/home/plaidfluff/opt/python-3.6.5/bin/pipenv\", line 11, in <module>\r\nsys.exit(cli())\r\nFile \"/home/plaidfluff/opt/python-3.6.5/lib/python3.6/site-packages/pipenv/vendor/click/core.py\", line 722, in __call__\r\nreturn self.main(*args, **kwargs)\r\nFile \"/home/plaidfluff/opt/python-3.6.5/lib/python3.6/site-packages/pipenv/vendor/cl ck/core.py\", line 676, in main\r\n_verify_python3_env()\r\nFile \"/home/plaidfluff/opt/python-3.6.5/lib/python3.6/site-packages/pipenv/vendor/click/_unicodefun.py\", line 118, in _verify_python3_env\r\n'for mitigation steps.' + extra)\r\nRuntimeError: Click will abort further execution because Python 3 was configured to use ASCII as encoding for the environment. Consult http://click.pocoo.org/python3/for mitigation steps.\r\n\r\nThis system supports the C.UTF-8 locale which is recommended.\r\nYou might be able to resolve your issue by exporting the\r\nfollowing environment variables:\r\n\r\nexport LC_ALL=C.UTF-8\r\nexport LANG=C.UTF-8\r\n\r\nTraceback (most recent call last):\r\nFile \"/home/plaidfluff/opt/python-3.6.5/bin/pipenv\", line 11, in <module>\r\nsys.exit(cli())\r\nFile \"/home/plaidfluff/opt/python-3.6.5/lib/python3.6/site-packages/pipenv/vendor/click/core.py\", line 722, in __call__\r\nreturn self.main(*args, **kwargs)\r\nFile \"/home/plaidfluff/opt/python-3.6.5/lib/python3.6/site-packages/pipenv/vendor/click/core.py\", line 676, in main\r\n_verify_python3_env()\r\nFile \"/home/plaidfluff/opt/python-3.6.5/lib/python3.6/site-packages/pipenv/vendor/click/_unicodefun.py\", line 118, in _verify_python3_env\r\n'for mitigation steps.' + extra)\r\nRuntimeError: Click will abort further execution because Python 3 was configured to use ASCII as encoding for the environment. Consult http://click.pocoo.org/python3/for mitigation steps.\r\n\r\nThis system supports the C.UTF-8 locale which is recommended.\r\nYou might be able to resolve your issue by exporting the\r\nfollowing environment variables:\r\n\r\nexport LC_ALL=C.UTF-8\r\nexport LANG=C.UTF-8\r\nTraceback (most recent call last):\r\nFile \"/dh/passenger/helper-scripts/wsgi-loader.py\", line 320, in <module>\r\napp_module = load_app()\r\nFile \"/dh/passenger/helper-scripts/wsgi-loader.py\", line 61, in load_app\r\nreturn imp.load_source('passenger_wsgi', startup_file)\r\nFile \"passenger_wsgi.py\", line 33, in <module>\r\n['pipenv', 'run', 'which', 'python3']).strip().decode('utf-8')\r\nFile \"/usr/lib/python2.7/subprocess.py\", line 573, in check_output\r\nraise CalledProcessError(retcode, cmd, output=output)\r\nsubprocess.CalledProcessError: Command '['pipenv', 'run', 'which', 'python3']' returned non-zero exit status 1\r\n```\r\n\r\nUnfortunately, I don't have any control over the `LC_ALL` or `LANG` environment variables at startup, and simply overriding them via `os.execle()` or `os.putenv()` had no effect. However, I did find that adding these two lines to the beginning of my `passenger_wsgi.py` file worked to override this check:\r\n\r\n```\r\nos.environ['LANG'] = 'C.UTF-8'\r\nos.environ['LC_ALL'] = 'C.UTF-8'\r\n```\r\n\r\nThis is inelegant, but since I am not actually using Click (at least not directly) this felt like an okay compromise, although I am concerned it may have other encoding-related side-effects on other parts of my application.\r\n\r\nIn any case, it doesn't seem like Click should even be getting imported in a context where I have a Python script that instantiates a Flask app directly rather than through its command-line processor. Any mechanism that would prevent this RuntimeError from taking down my entire website would be greatly appreciated.\r\n\r\nThanks!\r\n\r\n### Environment\r\n\r\n* Python version: 3.6.5\r\n* Flask version: 1.0.2\r\n* Werkzeug version: 0.14.1\r\n",
    "comments_inline": [
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/390252049",
            "html_url": "https://github.com/pallets/flask/issues/2791#issuecomment-390252049",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2791",
            "id": 390252049,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM5MDI1MjA0OQ==",
            "user": {
                "login": "miguelgrinberg",
                "id": 2715854,
                "node_id": "MDQ6VXNlcjI3MTU4NTQ=",
                "avatar_url": "https://avatars0.githubusercontent.com/u/2715854?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/miguelgrinberg",
                "html_url": "https://github.com/miguelgrinberg",
                "followers_url": "https://api.github.com/users/miguelgrinberg/followers",
                "following_url": "https://api.github.com/users/miguelgrinberg/following{/other_user}",
                "gists_url": "https://api.github.com/users/miguelgrinberg/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/miguelgrinberg/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/miguelgrinberg/subscriptions",
                "organizations_url": "https://api.github.com/users/miguelgrinberg/orgs",
                "repos_url": "https://api.github.com/users/miguelgrinberg/repos",
                "events_url": "https://api.github.com/users/miguelgrinberg/events{/privacy}",
                "received_events_url": "https://api.github.com/users/miguelgrinberg/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-05-18T15:55:52Z",
            "updated_at": "2018-05-18T15:55:52Z",
            "author_association": "MEMBER",
            "body": "@fluffy-critter not sure if you noticed, but the stack traces that you are getting do not indicate that Flask is involved in this at all. The error comes from pipenv not from Flask. Pipenv also has Click as a dependency."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/390257626",
            "html_url": "https://github.com/pallets/flask/issues/2791#issuecomment-390257626",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2791",
            "id": 390257626,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM5MDI1NzYyNg==",
            "user": {
                "login": "lepture",
                "id": 290496,
                "node_id": "MDQ6VXNlcjI5MDQ5Ng==",
                "avatar_url": "https://avatars2.githubusercontent.com/u/290496?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/lepture",
                "html_url": "https://github.com/lepture",
                "followers_url": "https://api.github.com/users/lepture/followers",
                "following_url": "https://api.github.com/users/lepture/following{/other_user}",
                "gists_url": "https://api.github.com/users/lepture/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/lepture/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lepture/subscriptions",
                "organizations_url": "https://api.github.com/users/lepture/orgs",
                "repos_url": "https://api.github.com/users/lepture/repos",
                "events_url": "https://api.github.com/users/lepture/events{/privacy}",
                "received_events_url": "https://api.github.com/users/lepture/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-05-18T16:15:36Z",
            "updated_at": "2018-05-18T16:15:36Z",
            "author_association": "MEMBER",
            "body": "Close it. Not a bug of Flask. Please try to start your Flask app without pipenv."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/390268379",
            "html_url": "https://github.com/pallets/flask/issues/2791#issuecomment-390268379",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2791",
            "id": 390268379,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM5MDI2ODM3OQ==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-05-18T16:55:45Z",
            "updated_at": "2018-05-18T16:55:45Z",
            "author_association": "MEMBER",
            "body": "If you can run this without pipenv, then you should report this issue to pipenv."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/390279003",
            "html_url": "https://github.com/pallets/flask/issues/2791#issuecomment-390279003",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2791",
            "id": 390279003,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM5MDI3OTAwMw==",
            "user": {
                "login": "miguelgrinberg",
                "id": 2715854,
                "node_id": "MDQ6VXNlcjI3MTU4NTQ=",
                "avatar_url": "https://avatars0.githubusercontent.com/u/2715854?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/miguelgrinberg",
                "html_url": "https://github.com/miguelgrinberg",
                "followers_url": "https://api.github.com/users/miguelgrinberg/followers",
                "following_url": "https://api.github.com/users/miguelgrinberg/following{/other_user}",
                "gists_url": "https://api.github.com/users/miguelgrinberg/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/miguelgrinberg/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/miguelgrinberg/subscriptions",
                "organizations_url": "https://api.github.com/users/miguelgrinberg/orgs",
                "repos_url": "https://api.github.com/users/miguelgrinberg/repos",
                "events_url": "https://api.github.com/users/miguelgrinberg/events{/privacy}",
                "received_events_url": "https://api.github.com/users/miguelgrinberg/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-05-18T17:35:53Z",
            "updated_at": "2018-05-18T17:35:53Z",
            "author_association": "MEMBER",
            "body": "@davidism this looks like a Click issue to me, not pipenv, in fact I've seen this on occasion when using the Flask cli as well. I'm not familiar with the technical reason behind this error, but to me it seems Click should be able to deal better with an improper unicode configuration."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/390282783",
            "html_url": "https://github.com/pallets/flask/issues/2791#issuecomment-390282783",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2791",
            "id": 390282783,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM5MDI4Mjc4Mw==",
            "user": {
                "login": "davidism",
                "id": 1242887,
                "node_id": "MDQ6VXNlcjEyNDI4ODc=",
                "avatar_url": "https://avatars1.githubusercontent.com/u/1242887?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/davidism",
                "html_url": "https://github.com/davidism",
                "followers_url": "https://api.github.com/users/davidism/followers",
                "following_url": "https://api.github.com/users/davidism/following{/other_user}",
                "gists_url": "https://api.github.com/users/davidism/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/davidism/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/davidism/subscriptions",
                "organizations_url": "https://api.github.com/users/davidism/orgs",
                "repos_url": "https://api.github.com/users/davidism/repos",
                "events_url": "https://api.github.com/users/davidism/events{/privacy}",
                "received_events_url": "https://api.github.com/users/davidism/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-05-18T17:49:31Z",
            "updated_at": "2018-05-18T17:49:50Z",
            "author_association": "MEMBER",
            "body": "You'll have to talk to @mitsuhiko about that. Click is very deliberate about requiring a correctly configured locale because otherwise guessing ensues."
        },
        {
            "url": "https://api.github.com/repos/pallets/flask/issues/comments/390297083",
            "html_url": "https://github.com/pallets/flask/issues/2791#issuecomment-390297083",
            "issue_url": "https://api.github.com/repos/pallets/flask/issues/2791",
            "id": 390297083,
            "node_id": "MDEyOklzc3VlQ29tbWVudDM5MDI5NzA4Mw==",
            "user": {
                "login": "fluffy-critter",
                "id": 347162,
                "node_id": "MDQ6VXNlcjM0NzE2Mg==",
                "avatar_url": "https://avatars0.githubusercontent.com/u/347162?v=4",
                "gravatar_id": "",
                "url": "https://api.github.com/users/fluffy-critter",
                "html_url": "https://github.com/fluffy-critter",
                "followers_url": "https://api.github.com/users/fluffy-critter/followers",
                "following_url": "https://api.github.com/users/fluffy-critter/following{/other_user}",
                "gists_url": "https://api.github.com/users/fluffy-critter/gists{/gist_id}",
                "starred_url": "https://api.github.com/users/fluffy-critter/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/fluffy-critter/subscriptions",
                "organizations_url": "https://api.github.com/users/fluffy-critter/orgs",
                "repos_url": "https://api.github.com/users/fluffy-critter/repos",
                "events_url": "https://api.github.com/users/fluffy-critter/events{/privacy}",
                "received_events_url": "https://api.github.com/users/fluffy-critter/received_events",
                "type": "User",
                "site_admin": false
            },
            "created_at": "2018-05-18T18:42:12Z",
            "updated_at": "2018-05-18T18:42:12Z",
            "author_association": "NONE",
            "body": "Okay, thanks for the clarification. Apologies for implicating the wrong project. "
        }
    ]
}